<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MC Pro Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Nunito', 'sans-serif'],
                        title: ['Fredoka', 'sans-serif']
                    },
                    colors: { brand: '#E11D48', dark: '#0f172a' }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =====================================================================
        // CONFIGURACIÓN DE FIREBASE (EDITAR AQUÍ PARA TU HOSTING EN DONWEB)
        // =====================================================================
        
        const manualConfig = {
            apiKey: "AIzaSyC5J6oXHPtVeTHKe6u4ZJuNjV5JE5XVG9I",
            authDomain: "mc-pro-sistema.firebaseapp.com",
            projectId: "mc-pro-sistema",
            storageBucket: "mc-pro-sistema.firebasestorage.app",
            messagingSenderId: "593304120965",
            appId: "1:593304120965:web:36d43fc72a9c85c76dc3ec"
        };

        const firebaseConfig = manualConfig || (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mc-pro-app';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                window.firebaseModules = { 
                    auth, db, appId, doc, setDoc, onSnapshot, collection, 
                    signInWithCustomToken, signInAnonymously, onAuthStateChanged,
                    signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
                };
                
                const initAuth = async (retries = 0) => {
                    try {
                        if (initialToken) await signInWithCustomToken(auth, initialToken);
                        else await signInAnonymously(auth); 
                    } catch (error) {
                        if (retries < 5) setTimeout(() => initAuth(retries + 1), Math.pow(2, retries) * 1000);
                    }
                };
                initAuth();
            } catch (e) { console.error("Error Firebase:", e); }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:ital,wght@0,400;0,600;0,700;0,800;0,900;1,400;1,700;1,900&display=swap');
        body { font-family: 'Nunito', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; font-size: 14px; color: #334155; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Fredoka', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dots-bg { background-color: #ffffff; background-image: radial-gradient(#E11D48 1.5px, transparent 1.5px); background-size: 25px 25px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-area { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 20px; z-index: 9999; background: white; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        function Icon({ path, className }) {
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html: path}} />
            );
        }

        const Icons = {
            Star: (p) => <Icon {...p} path='<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor" />' />,
            Mail: (p) => <Icon {...p} path='<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>' />,
            Lock: (p) => <Icon {...p} path='<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>' />,
            Key: (p) => <Icon {...p} path='<circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/>' />,
            Menu: (p) => <Icon {...p} path='<line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>' />,
            Layout: (p) => <Icon {...p} path='<rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>' />,
            Lightbulb: (p) => <Icon {...p} path='<path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/>' />,
            Wallet: (p) => <Icon {...p} path='<path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>' />,
            DollarSign: (p) => <Icon {...p} path='<line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>' />,
            FileText: (p) => <Icon {...p} path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/>' />,
            Truck: (p) => <Icon {...p} path='<path d="M10 17h4V5H2v12h3"/><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5"/><path d="M14 17h1"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/>' />,
            Calendar: (p) => <Icon {...p} path='<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>' />,
            Package: (p) => <Icon {...p} path='<path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>' />,
            ClipboardList: (p) => <Icon {...p} path='<rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/>' />,
            Calculator: (p) => <Icon {...p} path='<rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/>' />,
            ShieldCheck: (p) => <Icon {...p} path='<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/>' />,
            MessageCircle: (p) => <Icon {...p} path='<path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/>' />,
            LogOut: (p) => <Icon {...p} path='<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>' />,
            Settings: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>' />,
            Image: (p) => <Icon {...p} path='<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>' />,
            CreditCard: (p) => <Icon {...p} path='<rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/>' />,
            Trash2: (p) => <Icon {...p} path='<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>' />,
            Edit2: (p) => <Icon {...p} path='<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>' />,
            ChevronLeft: (p) => <Icon {...p} path='<path d="m15 18-6-6 6-6"/>' />,
            ChevronRight: (p) => <Icon {...p} path='<path d="m9 18 6-6-6-6"/>' />,
            Save: (p) => <Icon {...p} path='<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>' />,
            Download: (p) => <Icon {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>' />,
            X: (p) => <Icon {...p} path='<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>' />,
            CheckCircle2: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>' />,
            Globe: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>' />,
            Sun: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>' />,
            CloudSun: (p) => <Icon {...p} path='<path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/>' />,
            Palette: (p) => <Icon {...p} path='<circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>' />,
            PlusCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/>' />,
            Plus: (p) => <Icon {...p} path='<path d="M5 12h14"/><path d="M12 5v14"/>' />,
            Instagram: (p) => <Icon {...p} path='<rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/>' />,
            Zap: (p) => <Icon {...p} path='<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>' />,
            BarChart3: (p) => <Icon {...p} path='<path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>' />,
            ArrowUpCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/>' />,
            ArrowDownCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="m16 12-4 4-4-4"/><path d="M12 8v8"/>' />,
            Box: (p) => <Icon {...p} path='<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/>' />,
            UserCheck: (p) => <Icon {...p} path='<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/>' />,
            Languages: (p) => <Icon {...p} path='<path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/>' />,
            Pinterest: (p) => <Icon {...p} path='<path d="M8 22c.164-1.21.31-3.045.064-4.358-.222-1.182-1.442-5.932-1.442-5.932s-.368-.737-.368-1.826c0-1.712.993-2.99 2.228-2.99 1.05 0 1.557.788 1.557 1.733 0 1.057-.674 2.637-1.021 4.102-.29 1.226.614 2.226 1.82 2.226 2.185 0 3.865-2.304 3.865-5.63 0-2.943-2.115-4.996-5.13-4.996-3.493 0-5.544 2.62-5.544 5.328 0 1.054.405 2.185.912 2.798.1.122.114.228.084.351-.092.383-.3.1.413.38-.413.033-.131.066-.312.066s-.321-.082-.416-.289c-.1-.219-.4-.73-.55-.992-.482-.843-.728-1.637-.728-3.089 0-4.475 3.245-8.583 9.375-8.583 4.922 0 8.746 3.508 8.746 8.201 0 4.889-3.083 8.825-7.362 8.825-1.438 0-2.789-.747-3.252-1.632l-.884 3.364c-.32 1.22-1.185 2.748-1.765 3.687a10 10 0 1 0 11.162-4.981" fill="currentColor"/>' />,
            Newspaper: (p) => <Icon {...p} path='<path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8z"/>' />,
            Printer: (p) => <Icon {...p} path='<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect width="12" height="8" x="6" y="14"></rect>' />,
            User: (p) => <Icon {...p} path='<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>' />,
            Minus: (p) => <Icon {...p} path='<line x1="5" y1="12" x2="19" y2="12"/>' />,
            Megaphone: (p) => <Icon {...p} path='<path d="m3 11 18-5v12L3 14v-3z"></path><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path>' />,
            PlayCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/>' />,
            ShoppingBag: (p) => <Icon {...p} path='<path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/>' />,
            Bell: (p) => <Icon {...p} path='<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>' />
        };

        const translations = {
            es: {
                login_subtitle: "Acceso a Miembros", login_user: "Usuario / Correo", login_license: "Licencia", login_btn: "Ingresar",
                nav_dashboard: "Escritorio", nav_strategies: "Estrategias", nav_finances: "Finanzas", nav_clients: "Ventas", nav_budgets: "Presupuestos", nav_billing: "Facturación", nav_shipping: "Envíos", nav_planner: "Calendario", nav_inventory: "Insumos", nav_workshop: "Taller", nav_calculator: "Cotizador", nav_users: "Usuarios", nav_profile: "Mis Datos",
                btn_support: "Soporte", btn_logout: "Salir", fin_download: "Descargar CSV", fin_income_title: "Ingreso", fin_expense_title: "Gasto", fin_income: "Ingresos", fin_expenses: "Gastos",
                dash_trend: "Tendencia", dash_campaign: "Campaña", dash_balance: "Balance", dash_income: "Ingresos", dash_expenses: "Gastos",
                strat_ideas: "Ideas", strat_trend: "Tendencia Visual", label_concept: "Concepto", label_amount: "Monto", btn_add: "Agregar",
                inv_title: "Insumos", label_item: "Item", label_stock: "Stock", label_cost: "Costo",
                chk_title: "Nuevo Proyecto", label_job: "Trabajo", label_details: "Detalles...", btn_create: "Crear Ficha",
                cli_title: "Ventas", table_client: "Cliente", table_amount: "Monto", table_actions: "x",
                ship_title: "Envíos", label_tracking: "Tracking", btn_dispatch: "Despachar",
                plan_note: "Cita Personal", placeholder_write: "Escribir cita...",
                calc_title: "Cotizador Pro", calc_final: "Precio Final Sugerido",
                acc_title: "Usuarios Autorizados", acc_new: "Nuevo Usuario",
                bud_new: "Nuevo Presupuesto", bill_new: "Nueva Factura", bud_title_new: "Nuevo Presupuesto", bill_title_new: "Nueva Factura", btn_cancel: "Cancelar", btn_save: "Guardar", label_status: "Estado", bud_item: "Agregar Ítem", bud_total: "Total Estimado",
                mod_title: "Soporte MC Pro", btn_close: "Cerrar",
                days: ['L','M','M','J','V','S','D'],
                settings_lang: "Idioma / Language",
                bud_number: "N° Boleta", bill_number: "N° Factura",
                bud_logo: "Subir Logo", bill_logo: "Subir Logo"
            }
        };
        
        // Hacer la variable t global para que todos los componentes la vean
        const t = translations.es;

        const FULL_EVENTS = [
            // ENERO (m: 0)
            {d:1,m:0,t:'Año Nuevo (Feriado)',type:'UY'},
            {d:4,m:0,t:'Día del Braille',type:'INT'},
            {d:6,m:0,t:'Día de los Niños / Reyes',type:'UY'},
            {d:13,m:0,t:'Día Mundial contra la Depresión',type:'CM'},
            {d:16,m:0,t:'Día de The Beatles',type:'INT'},
            {d:19,m:0,t:'Blue Monday (Día más triste)',type:'CM'},
            {d:21,m:0,t:'Día Internacional del Abrazo',type:'CM'},
            {d:24,m:0,t:'Día Internacional de la Educación',type:'INT'},
            {d:26,m:0,t:'Día del Community Manager',type:'CM'},
            {d:28,m:0,t:'Día de la Privacidad de Datos',type:'CM'},

            // FEBRERO (m: 1)
            {d:2,m:1,t:'Iemanjá (UY)',type:'UY'},
            {d:4,m:1,t:'Día Mundial contra el Cáncer',type:'INT'},
            {d:9,m:1,t:'Día Mundial de la Pizza',type:'CM'},
            {d:11,m:1,t:'Día Mujer y Niña en la Ciencia',type:'INT'},
            {d:13,m:1,t:'Día Mundial de la Radio / Soltero',type:'INT'},
            {d:14,m:1,t:'San Valentín',type:'INT'},
            {d:16,m:1,t:'Carnaval (Lunes)',type:'UY'},
            {d:17,m:1,t:'Carnaval (Martes)',type:'UY'},
            {d:20,m:1,t:'Día Internacional del Gato',type:'CM'},
            {d:27,m:1,t:'Día Mundial de las ONG',type:'INT'},
            {d:28,m:1,t:'Grito de Asencio (UY)',type:'UY'},

            // MARZO (m: 2)
            {d:3,m:2,t:'Día Mundial de la Naturaleza',type:'INT'},
            {d:8,m:2,t:'Día Internacional de la Mujer',type:'INT'},
            {d:15,m:2,t:'Día de los Derechos del Consumidor',type:'CM'},
            {d:17,m:2,t:'San Patricio',type:'INT'},
            {d:19,m:2,t:'Nacimiento José P. Varela (UY)',type:'UY'},
            {d:20,m:2,t:'Día Internacional de la Felicidad',type:'INT'},
            {d:21,m:2,t:'Día de la Poesía / Síndrome de Down',type:'INT'},
            {d:22,m:2,t:'Día Mundial del Agua',type:'INT'},
            {d:27,m:2,t:'Día Mundial del Teatro',type:'INT'},

            // ABRIL (m: 3)
            {d:2,m:3,t:'Jueves Santo / Semana Turismo / Día Autismo',type:'UY'},
            {d:3,m:3,t:'Viernes Santo / Semana Turismo',type:'UY'},
            {d:7,m:3,t:'Día Mundial de la Salud',type:'INT'},
            {d:13,m:3,t:'Día Internacional del Beso',type:'CM'},
            {d:15,m:3,t:'Día Mundial del Arte',type:'INT'},
            {d:16,m:3,t:'Día Mundial del Emprendimiento',type:'CM'},
            {d:19,m:3,t:'Desembarco 33 Orientales / Día Simpson',type:'UY'},
            {d:22,m:3,t:'Día de la Tierra',type:'INT'},
            {d:23,m:3,t:'Día Mundial del Libro / Idioma',type:'INT'},
            {d:27,m:3,t:'Día Mundial del Diseño Gráfico',type:'CM'},
            {d:29,m:3,t:'Día Internacional de la Danza',type:'INT'},

            // MAYO (m: 4)
            {d:1,m:4,t:'Día de los Trabajadores (Feriado)',type:'UY'},
            {d:2,m:4,t:'Día contra el Bullying',type:'INT'},
            {d:4,m:4,t:'Star Wars Day',type:'CM'},
            {d:10,m:4,t:'Día de la Madre (Comercial UY)',type:'UY'},
            {d:15,m:4,t:'Día Internacional de la Familia',type:'INT'},
            {d:17,m:4,t:'Día de Internet / Reciclaje',type:'CM'},
            {d:18,m:4,t:'Batalla de las Piedras',type:'UY'},
            {d:25,m:4,t:'Día del Orgullo Friki / Geek',type:'CM'},
            {d:28,m:4,t:'Día de la Hamburguesa',type:'CM'},

            // JUNIO (m: 5)
            {d:5,m:5,t:'Día Mundial del Medio Ambiente',type:'INT'},
            {d:8,m:5,t:'Día Mundial de los Océanos',type:'INT'},
            {d:19,m:5,t:'Natalicio de Artigas / Día del Abuelo',type:'UY'},
            {d:20,m:5,t:'Yellow Day (Día más feliz)',type:'CM'},
            {d:21,m:5,t:'Día Internacional del Yoga / Selfie',type:'CM'},
            {d:28,m:5,t:'Día del Orgullo LGTBIQ+',type:'INT'},
            {d:30,m:5,t:'Social Media Day',type:'CM'},

            // JULIO (m: 6)
            {d:7,m:6,t:'Día Mundial del Cacao',type:'CM'},
            {d:12,m:6,t:'Día del Padre (Comercial UY)',type:'UY'},
            {d:13,m:6,t:'Día Mundial del Rock',type:'INT'},
            {d:17,m:6,t:'World Emoji Day',type:'CM'},
            {d:18,m:6,t:'Jura de la Constitución (Feriado)',type:'UY'},
            {d:20,m:6,t:'Día del Amigo',type:'INT'},
            {d:21,m:6,t:'Día Mundial del Perro',type:'CM'},
            {d:26,m:6,t:'Día de los Abuelos (Internacional)',type:'INT'},
            {d:30,m:6,t:'Día Internacional de la Amistad',type:'INT'},

            // AGOSTO (m: 7)
            {d:1,m:7,t:'Día de la Alegría',type:'INT'},
            {d:8,m:7,t:'Día Internacional del Gato',type:'CM'},
            {d:12,m:7,t:'Día Internacional de la Juventud',type:'INT'},
            {d:16,m:7,t:'Día del Niño (Comercial UY)',type:'UY'},
            {d:19,m:7,t:'Día Mundial de la Fotografía',type:'CM'},
            {d:24,m:7,t:'Noche de la Nostalgia',type:'UY'},
            {d:25,m:7,t:'Declaratoria Independencia (Feriado)',type:'UY'},
            {d:29,m:7,t:'Día del Gamer',type:'CM'},
            {d:31,m:7,t:'Día Internacional del Blog',type:'CM'},

            // SEPTIEMBRE (m: 8)
            {d:13,m:8,t:'Día del Programador / Día del Chocolate',type:'CM'},
            {d:21,m:8,t:'Día de la Primavera / Estudiante',type:'UY'},
            {d:27,m:8,t:'Día del Turismo / Cumpleaños de Google',type:'CM'},
            {d:29,m:8,t:'Día Mundial del Corazón',type:'INT'},
            {d:30,m:8,t:'Día Internacional del Podcast',type:'CM'},

            // OCTUBRE (m: 9)
            {d:1,m:9,t:'Día del Café / Música / Vegetarianismo',type:'CM'},
            {d:4,m:9,t:'Día Mundial de los Animales',type:'INT'},
            {d:10,m:9,t:'Día de la Salud Mental',type:'INT'},
            {d:12,m:9,t:'Batalla de Sarandí',type:'UY'},
            {d:16,m:9,t:'Día Mundial de la Alimentación',type:'INT'},
            {d:19,m:9,t:'Día contra el Cáncer de Mama',type:'INT'},
            {d:24,m:9,t:'Día contra el Cambio Climático',type:'INT'},
            {d:31,m:9,t:'Halloween / Día del Ahorro',type:'INT'},

            // NOVIEMBRE (m: 10)
            {d:1,m:10,t:'Día Mundial del Veganismo',type:'CM'},
            {d:2,m:10,t:'Día de los Difuntos',type:'UY'},
            {d:11,m:10,t:'Día del Soltero (11/11)',type:'CM'},
            {d:19,m:10,t:'Día de la Mujer Emprendedora',type:'CM'},
            {d:20,m:10,t:'Día Universal del Niño',type:'INT'},
            {d:21,m:10,t:'Día Mundial de la Televisión',type:'INT'},
            {d:27,m:10,t:'Black Friday 2026',type:'CM'},
            {d:30,m:10,t:'Cyber Monday / Día del Influencer',type:'CM'},

            // DICIEMBRE (m: 11)
            {d:1,m:11,t:'Día Mundial de Lucha contra el SIDA',type:'INT'},
            {d:3,m:11,t:'Día Personas con Discapacidad',type:'INT'},
            {d:10,m:11,t:'Día de los Derechos Humanos',type:'INT'},
            {d:15,m:11,t:'Día Mundial del Otaku',type:'CM'},
            {d:24,m:11,t:'Nochebuena',type:'INT'},
            {d:25,m:11,t:'Navidad / Día de la Familia (Feriado)',type:'UY'},
            {d:28,m:11,t:'Día de los Inocentes',type:'INT'},
            {d:31,m:11,t:'Fin de Año',type:'INT'}
        ];

        // ESTRATEGIAS MEJORADAS Y AMPLIADAS
        const creativeStrategies = [
            { 
                m: 0, 
                title: 'Planificación & Vuelta a Clases', 
                productIdeas: ['Kits escolares personalizados (etiquetas, reglas, libretas)', 'Agendas y Planners anuales 2026', 'Cuadernos corporativos para inicio de año', 'Stickers resistentes al agua para botellas'], 
                contentIdeas: ['Reel: "Empaca un mega pedido escolar conmigo" (ASMR)', 'Carrusel IG: Tips para organizar tu escritorio este año', 'TikTok: Mostrando el proceso de plastificado de etiquetas', 'Story: Encuestas de paletas de colores favoritas para agendas'],
                promoIdeas: ['Preventa escolar exclusiva con 15% OFF (hasta el 15/Ene)', 'Envío gratis en compras de "Combos Escolares completos"', 'Regalo sorpresa (ej. un marcapáginas) con cada agenda'],
                trend: 'Colores primarios fuertes, tipografías bold estilo college, pop art y minimalismo funcional.', 
                managerTip: 'La anticipación es clave. Los padres previsores compran en enero. Lanza tu campaña fuerte a mediados de mes.', 
                keywords: "#VueltaAlCole2026 #Organizacion #PapeleriaCreativa",
                platforms: ['Instagram', 'TikTok', 'Pinterest']
            },
            { 
                m: 1, 
                title: 'Amor, Amistad & Carnaval', 
                productIdeas: ['Cajas sorpresa (Explosion Box) con fotos', 'Tarjetas pop-up interactivas / Shaker Cards', 'Cuponeras del amor/amistad troqueladas', 'Packaging especial romántico para emprendedores'], 
                contentIdeas: ['Reel: Storytime de historias de amor de tus clientes (con permiso)', 'Tutorial TikTok: Cómo hacer una tarjeta fácil en casa (atrae tráfico)', 'Carrusel: 3 ideas de regalos que no son chocolates', 'Live: Armado en vivo de kits de San Valentín'],
                promoIdeas: ['Promoción "Doble Amor": 2x1 en tarjetas personalizadas', 'Descuento especial por el Día del Soltero (13 Feb)', 'Sorteo "Etiqueta a tu media naranja" para ganar un kit'],
                trend: 'Rojos intensos, rosa pastel, foil dorado, técnica de layering (capas de papel) y estética coquette.', 
                managerTip: 'No te centres solo en parejas; el amor propio y la amistad (Galentine\'s Day) venden muchísimo en papelería.', 
                keywords: "#SanValentin #RegalosPersonalizados #AmorYAmistad",
                platforms: ['Instagram', 'TikTok']
            },
            { 
                m: 2, 
                title: 'Poder Femenino & Cambio de Temporada', 
                productIdeas: ['Agendas y bitácoras para mujeres emprendedoras', 'Libretas pocket con frases de empoderamiento', 'Marcapáginas magnéticos florales', 'Kits de regalo corporativo para el Día de la Mujer'], 
                contentIdeas: ['Reel: Detrás de escena siendo mujer emprendedora', 'Carrusel IG: Frases motivacionales que inspiran nuestra papelería', 'Colaboración: Entrevista corta a otra creadora uruguaya', 'Story: Moodboard inspiracional de Otoño'],
                promoIdeas: ['Cajas corporativas con descuento por volumen para empresas', 'Regalo de lámina con frase empoderadora con cada compra el 8M', 'Sorteo cruzado con otra marca liderada por mujeres'],
                trend: 'Acuarelas, motivos florales otoñales, tonos lila, morado y ocre. Tipografías script elegantes.', 
                managerTip: 'Ofrece soluciones para empresas locales que buscan regalos rápidos y bonitos para el 8 de marzo.', 
                keywords: "#DiaDeLaMujer #MujerEmprendedora #PapeleriaOtoño",
                platforms: ['Instagram', 'LinkedIn', 'Pinterest']
            },
            { 
                m: 3, 
                title: 'Magia de Pascuas & Otoño', 
                productIdeas: ['Cajas con visor transparente para huevos de Pascua', 'Toppers y tags temáticos para roscas (para pastelerías)', 'Bolsitas kraft con forma de conejo', 'Kits imprimibles para "Búsqueda del tesoro" infantil'], 
                contentIdeas: ['TikTok: Ideas de cómo rellenar las cajitas de Pascua (No solo chocolate)', 'Reel: Armado rápido de packaging para pastelerías (B2B)', 'Carrusel: Plantillas de regalo (Freebies) para los niños', 'Story: Cuenta regresiva para Semana Santa/Turismo'],
                promoIdeas: ['Descuento por preventa temprana de packaging para pasteleros', 'Kit "Búsqueda del Tesoro" a mitad de precio llevando la caja', 'Cupón de descuento escondido en un "huevo de pascua" digital en Stories'],
                trend: 'Tonos pastel (celeste, verde agua, amarillo), texturas rústicas (kraft, hilo sisal) y minimalismo tierno.', 
                managerTip: 'Enfoca tu estrategia B2B (venta a otras empresas) a principios de mes para captar reposteros y pastelerías.', 
                keywords: "#PascuaCreativa #PackagingPascuas #SemanaTurismo",
                platforms: ['Instagram', 'Pinterest']
            },
            { 
                m: 4, 
                title: 'Día de la Madre & Momentos', 
                productIdeas: ['Álbumes de fotos estilo Scrapbook', 'Bandejas de desayuno decoradas con papelería', 'Tarjetas pop-up 3D premium', 'Cuadros de profundidad con flores de papel'], 
                contentIdeas: ['Reel Emotivo: Preparando regalos para mamás (Música nostálgica)', 'Carrusel IG: Guía de regalos según el tipo de mamá', 'TikTok: Cómo personalizar tu álbum de fotos', 'Story: Preguntas sobre los mejores recuerdos de la infancia'],
                promoIdeas: ['Envío exprés gratis la semana previa al Día de la Madre', 'Descuento especial "Regala a la abuela también"', 'Kits listos para regalar (Papelería + Chocolate en alianza con otra marca)'],
                trend: 'Estampados florales vintage, tonos cálidos, rosa viejo, dorado y tipografías script tipo caligrafía.', 
                managerTip: 'El formato "Guía de Regalos" en Pinterest e Instagram Carousels atrae mucho tráfico orgánico de gente indecisa.', 
                keywords: "#DiaDeLaMadreUY #RegalosMama #Scrapbooking",
                platforms: ['Instagram', 'Facebook', 'Pinterest']
            },
            { 
                m: 5, 
                title: 'Día del Padre & Sobriedad', 
                productIdeas: ['Cajas para vinos/cervezas grabadas o personalizadas', 'Tarjetas con diseño de camisa/herramientas', 'Organizadores de escritorio minimalistas', 'Etiquetas personalizadas para regalos caseros'], 
                contentIdeas: ['Carrusel IG: "Regalos para el papá que dice que no quiere nada"', 'Reel: Mostrando texturas premium y sobrias', 'TikTok: Armado de un kit cervecero/vinitero', 'Story: Dinámica "Qué frase típica de padre pondrías en una taza/tarjeta"'],
                promoIdeas: ['Promo "Padre e Hijo": Descuento al llevar 2 organizadores', 'Envío gratis en combos Premium', 'Tarjetas de cortesía en todas las compras de la semana'],
                trend: 'Texturas de madera, cuero, papel kraft grueso. Paleta de azules marinos, grises, negro y verde bosque.', 
                managerTip: 'Los regalos del Día del Padre suelen dejarse para último momento. Prepara "Kits Salvavidas" listos para entregar.', 
                keywords: "#DiaDelPadre #RegalosPapa #PapeleriaSobria",
                platforms: ['Instagram', 'Facebook']
            },
            { 
                m: 6, 
                title: 'Vacaciones de Invierno & Diversión', 
                productIdeas: ['Libros de actividades y colorear para niños', 'Kits de manualidades DIY (Hazlo tú mismo)', 'Stickers resistentes al agua para decorar termos', 'Bitácoras de viaje / Diarios de invierno'], 
                contentIdeas: ['Reel/TikTok: "Qué incluye nuestro kit para vencer el aburrimiento"', 'Carrusel: 3 ideas de manualidades para hacer con niños en casa', 'Story: Freebie (Descargable gratis) para colorear', 'Live: Tarde de manualidades usando los kits'],
                promoIdeas: ['Descuento "Vacaciones" en la sección infantil', 'Regalo de plancha de stickers en compras de bitácoras', 'Concurso de dibujo en Stories para ganar un kit completo'],
                trend: 'Personajes divertidos, colores neón vibrantes contrastando con el invierno, ilustraciones doodle.', 
                managerTip: 'Ofrece un "Freebie" (imprimible gratis) a cambio de que se suscriban a tu newsletter o te mencionen en Stories.', 
                keywords: "#InviernoDivertido #ActividadesNiños #KitsDIY",
                platforms: ['TikTok', 'Instagram', 'Pinterest']
            },
            { 
                m: 7, 
                title: 'Día del Niño & Nostalgia', 
                productIdeas: ['Cajitas sorpresita temáticas "Party Box"', 'Rompecabezas personalizados con fotos', 'Valijitas de cartón para tesoros', 'Papelería temática "Noche de la Nostalgia" (Retro)'], 
                contentIdeas: ['Reel: Montando una Party Box espectacular', 'TikTok: Efecto nostalgia (Ayer vs Hoy en la papelería)', 'Carrusel IG: Por qué regalar experiencias (rompecabezas) es mejor', 'Story: Cuestionario retro musical por la Noche de la Nostalgia'],
                promoIdeas: ['Combo "Hermanos": Descuento en la segunda unidad infantil', 'Kits decorativos listos para fiestas de la Nostalgia a precio especial', 'Sorteo Día del Niño con influencers locales'],
                trend: 'Para niños: Súper héroes, magia y full color. Para Nostalgia: Estética de los 80s/90s, neón, casetes y vinilos.', 
                managerTip: 'Aprovecha la Noche de la Nostalgia en Uruguay. Los salones y fiestas privadas necesitan tickets, pulseras y decoración retro.', 
                keywords: "#DiaDelNiño #NocheDeLaNostalgia #PartyBox",
                platforms: ['Instagram', 'Facebook']
            },
            { 
                m: 8, 
                title: 'Primavera, Color & Eventos', 
                productIdeas: ['Banderines y guirnaldas florales', 'Flores gigantes de papel para vidrieras o eventos', 'Tags plantables (con semillas) o para suculentas', 'Sets de papelería para picnics de primavera'], 
                contentIdeas: ['Reel: Transición (Papelería de invierno a full color primavera)', 'Carrusel: Cómo decorar una mesa de primavera', 'TikTok: Tutorial para hacer flores de papel', 'Story: Unboxing de nuevos papeles y texturas de temporada'],
                promoIdeas: ['Lanzamiento de temporada con "Early Bird" discount', 'Regalo de Tag Plantable con cada pedido', 'Promoción 3x2 en decoración colgante'],
                trend: 'Mariposas, flores vibrantes, hojas botánicas, estilo boho-chic, tonos pastel saturados y verde menta.', 
                managerTip: 'La primavera activa la temporada de eventos al aire libre. Enfócate en papelería social (cumpleaños, baby showers).', 
                keywords: "#BienvenidaPrimavera #EventosPrimavera #PapeleriaSocial",
                platforms: ['Instagram', 'Pinterest', 'TikTok']
            },
            { 
                m: 9, 
                title: 'Halloween & Bodas de Primavera', 
                productIdeas: ['Cajas ataúd o formas divertidas para golosinas', 'Invitaciones interactivas (deslizables) para bodas/15s', 'Toppers terroríficos para cupcakes', 'Máscaras y props imprimibles para fotocabinas'], 
                contentIdeas: ['TikTok: ASMR armando cajitas de Halloween', 'Reel: Tendencias en invitaciones de Boda 2026', 'Carrusel IG: Qué debe incluir una invitación perfecta', 'Story: Votación "Truco o Trato" con descuentos ocultos'],
                promoIdeas: ['Packaging temático "Monstruoso" para negocios locales (B2B)', 'Envío de muestras gratuitas de invitaciones a Wedding Planners', 'Flash Sale de 24hs por Halloween'],
                trend: 'Halloween: Naranja, violeta, negro y diseños "spooky-cute". Bodas: Minimalismo, papel vegetal, eucalipto y blanco.', 
                managerTip: 'Es un mes dual. Muestra tu lado divertido para Halloween, pero no descuides el lado elegante; octubre y noviembre son alta temporada de bodas.', 
                keywords: "#HalloweenCreativo #Bodas2026 #Invitaciones",
                platforms: ['Instagram', 'Pinterest']
            },
            { 
                m: 10, 
                title: 'Black Friday & Prep. Cierre de Año', 
                productIdeas: ['Papelería corporativa para fin de año (Calendarios de escritorio)', 'Números de mesa y menús para eventos de noviembre', 'Lanzamiento: Agendas y Planners 2027', 'Etiquetas de agradecimiento para otros emprendedores'], 
                contentIdeas: ['Reel: Alerta Black Friday (Mostrando stock rebajado)', 'TikTok: Cómo preparo mi negocio para el pico de ventas', 'Carrusel IG: Guía de regalos empresariales', 'Story: Sneak Peek (vistazo) de la nueva colección de Agendas'],
                promoIdeas: ['Campaña Black Friday: Descuentos escalonados (20%, 30%, 50% en Outlet)', 'Preventa exclusiva VIP de Agendas 2027', 'Kits "Agradece a tus clientes" en promoción para emprendedores'],
                trend: 'Tonos metalizados, contraste oscuro/elegante para ofertas, y comienzo de introducción a estéticas festivas sutiles.', 
                managerTip: 'En Black Friday no compitas solo por precio, compite por valor percibido. Añade cosas extra (stickers, packaging hermoso) en lugar de regalar tu trabajo.', 
                keywords: "#BlackFridayUY #Agendas2027 #PapeleriaCorporativa",
                platforms: ['Instagram', 'Facebook', 'LinkedIn']
            },
            { 
                m: 11, 
                title: 'Navidad Creativa & Gratitud', 
                productIdeas: ['Esferas personalizadas con foto/vinilo para el arbolito', 'Calendarios de adviento de cartulina', 'Tags con foil y cintas para regalos navideños', 'Tarjetas de "Felices Fiestas" empresariales'], 
                contentIdeas: ['Reel Emotivo: "Gracias por acompañarnos este año" (Humanizando marca)', 'TikTok: Empacando un pedido versión Navidad', 'Carrusel IG: Ideas de último minuto para decorar tu mesa navideña', 'Story: Detrás de escena del caos hermoso de diciembre'],
                promoIdeas: ['Combos de Etiquetas y Tags listos para usar a precios accesibles', 'Envíos con packaging navideño especial sin costo extra', 'Sorteo "Cesta de Navidad" con tus mejores productos'],
                trend: 'Verde pino, rojo clásico, tartán (cuadros), mucho glitter, brillo foil dorado/plateado y texturas nevadas.', 
                managerTip: 'Diciembre es agotador. Limita los productos personalizados a los primeros 15 días y luego vende solo "Stock Listo para Entregar".', 
                keywords: "#NavidadCreativa #RegalosNavidad #FinDeAño",
                platforms: ['Instagram', 'TikTok']
            }
        ];

        const stationeryNews = [
            { title: "Tendencia Foil 2026", desc: "Acabados metálicos dominan.", link: "#" },
            { title: "Papel Sustentable", desc: "Texturas orgánicas.", link: "#" },
            { title: "Plotters de Corte", desc: "Actualización de software.", link: "#" }
        ];

        function usePersistedState(key, defaultValue, uid) {
            const localKey = `${uid}_${key}`;
            const [state, setState] = useState(() => {
                try { const s = localStorage.getItem(localKey); return s ? JSON.parse(s) : defaultValue; } 
                catch (e) { return defaultValue; }
            });
            const [loaded, setLoaded] = useState(false);

            useEffect(() => {
                if(!uid) return;
                try { const s = localStorage.getItem(localKey); if(s) setState(JSON.parse(s)); else setState(defaultValue); } 
                catch { setState(defaultValue); }
            }, [uid, localKey]);

            useEffect(() => {
                if (!window.firebaseModules || !uid || uid === 'offline') { setLoaded(true); return; }
                const { db, appId, onSnapshot, doc } = window.firebaseModules;
                
                const ref = doc(db, 'artifacts', appId, 'users', uid, 'app_storage', key);
                const unsub = onSnapshot(ref, (s) => { 
                    if(s.exists() && s.data().content !== undefined) { 
                        setState(s.data().content); 
                        localStorage.setItem(localKey, JSON.stringify(s.data().content)); 
                    } 
                    setLoaded(true); 
                }, (err) => console.log('Err snap'));
                
                return () => unsub();
            }, [uid, key, localKey]);

            useEffect(() => {
                if(!loaded || !uid) return;
                localStorage.setItem(localKey, JSON.stringify(state));
                if(!window.firebaseModules || uid === 'offline') return;
                const { db, appId, doc, setDoc } = window.firebaseModules;
                
                const t = setTimeout(() => {
                    setDoc(doc(db, 'artifacts', appId, 'users', uid, 'app_storage', key), { content: state }, { merge: true }).catch(e => console.log('Err save'));
                }, 1500);
                return () => clearTimeout(t);
            }, [state, loaded, uid, localKey, key]);

            return [state, setState];
        }

        function usePublicSharedState(key, defaultValue) {
            const [state, setState] = useState(defaultValue);
            useEffect(() => {
                if(!window.firebaseModules) return;
                const { auth, db, appId, onSnapshot, doc } = window.firebaseModules;
                let unsub = null;
                const unsubAuth = auth.onAuthStateChanged((user) => {
                    if(unsub) { unsub(); unsub=null; }
                    if(user) {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'global', key);
                        unsub = onSnapshot(ref, (s) => { if(s.exists() && s.data().content !== undefined) setState(s.data().content); }, (err) => console.log('Permisos'));
                    }
                });
                return () => { unsubAuth(); if(unsub) unsub(); };
            }, [key]);
            
            const update = (val) => {
                setState(val);
                if(!window.firebaseModules) return;
                const { auth, db, appId, doc, setDoc } = window.firebaseModules;
                if(auth.currentUser) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global', key), { content: val }, { merge: true }).catch(e=>console.log('Err pub'));
            };
            return [state, update];
        }

        function NavItemComp({ id, label, icon: IconComponent, activeTab, setActiveTab, setIsSidebarOpen }) {
            return (
                <button 
                    onClick={() => { setActiveTab(id); setIsSidebarOpen(false); }} 
                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-2xl transition-all font-bold text-xs uppercase tracking-tight ${activeTab === id ? 'bg-brand text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}`}
                >
                    {IconComponent && <IconComponent className="w-4 h-4" />} {label}
                </button>
            );
        }

        function Dashboard({ user, onLogout }) {
            const uid = user ? user.uid : 'offline';
            const userEmail = user && user.email ? user.email : 'Usuario Local';
            const userKey = userEmail.replace(/[^a-zA-Z0-9]/g, '_'); 
            
            // AGREGADO: Nuevo estado global para Contactos
            const [contacts, setContacts] = usePersistedState(`mc_contacts_list`, [], uid);
            
            const [inventory, setInventory] = usePersistedState(`mc_inventory`, [], uid);
            const [tasks, setTasks] = usePersistedState(`mc_tasks`, [], uid);
            const [clients, setClients] = usePersistedState(`mc_clients`, [], uid); 
            const [shipping, setShipping] = usePersistedState(`mc_shipping`, [], uid);
            const [expenses, setExpenses] = usePersistedState(`mc_expenses`, [], uid); 
            const [extraIncomes, setExtraIncomes] = usePersistedState(`mc_extra_incomes`, [], uid); 
            const [personalEvents, setPersonalEvents] = usePersistedState(`mc_personal_events`, {}, uid);
            const [presupuestos, setPresupuestos] = usePersistedState(`mc_presupuestos`, [], uid);
            const [facturas, setFacturas] = usePersistedState(`mc_facturas`, [], uid);
            const [materialDb, setMaterialDb] = usePersistedState(`mc_material_db`, [], uid);
            const [userProfile, setUserProfile] = usePersistedState(`mc_user_profile`, { brand: '', phone: '', address: '', owner: '', logo: '' }, uid);
            const [usageLog, setUsageLog] = usePersistedState(`mc_material_usage_log`, [], uid);
            const [calc, setCalc] = usePersistedState(`mc_calc_pro`, { selectedMaterialId: '', materialQty: 1, inkPercent: 10, assemblyCost: 0, packagingCost: 0, designHours: 0, cuttingHours: 0, assemblyHours: 0, finishingCost: 0, hourlyRate: 0, opExpenses: 0, maintenanceFund: 0, subscriptions: 0, wastePercent: 10, profitMargin: 50, taxesPercent: 0 }, uid);

            // Estado global para administradores y TIENDA
            const [adminList, setAdminList] = usePublicSharedState('access_list', ['modocreativo2026@gmail.com']);
            const [digitalProducts, setDigitalProducts] = usePublicSharedState('mc_digital_products', []);

            const [activeTab, setActiveTab] = useState('dashboard');
            const [showContactModal, setShowContactModal] = useState(false);
            const [showReminder, setShowReminder] = useState(false);
            const [notification, setNotification] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [userCountry, setUserCountry] = usePersistedState(`mc_country`, 'UY', uid);
            const [invInput, setInvInput] = useState({ name: '', totalCost: '', totalQty: '', portion: 1 });
            const [statsView, setStatsView] = useState('month');
            const [salesView, setSalesView] = useState('month');
            const [isCreatingBudget, setIsCreatingBudget] = useState(false);
            const [isCreatingInvoice, setIsCreatingInvoice] = useState(false);
            const [currentBudget, setCurrentBudget] = useState({ id: null, number: '', logo: '', client: '', date: new Date().toISOString().split('T')[0], items: [{ id: Date.now(), desc: '', qty: 1, price: 0 }], status: 'Pendiente', notes: '' });
            const [currentInvoice, setCurrentInvoice] = useState({ id: null, number: '', logo: '', client: '', date: new Date().toISOString().split('T')[0], items: [{ id: Date.now(), desc: '', qty: 1, price: 0 }], status: 'Pagada', notes: '' });
            const [viewDate, setViewDate] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(new Date().getDate());
            const [strategyMonth, setStrategyMonth] = useState(new Date().getMonth());
            const [selectedLabel, setSelectedLabel] = useState(null);

            const ADMIN_EMAIL = 'modocreativo2026@gmail.com';
            const isAdmin = userEmail === ADMIN_EMAIL || adminList.includes(userEmail);

            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 2500); };
            const deleteItem = (id, setter, name) => { setter(p => p.filter(i => i.id !== id)); notify(`${name} eliminado`); };
            
            const saveEntity = (e, setter, name) => {
              e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries());
              if(d.amount) d.amount = Number(d.amount); if(d.qty) d.qty = Number(d.qty); if(d.price) d.price = Number(d.price);
              const item = { id: Date.now(), ...d, date: new Date().toISOString().split('T')[0], completed: false };
              setter(p => [...p, item]); e.target.reset(); notify(`${name} guardado`);
            };

            const getDayKey = (d) => `${viewDate.getFullYear()}-${String(viewDate.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const totalIncomes = (clients?.filter(c => c.status === 'Completado' || !c.status).reduce((a,c) => a+(c.amount||0),0) || 0) + (extraIncomes?.reduce((a,i) => a+(i.amount||0),0) || 0);
            const totalExpenses = expenses?.reduce((a,e) => a+(e.amount||0),0) || 0;
            const netBalance = totalIncomes - totalExpenses;

            // Efecto para la alarma/recordatorio diario
            useEffect(() => {
                const checkReminders = () => {
                    if (!uid || uid === 'offline') return;
                    const now = new Date();
                    const todayK = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                    const todayStatic = FULL_EVENTS.filter(e => e.d === now.getDate() && e.m === now.getMonth());
                    const todayPersonal = personalEvents[todayK] || [];

                    if (todayStatic.length > 0 || todayPersonal.length > 0) {
                        const shownKey = `reminder_shown_${todayK}_${uid}`;
                        if (!sessionStorage.getItem(shownKey)) {
                            const t = setTimeout(() => {
                                setShowReminder(true);
                                sessionStorage.setItem(shownKey, 'true');
                            }, 1500);
                            return () => clearTimeout(t);
                        }
                    }
                };
                
                if (Object.keys(personalEvents).length >= 0) {
                    checkReminders();
                }
            }, [personalEvents, uid]);

            const themeData = useMemo(() => {
                const m = currentTime.getMonth();
                const seasons = { Verano: [11,0,1], Otoño: [2,3,4], Invierno: [5,6,7], Primavera: [8,9,10] };
                const season = Object.keys(seasons).find(k => seasons[k].includes(m)) || 'Verano';
                const colors = { Verano: ['#FFD700','#FF8C00'], Otoño: ['#D35400','#8B4513'], Invierno: ['#4169E1','#87CEEB'], Primavera: ['#FF69B4','#32CD32'] };
                const strat = creativeStrategies.find(st => st.m === m) || creativeStrategies[0];
                return { seasonName: season, seasonalPalette: colors[season], campaignName: strat.title, strategies: strat };
            }, [currentTime]);

            const selectedStrategy = useMemo(() => creativeStrategies.find(s => s.m === strategyMonth), [strategyMonth]);

            const proCalcResult = useMemo(() => {
              const material = materialDb.find(m => m.id === Number(calc.selectedMaterialId));
              const baseMaterialCost = material ? material.price * (calc.materialQty || 1) : 0;
              const directCosts = baseMaterialCost + (baseMaterialCost * ((calc.inkPercent || 0)/100)) + (calc.assemblyCost || 0) + (calc.packagingCost || 0);
              const waste = directCosts * ((calc.wastePercent || 0)/100);
              const labor = ((calc.designHours || 0) + (calc.cuttingHours || 0) + (calc.assemblyHours || 0)) * (calc.hourlyRate || 0);
              const productionTotal = directCosts + waste + labor + (calc.finishingCost || 0);
              const operatingTotal = (calc.opExpenses || 0) + (calc.maintenanceFund || 0) + (calc.subscriptions || 0);
              const subTotal = productionTotal + operatingTotal;
              const withProfit = subTotal * (1 + (calc.profitMargin || 0)/100);
              return { cost: subTotal, final: withProfit * (1 + (calc.taxesPercent || 0)/100) };
            }, [calc, materialDb]);

            const calculatedUnitCost = useMemo(() => {
                  const cost = parseFloat(invInput.totalCost) || 0;
                  const qty = parseFloat(invInput.totalQty) || 1;
                  const portion = parseFloat(invInput.portion) || 1;
                  return ((cost / qty) * portion).toFixed(2);
            }, [invInput]);

            const calculatedStock = useMemo(() => {
                  const qty = parseFloat(invInput.totalQty) || 0;
                  const portion = parseFloat(invInput.portion) || 1;
                  if(portion === 0) return 0;
                  return Math.floor(qty / portion); 
            }, [invInput]);

            const inventoryStats = useMemo(() => {
              const now = new Date();
              const currentMonth = now.getMonth();
              const currentYear = now.getFullYear();
              const getStats = (logs) => {
                  const counts = {};
                  logs.forEach(l => { counts[l.name] = (counts[l.name] || 0) + l.qty; });
                  const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                  return { most: sorted.slice(0, 5), least: sorted.slice(-5).reverse() };
              };
              const monthLogs = usageLog.filter(l => { const d = new Date(l.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; });
              const yearLogs = usageLog.filter(l => { const d = new Date(l.date); return d.getFullYear() === currentYear; });
              return { month: getStats(monthLogs), year: getStats(yearLogs) };
            }, [usageLog]);

            const registerUsage = (item, qty) => {
              if(item.qty < qty) return notify("Stock insuficiente");
              setInventory(prev => prev.map(i => i.id === item.id ? { ...i, qty: i.qty - qty } : i));
              setUsageLog(prev => [...prev, { id: Date.now(), materialId: item.id, name: item.name, qty: qty, date: new Date().toISOString() }]);
              notify(`Uso registrado: ${qty} ${item.name}`);
            };

            const calendarDays = useMemo(() => {
              const y = viewDate.getFullYear(), m = viewDate.getMonth();
              const dInM = new Date(y, m + 1, 0).getDate();
              const firstDay = new Date(y, m, 1).getDay();
              const offset = firstDay === 0 ? 6 : firstDay - 1;
              const days = []; for (let i = 0; i < offset; i++) days.push(null); for (let i = 1; i <= dInM; i++) days.push(i); return days;
            }, [viewDate]);

            const handleLogoUpload = (e, type) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { if(type==='budget') handleBudgetChange('logo', reader.result); else handleInvoiceChange('logo', reader.result); };
                    reader.readAsDataURL(file);
                }
            };

            const addMaterialToDb = (e) => {
                e.preventDefault();
                const f = new FormData(e.target);
                const name = f.get('name');
                const price = Number(f.get('price'));
                if(!name || isNaN(price)) return;
                setMaterialDb([...materialDb, { id: Date.now(), name, price }]);
                e.target.reset();
                notify("Material guardado");
            };

            const openPinterestSearch = (query) => window.open(`https://www.pinterest.com/search/pins/?q=${encodeURIComponent(query)}`, '_blank');

            const exportToCSV = (data, filename) => {
               if(!data || !data.length) return notify("Sin datos");
               const h = Object.keys(data[0]).join(",");
               const r = data.map(o => Object.values(o).map(v => typeof v === 'string' ? `"${v.replace(/"/g, '""')}"` : v).join(","));
               const b = new Blob(["\uFEFF" + [h, ...r].join("\n")], {type: 'text/csv;charset=utf-8;'});
               const u = URL.createObjectURL(b); const l = document.createElement("a"); l.href = u; l.download = `${filename}.csv`; document.body.appendChild(l); l.click(); document.body.removeChild(l);
            };

            const handleBudgetChange = (f, v) => setCurrentBudget(p => ({ ...p, [f]: v }));
            const handleInvoiceChange = (f, v) => setCurrentInvoice(p => ({ ...p, [f]: v }));
            const updateBudgetItem = (id, f, v) => setCurrentBudget(p => ({ ...p, items: p.items.map(i => i.id === id ? { ...i, [f]: v } : i) }));
            const updateInvItem = (id, f, v) => setCurrentInvoice(p => ({ ...p, items: p.items.map(i => i.id === id ? { ...i, [f]: v } : i) }));
            const addBudgetItem = () => setCurrentBudget(prev => ({ ...prev, items: [...prev.items, { id: Date.now(), desc: '', qty: 1, price: 0 }] }));
            const addInvItem = () => setCurrentInvoice(prev => ({ ...prev, items: [...prev.items, { id: Date.now(), desc: '', qty: 1, price: 0 }] }));

            const todayEvents = FULL_EVENTS.filter(e => e.d === currentTime.getDate() && e.m === currentTime.getMonth());
            const COURIERS = ['DAC (Agencia Central)', 'Correo Uruguayo', 'UES', 'Mirtrans', 'DePunta', 'Nuñez', 'Turil', 'PedidosYa Envíos', 'Estafeta', 'Redpack', 'Paquetexpress', 'Correos de México', '99minutos', 'Sendex', 'DHL', 'FedEx', 'UPS', 'Mercado Envíos', 'Rappi Envíos', 'Andreani', 'Blue Express'].sort();

            useEffect(() => { const timer = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timer); }, []);

            return (
              <div className="flex h-screen overflow-hidden bg-[#fcfcfc] text-slate-800 font-sans">
                <aside className={`fixed lg:static inset-y-0 left-0 w-64 bg-white border-r border-slate-100 flex flex-col shrink-0 shadow-2xl z-50 transition-transform duration-300 no-print ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                  <div className="p-6 text-center flex flex-col items-center">
                    <div className="p-3 rounded-2xl text-white shadow-xl rotate-3 mb-3 inline-block bg-brand"><Icons.Star className="w-6 h-6 fill-current" /></div>
                    <h1 className="font-black text-xl uppercase text-slate-800 tracking-tighter leading-none">MC Pro</h1>
                    <p className="text-[9px] font-bold text-brand uppercase tracking-[0.4em] mt-2 leading-none">Modo Creativo</p>
                  </div>
                  <div className="px-4 py-2 mb-2">
                      <div className="p-3 bg-slate-50 rounded-xl border border-slate-100 text-center shadow-inner">
                          <p className="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-1 flex items-center justify-center gap-1"><Icons.ShieldCheck className="w-3 h-3 text-emerald-500"/> Activo</p>
                          <p className="text-xs font-bold text-slate-700 truncate">{userEmail}</p>
                      </div>
                  </div>
                  <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                    <NavItemComp id="dashboard" label="Escritorio" icon={Icons.Layout} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="strategies" label="Estrategias" icon={Icons.Lightbulb} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="finances" label="Finanzas" icon={Icons.Wallet} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    
                    {/* AGREGADO: Nueva pestaña Contactos */}
                    <NavItemComp id="contacts" label="Contactos" icon={Icons.UserCheck} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    
                    <NavItemComp id="clients" label="Ventas" icon={Icons.DollarSign} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="presupuestos" label="Presupuestos" icon={Icons.FileText} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="facturas" label="Facturación" icon={Icons.CreditCard} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="shipping" label="Envíos" icon={Icons.Truck} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="planner" label="Calendario" icon={Icons.Calendar} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="inventory" label="Insumos" icon={Icons.Package} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="checklist" label="Taller" icon={Icons.ClipboardList} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="calculator" label="Cotizador" icon={Icons.Calculator} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="store" label="Tienda Digital" icon={Icons.ShoppingBag} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    {isAdmin && <NavItemComp id="access_control" label="Usuarios" icon={Icons.ShieldCheck} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />}
                    <NavItemComp id="profile" label="Mis Datos" icon={Icons.User} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                  </nav>
                  <div className="p-4 border-t border-slate-50 space-y-2">
                    <button onClick={() => setShowContactModal(true)} className="w-full py-3 bg-dark text-white rounded-xl font-bold text-xs uppercase tracking-widest hover:scale-[1.02] transition-all flex justify-center gap-2 shadow-sm"><Icons.MessageCircle className="w-4 h-4" /> Soporte</button>
                    <button onClick={onLogout} className="w-full py-3 text-slate-400 hover:text-brand rounded-xl font-bold text-xs uppercase hover:bg-rose-50 flex justify-center gap-2 transition-all"><Icons.LogOut className="w-4 h-4" /> Salir</button>
                  </div>
                </aside>

                <main className="flex-1 overflow-y-auto p-4 md:p-6 relative text-slate-800 print-area">
                  {notification && <div className="fixed top-6 right-6 bg-dark text-white px-6 py-3 rounded-xl font-bold text-xs uppercase shadow-2xl z-[100] animate-in no-print">{notification}</div>}
                  
                  <header className="flex justify-between items-center mb-6 no-print">
                    <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden p-2 bg-white shadow-sm border border-slate-100 rounded-xl text-brand"><Icons.Menu className="w-6 h-6" /></button>
                    <h2 className="text-2xl md:text-3xl font-black tracking-tighter uppercase text-slate-800 leading-none">
                      {activeTab === 'dashboard' ? 'Escritorio' : activeTab === 'strategies' ? 'Estrategias' : activeTab === 'finances' ? 'Finanzas' : activeTab === 'contacts' ? 'Contactos' : activeTab === 'clients' ? 'Ventas' : activeTab === 'presupuestos' ? 'Presupuestos' : activeTab === 'facturas' ? 'Facturación' : activeTab === 'shipping' ? 'Envíos' : activeTab === 'planner' ? 'Calendario' : activeTab === 'inventory' ? 'Insumos' : activeTab === 'checklist' ? 'Taller' : activeTab === 'calculator' ? 'Cotizador' : activeTab === 'store' ? 'Tienda Digital' : activeTab === 'access_control' ? 'Usuarios' : 'Mis Datos'}
                    </h2>
                    <div className="hidden md:flex items-center gap-3 bg-white p-2 pr-4 rounded-xl border border-slate-100 shadow-sm font-bold">
                      <div className="flex items-center gap-2 px-3 border-r border-slate-100"><Icons.Globe className="w-4 h-4 text-slate-400" /><span className="text-xs uppercase leading-none">{userCountry}</span></div>
                      <div className="bg-amber-100 p-1.5 rounded-lg text-amber-500"><Icons.Sun className="w-4 h-4" /></div>
                      <p className="text-xs leading-none">{currentTime.toLocaleTimeString('es-UY', {hour:'2-digit',minute:'2-digit'})}</p>
                    </div>
                  </header>

                  {/* --- DASHBOARD --- */}
                  {activeTab === 'dashboard' && (
                    <div className="space-y-6 animate-in flex flex-col h-full">
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onClick={() => setActiveTab('planner')} className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 hover:border-brand transition-all group">
                          <div className="p-2 bg-indigo-50 text-indigo-600 rounded-xl group-hover:bg-indigo-100"><Icons.Calendar className="w-5 h-5"/></div>
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase text-slate-400 leading-none">Mi</p><p className="font-black text-xs uppercase leading-none mt-1">Planner</p></div>
                        </button>
                        <button onClick={() => setActiveTab('checklist')} className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 hover:border-brand transition-all group">
                          <div className="p-2 bg-rose-50 text-brand rounded-xl group-hover:bg-rose-100"><Icons.ClipboardList className="w-5 h-5"/></div>
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase text-slate-400 leading-none">Ir al</p><p className="font-black text-xs uppercase leading-none mt-1">Taller</p></div>
                        </button>
                        <button onClick={() => setActiveTab('calculator')} className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 hover:border-brand transition-all group">
                          <div className="p-2 bg-amber-50 text-amber-600 rounded-xl group-hover:bg-amber-100"><Icons.Calculator className="w-5 h-5"/></div>
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase text-slate-400 leading-none">Ir al</p><p className="font-black text-xs uppercase leading-none mt-1">Cotizador</p></div>
                        </button>
                        <div className="bg-slate-900 p-4 rounded-3xl text-white shadow-lg flex items-center gap-3 relative overflow-hidden">
                          <div className="absolute right-0 top-0 p-2 opacity-10"><Icons.Calendar className="w-10 h-10" /></div>
                          <div className="text-left z-10 leading-none">
                              <p className="text-[9px] font-black uppercase text-indigo-400 leading-none">Hoy:</p>
                              <p className="font-black text-[11px] uppercase leading-tight truncate w-24 mt-1">{todayEvents.length > 0 ? todayEvents[0].t : 'Sin eventos'}</p>
                          </div>
                        </div>
                      </div>

                      {/* Widget Noticias Creativas Diarias */}
                      <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                          <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-6 flex items-center gap-3">
                              <Icons.Newspaper className="w-5 h-5 text-brand" /> Noticias Creativas Diarias
                          </h3>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                              {stationeryNews.map((news, idx) => (
                                  <a key={idx} href={news.link} target="_blank" className="group p-5 bg-slate-50 rounded-[2rem] border border-slate-50 hover:bg-white hover:border-brand hover:shadow-xl transition-all">
                                      <div className="flex justify-between items-start mb-3">
                                          <div className="p-2 bg-white rounded-xl shadow-sm text-brand"><Icons.Zap className="w-4 h-4 fill-current"/></div>
                                          <Icons.ChevronRight className="w-4 h-4 text-slate-300 group-hover:text-brand" />
                                      </div>
                                      <h4 className="font-black uppercase text-xs mb-2 tracking-tight leading-tight">{news.title}</h4>
                                      <p className="text-[11px] text-slate-500 font-medium leading-relaxed">"{news.desc}"</p>
                                  </a>
                              ))}
                          </div>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 min-h-[150px]">
                        <div className="bg-dark p-6 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden flex flex-col justify-center">
                          <div className="absolute top-0 right-0 p-6 opacity-10"><Icons.BarChart3 className="w-16 h-16" /></div>
                          <h3 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2 leading-none">Balance</h3>
                          <p className="text-4xl font-black tracking-tighter leading-none">${netBalance}</p>
                        </div>
                        <div className="bg-emerald-50 p-6 rounded-[2.5rem] border border-emerald-100 flex flex-col justify-center text-slate-800 leading-none"><h3 className="text-[10px] font-black text-emerald-600 uppercase tracking-widest mb-2 leading-none">Ingresos</h3><p className="text-4xl font-black tracking-tighter leading-none">${totalIncomes}</p></div>
                        <div className="bg-rose-50 p-6 rounded-[2.5rem] border border-rose-100 flex flex-col justify-center text-slate-800 leading-none"><h3 className="text-[10px] font-black text-rose-600 uppercase tracking-widest mb-2 leading-none">Gastos</h3><p className="text-4xl font-black tracking-tighter leading-none">${totalExpenses}</p></div>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <a href="https://web.whatsapp.com/" target="_blank" className="bg-[#25D366] p-6 rounded-3xl text-white shadow-sm flex items-center gap-6 hover:scale-105 transition-transform group">
                          <Icons.MessageCircle className="w-8 h-8 group-hover:animate-bounce" />
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase opacity-80 leading-none tracking-widest">Abrir</p><h3 className="text-xl font-black uppercase leading-none mt-1">WhatsApp</h3></div>
                        </a>
                        <a href="https://instagram.com/" target="_blank" className="bg-gradient-to-tr from-amber-400 via-rose-500 to-purple-600 p-6 rounded-3xl text-white shadow-sm flex items-center gap-6 hover:scale-105 transition-transform group">
                          <Icons.Instagram className="w-8 h-8 group-hover:animate-pulse" />
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase opacity-80 leading-none tracking-widest">Feed</p><h3 className="text-xl font-black uppercase leading-none mt-1">Instagram</h3></div>
                        </a>
                        <a href="https://mail.google.com/" target="_blank" className="bg-dark p-6 rounded-3xl text-white shadow-sm flex items-center gap-6 hover:scale-105 transition-transform group border border-slate-700">
                          <Icons.Mail className="w-8 h-8 group-hover:animate-bounce" />
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase opacity-80 leading-none tracking-widest">Bandeja</p><h3 className="text-xl font-black uppercase leading-none mt-1">Gmail</h3></div>
                        </a>
                      </div>
                    </div>
                  )}

                  {/* --- AGREGADO: PESTAÑA DE CONTACTOS --- */}
                  {activeTab === 'contacts' && (
                      <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                          <div className="flex justify-between items-center mb-6">
                              <h3 className="text-xl font-black uppercase tracking-tighter flex items-center gap-2"><Icons.UserCheck className="w-6 h-6"/> Directorio de Contactos</h3>
                          </div>
                          <div className="flex-1 overflow-y-auto mb-6 pr-2 space-y-3">
                              {contacts.map(c => (
                                  <div key={c.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex justify-between items-center">
                                      <div>
                                          <h4 className="font-black text-sm text-slate-800 uppercase">{c.name}</h4>
                                          <div className="text-[10px] font-bold text-slate-500 mt-1 flex flex-wrap gap-4">
                                              <span>📞 {c.phone || '-'}</span>
                                              <span>✉️ {c.email || '-'}</span>
                                              <span>📍 {c.address || '-'}, {c.department || '-'}</span>
                                          </div>
                                      </div>
                                      <button onClick={() => deleteItem(c.id, setContacts, 'Contacto')} className="p-2 text-slate-300 hover:text-red-500 bg-white rounded-xl shadow-sm"><Icons.Trash2 className="w-4 h-4"/></button>
                                  </div>
                              ))}
                              {contacts.length === 0 && <p className="text-center py-10 text-slate-400 font-medium text-sm">No hay contactos registrados aún.</p>}
                          </div>
                          <form onSubmit={(e) => saveEntity(e, setContacts, 'Contacto')} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                              <div className="lg:col-span-1"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Nombre Cliente *</label><input name="name" required placeholder="Ej: María López" className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-1"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Teléfono</label><input name="phone" placeholder="Celular..." className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-1"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Email</label><input name="email" type="email" placeholder="Correo..." className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-1"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Dirección</label><input name="address" placeholder="Calle y N°..." className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-1"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Departamento</label><input name="department" placeholder="Ej: Montevideo" className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-5 flex justify-end mt-2"><button className="px-8 py-3 bg-slate-900 text-white rounded-xl font-black uppercase tracking-widest shadow-lg hover:scale-105 transition-transform flex items-center gap-2"><Icons.Plus className="w-4 h-4"/> Guardar Contacto</button></div>
                          </form>
                      </div>
                  )}

                  {/* --- ESTRATEGIAS MEJORADAS --- */}
                  {activeTab === 'strategies' && (
                    <div className="space-y-6 animate-in pb-10">
                        {/* Scroll Meses */}
                        <div className="flex gap-2 overflow-x-auto pb-2 scroll-smooth no-scrollbar">
                          {['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'].map((month, i) => (
                             <button key={i} onClick={() => setStrategyMonth(i)} className={`px-6 py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest transition-all shrink-0 border ${strategyMonth === i ? 'bg-brand text-white shadow-lg border-brand scale-105' : 'bg-white text-slate-400 border-slate-100 hover:bg-slate-50'}`}>{month}</button>
                          ))}
                        </div>

                        {/* Hero Header */}
                        <div className="relative overflow-hidden rounded-[2.5rem] p-8 md:p-10 text-white shadow-2xl transition-all duration-500" style={{background: `linear-gradient(135deg, ${themeData.seasonalPalette[0]} 0%, ${themeData.seasonalPalette[1]} 100%)`}}>
                          <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                              <div className="text-center md:text-left leading-none">
                                  <div className="flex items-center justify-center md:justify-start gap-2 mb-3 opacity-90 leading-none">
                                      <Icons.Star className="w-5 h-5 fill-white" />
                                      <span className="text-[10px] font-black uppercase tracking-[0.4em] leading-none">Plan Estratégico</span>
                                  </div>
                                  <h2 className="text-4xl md:text-6xl font-black tracking-tighter uppercase leading-none mb-4">{selectedStrategy.title}</h2>
                                  <div className="flex flex-wrap justify-center md:justify-start gap-2">
                                      {selectedStrategy.platforms?.map((plat, i) => (
                                          <span key={i} className="px-4 py-1.5 bg-slate-900/30 backdrop-blur-md rounded-xl text-[9px] font-black uppercase tracking-widest text-white border border-white/20">{plat}</span>
                                      ))}
                                  </div>
                              </div>
                              <div className="flex flex-col gap-2 items-center md:items-end">
                                  {selectedStrategy.keywords.split(' ').map((tag, i) => (
                                      <span key={i} className="text-xs font-bold opacity-80">{tag}</span>
                                  ))}
                              </div>
                          </div>
                          <div className="absolute -right-12 -bottom-12 opacity-10 rotate-12 scale-150"><Icons.Lightbulb className="w-64 h-64" /></div>
                        </div>

                        {/* Paletas movidas desde el Dashboard */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col justify-center text-center">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center justify-center gap-2"><Icons.CloudSun className="w-5 h-5 text-amber-500"/> Tendencia ({themeData.seasonName})</h3>
                            <div className="flex h-12 rounded-2xl overflow-hidden border border-slate-50 shadow-inner">{themeData.seasonalPalette.map((c,i)=><div key={i} className="flex-1" style={{backgroundColor:c}}/>)}</div>
                          </div>
                          <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col justify-center text-center">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center justify-center gap-2"><Icons.Palette className="w-5 h-5 text-brand"/> Campaña ({themeData.campaignName})</h3>
                            <div className="flex h-12 rounded-2xl border border-slate-100 shadow-inner"><div className="flex-1 bg-rose-500"></div><div className="flex-1 bg-rose-400"></div><div className="flex-1 bg-rose-300"></div></div>
                          </div>
                        </div>

                        {/* Grid Principal de Estrategias */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-stretch">
                          
                          {/* Col 1: Productos */}
                          <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full">
                              <div className="flex justify-between items-center mb-6">
                                  <h3 className="text-lg font-black flex items-center gap-2 uppercase tracking-tight text-slate-800"><Icons.Package className="w-5 h-5 text-brand" /> Qué Vender</h3>
                                  <button onClick={() => openPinterestSearch(`${selectedStrategy.title} papeleria productos`)} className="p-2 bg-rose-50 text-brand rounded-xl hover:scale-110 transition-transform"><Icons.Pinterest className="w-4 h-4"/></button>
                              </div>
                              <div className="space-y-3 flex-1">
                                  {selectedStrategy.productIdeas?.map((idea, i) => (
                                      <div key={i} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex items-start gap-3 hover:border-brand/50 transition-colors">
                                          <div className="w-2 h-2 rounded-full bg-brand mt-1.5 shrink-0"></div>
                                          <p className="font-bold text-slate-700 text-xs leading-relaxed">{idea}</p>
                                      </div>
                                  ))}
                              </div>
                          </div>

                          {/* Col 2: Contenido */}
                          <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full">
                              <div className="flex justify-between items-center mb-6">
                                  <h3 className="text-lg font-black flex items-center gap-2 uppercase tracking-tight text-slate-800"><Icons.Instagram className="w-5 h-5 text-amber-500" /> Qué Publicar</h3>
                              </div>
                              <div className="space-y-3 flex-1">
                                  {selectedStrategy.contentIdeas?.map((idea, i) => {
                                      const [format, ...text] = idea.split(': ');
                                      return (
                                          <div key={i} className="p-4 bg-amber-50/50 rounded-2xl border border-amber-100 flex flex-col gap-1 hover:border-amber-300 transition-colors">
                                              <span className="text-[9px] font-black uppercase text-amber-600 tracking-widest">{format}</span>
                                              <p className="font-bold text-slate-700 text-xs leading-relaxed">{text.join(': ')}</p>
                                          </div>
                                      );
                                  })}
                              </div>
                          </div>

                          {/* Col 3: Promociones */}
                          <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full">
                              <div className="flex justify-between items-center mb-6">
                                  <h3 className="text-lg font-black flex items-center gap-2 uppercase tracking-tight text-slate-800"><Icons.Megaphone className="w-5 h-5 text-emerald-500" /> Cómo Vender</h3>
                              </div>
                              <div className="space-y-3 flex-1">
                                  {selectedStrategy.promoIdeas?.map((idea, i) => (
                                      <div key={i} className="p-4 bg-emerald-50/50 rounded-2xl border border-emerald-100 flex items-start gap-3 hover:border-emerald-300 transition-colors">
                                          <div className="w-6 h-6 rounded-full bg-emerald-200 text-emerald-700 flex items-center justify-center shrink-0 mt-0.5"><Icons.DollarSign className="w-3 h-3"/></div>
                                          <p className="font-bold text-slate-700 text-xs leading-relaxed">{idea}</p>
                                      </div>
                                  ))}
                              </div>
                          </div>

                        </div>

                        {/* Bottom Grid: Tip Manager y Estética */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Tip Manager (Ocupa 2 col) */}
                            <div className="lg:col-span-2 bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden group flex flex-col justify-center">
                                <div className="absolute right-0 bottom-0 p-4 opacity-5"><Icons.UserCheck className="w-48 h-48" /></div>
                                <h3 className="text-base font-black uppercase mb-6 relative z-10 flex items-center gap-2 text-indigo-400 leading-none"><Icons.Settings className="w-5 h-5"/> Consejo del Manager</h3>
                                <div className="relative z-10 bg-white/10 p-5 rounded-2xl border border-white/10 backdrop-blur-sm">
                                    <p className="text-base font-medium leading-relaxed text-slate-100">"{selectedStrategy.managerTip}"</p>
                                </div>
                                <div className="relative z-10 mt-6 flex items-center gap-3">
                                    <h4 className="text-[9px] font-black text-slate-400 uppercase tracking-widest leading-none">Acción Principal:</h4>
                                    <div className="px-4 py-2 bg-brand rounded-xl text-white text-xs font-bold uppercase tracking-tight leading-none shadow-md">{selectedStrategy.action}</div>
                                </div>
                            </div>

                            {/* Estética (Ocupa 1 col) */}
                            <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col justify-center">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2 leading-none"><Icons.Palette className="w-4 h-4"/> Estética Visual</h3>
                                <div className="p-5 bg-rose-50 rounded-2xl mb-6 border border-slate-100 shadow-inner flex-1">
                                    <p className="text-sm font-bold text-slate-700 leading-relaxed">"{selectedStrategy.trend}"</p>
                                </div>
                                <h4 className="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mb-3 leading-none">Paleta del Mes</h4>
                                <div className="flex h-14 rounded-2xl overflow-hidden shadow-inner border border-slate-100">
                                    {themeData.seasonalPalette.map((c, i) => (<div key={i} className="flex-1 hover:scale-110 transition-all cursor-pointer" style={{ backgroundColor: c }} title={c}></div>))}
                                </div>
                            </div>
                        </div>

                    </div>
                  )}

                  {/* --- SECCIÓN PLANNER --- */}
                  {activeTab === 'planner' && (() => {
                      const seasonalColors = (() => {
                          const m = viewDate.getMonth();
                          // Verano: 11, 0, 1 (Dec, Jan, Feb)
                          if ([11, 0, 1].includes(m)) return { bg: 'bg-pink-100', border: 'border-pink-200', text: 'text-pink-600', selected: 'bg-gradient-to-br from-pink-400 to-rose-500', dot: 'bg-pink-500', light: 'bg-white', mainBg: 'bg-pink-50/50' };
                          // Otoño: 2, 3, 4 (Mar, Apr, May)
                          if ([2, 3, 4].includes(m)) return { bg: 'bg-orange-100', border: 'border-orange-200', text: 'text-orange-600', selected: 'bg-gradient-to-br from-orange-400 to-amber-500', dot: 'bg-orange-500', light: 'bg-white', mainBg: 'bg-orange-50/50' };
                          // Invierno: 5, 6, 7 (Jun, Jul, Aug)
                          if ([5, 6, 7].includes(m)) return { bg: 'bg-violet-100', border: 'border-violet-200', text: 'text-violet-600', selected: 'bg-gradient-to-br from-violet-400 to-fuchsia-500', dot: 'bg-violet-500', light: 'bg-white', mainBg: 'bg-violet-50/50' };
                          // Primavera: 8, 9, 10 (Sep, Oct, Nov)
                          return { bg: 'bg-teal-100', border: 'border-teal-200', text: 'text-teal-600', selected: 'bg-gradient-to-br from-teal-400 to-emerald-500', dot: 'bg-teal-500', light: 'bg-white', mainBg: 'bg-teal-50/50' };
                      })();

                      return (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in text-slate-800">
                          <div className={`lg:col-span-2 ${seasonalColors.mainBg} p-4 sm:p-6 rounded-[2.5rem] shadow-2xl border ${seasonalColors.border}`}>
                             <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 sm:gap-0">
                                <h3 className={`text-xl sm:text-2xl font-black uppercase tracking-tighter leading-none ${seasonalColors.text}`}>{viewDate.toLocaleDateString('es-UY', { month: 'long', year: 'numeric' })}</h3>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowReminder(true)} className={`p-2 bg-white ${seasonalColors.text} rounded-xl shadow-sm hover:scale-105 transition-transform mr-2`} title="Ver Alertas de Hoy"><Icons.Bell className="w-4 h-4"/></button>
                                    <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1))} className={`p-2 bg-white ${seasonalColors.text} rounded-xl shadow-sm hover:scale-105 transition-transform`}><Icons.ChevronLeft className="w-4 h-4"/></button>
                                    <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1))} className={`p-2 bg-white ${seasonalColors.text} rounded-xl shadow-sm hover:scale-105 transition-transform`}><Icons.ChevronRight className="w-4 h-4"/></button>
                                </div>
                             </div>
                             
                             <div className="grid grid-cols-7 gap-1 sm:gap-1.5">
                               {t.days.map(d=><div key={d} className={`text-center font-black pb-2 text-[8px] sm:text-[10px] ${seasonalColors.text} uppercase leading-none opacity-70`}>{d}</div>)}
                               {calendarDays.map((d,i)=>{
                                 const hasEvents = FULL_EVENTS.some(e => e.d === d && e.m === viewDate.getMonth());
                                 const dayKey = d ? getDayKey(d) : null;
                                 const hasPersonal = dayKey && personalEvents[dayKey] && personalEvents[dayKey].length > 0;
                                 const isToday = d === new Date().getDate() && viewDate.getMonth() === new Date().getMonth() && viewDate.getFullYear() === new Date().getFullYear();
                                 return (
                                   <div key={i} onClick={()=>d && setSelectedDay(d)} className={`h-12 sm:h-16 p-1 sm:p-2 rounded-xl border transition-all cursor-pointer flex flex-col justify-between ${selectedDay===d?`${seasonalColors.selected} text-white shadow-xl scale-105 z-10 border-transparent`:(hasEvents || hasPersonal)?`${seasonalColors.bg} ${seasonalColors.border}`:`bg-white border-white hover:${seasonalColors.border} shadow-sm`}`}>
                                     {d && <div className="flex justify-between items-start leading-none"><span className="text-xs sm:text-sm font-bold leading-none">{d}</span><div className="flex gap-0.5 sm:gap-1 leading-none">{hasEvents && <div className={`w-1 h-1 sm:w-1.5 sm:h-1.5 rounded-full ${seasonalColors.dot} shadow-sm animate-pulse`}></div>}{hasPersonal && <div className="w-1 h-1 sm:w-1.5 sm:h-1.5 rounded-full bg-blue-500 shadow-sm"></div>}</div></div>}
                                     {isToday && <div className={`text-[6px] sm:text-[8px] font-black uppercase ${selectedDay === d ? 'text-white/80' : seasonalColors.text} leading-none`}>Hoy</div>}
                                   </div>
                                 );
                               })}
                             </div>
                             
                             <div className={`mt-6 sm:mt-8 pt-6 border-t ${seasonalColors.border}`}>
                                <h4 className={`text-[9px] sm:text-[10px] font-black uppercase ${seasonalColors.text} mb-4 tracking-[0.2em] flex items-center gap-2 leading-none`}><Icons.Star className={`w-4 h-4 ${seasonalColors.text} fill-current`}/> Efemérides de Hoy ({currentTime.toLocaleDateString('es-UY', {day:'numeric', month:'long'})})</h4>
                                <div className="flex flex-wrap gap-2 sm:gap-3">
                                   {todayEvents.length > 0 ? todayEvents.map((ev, i) => (
                                     <div key={i} className={`px-3 sm:px-4 py-2 ${seasonalColors.bg} rounded-2xl border ${seasonalColors.border} shadow-sm animate-in`}><p className={`font-black uppercase text-[9px] sm:text-[10px] ${seasonalColors.text} leading-none`}>{ev.t}</p></div>
                                   )) : <p className={`text-xs ${seasonalColors.text} opacity-60 leading-none`}>No hay efemérides hoy.</p>}
                                </div>
                             </div>
                          </div>
                          
                          <div className={`bg-white p-4 sm:p-6 rounded-[2.5rem] shadow-xl border ${seasonalColors.border} h-fit`}>
                             <h4 className={`text-xl sm:text-2xl font-black uppercase mb-4 leading-none text-center sm:text-left ${seasonalColors.text}`}>{selectedDay} {viewDate.toLocaleDateString('es-UY', { month: 'short' })}</h4>
                             <div className="space-y-4 max-h-[300px] sm:max-h-[400px] overflow-y-auto pr-1">
                                {FULL_EVENTS.filter(e => e.d === selectedDay && e.m === viewDate.getMonth()).map((ev, i) => (<div key={i} className={`p-3 sm:p-4 ${seasonalColors.light} rounded-2xl border ${seasonalColors.border} shadow-sm animate-in`}><p className={`font-black uppercase text-xs ${seasonalColors.text} leading-tight`}>{ev.t}</p></div>))}
                                
                                <div className={`pt-4 border-t ${seasonalColors.border} text-slate-800`}>
                                   <h5 className={`text-[10px] font-black uppercase ${seasonalColors.text} opacity-80 mb-3 tracking-widest leading-none`}>Cita Personal</h5>
                                   <form onSubmit={(e) => { e.preventDefault(); const n = e.target.note.value.trim(); if(n){ const dk = getDayKey(selectedDay); const cur = personalEvents[dk] || []; setPersonalEvents({...personalEvents, [dk]: [...cur, n]}); e.target.reset(); notify("Cita guardada"); } }} className="flex gap-2 mb-4 leading-none">
                                      <input name="note" required placeholder="Escribir..." className={`flex-1 p-3 ${seasonalColors.light} rounded-xl outline-none text-xs shadow-inner leading-none border border-transparent focus:${seasonalColors.border}`} />
                                      <button className={`p-3 ${seasonalColors.selected} text-white rounded-xl hover:scale-105 transition-transform shadow-md leading-none`}><Icons.Plus className="w-4 h-4"/></button>
                                   </form>
                                   <div className="space-y-2">
                                      {(personalEvents[getDayKey(selectedDay)] || []).map((note, idx) => (
                                         <div key={idx} className="group flex justify-between items-center p-3 bg-blue-50 rounded-2xl border border-blue-100 text-blue-900 text-xs font-bold shadow-sm animate-in">
                                            <span className="truncate mr-2">{note}</span>
                                            <button onClick={() => { const dk = getDayKey(selectedDay); setPersonalEvents({...personalEvents, [dk]: personalEvents[dk].filter((_, ni) => ni !== idx)}); notify("Eliminada"); }}><Icons.Trash2 className="w-3 h-3 text-blue-300 hover:text-red-500 flex-shrink-0"/></button>
                                         </div>
                                      ))}
                                   </div>
                                </div>
                             </div>
                          </div>
                        </div>
                      );
                  })()}

                  {/* --- FINANZAS (ACTUALIZADO: CONTROL MENSUAL) --- */}
                  {activeTab === 'finances' && (() => {
                      const currentMonth = viewDate.getMonth();
                      const currentYear = viewDate.getFullYear();
                      
                      const filterByDate = (arr) => arr.filter(i => {
                          if(!i.date) return false;
                          const d = new Date(i.date);
                          return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                      });

                      const mClients = filterByDate(clients).filter(c => c.status === 'Completado' || !c.status);
                      const mExtra = filterByDate(extraIncomes);
                      const mExpenses = filterByDate(expenses);

                      const mIncomeTotal = mClients.reduce((acc, c) => acc + (c.amount || 0), 0) + mExtra.reduce((acc, i) => acc + (i.amount || 0), 0);
                      const mExpenseTotal = mExpenses.reduce((acc, e) => acc + (e.amount || 0), 0);
                      const mBalance = mIncomeTotal - mExpenseTotal;

                      return (
                          <div className="flex flex-col h-full space-y-6 animate-in">
                              {/* Header Finanzas Mes */}
                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
                                  <div className="flex items-center gap-4">
                                      <button onClick={()=>setViewDate(new Date(currentYear, currentMonth-1, 1))} className="p-2 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors"><Icons.ChevronLeft className="w-5 h-5"/></button>
                                      <h3 className="text-2xl font-black uppercase tracking-tighter text-slate-800">{viewDate.toLocaleDateString('es-UY', { month: 'long', year: 'numeric' })}</h3>
                                      <button onClick={()=>setViewDate(new Date(currentYear, currentMonth+1, 1))} className="p-2 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors"><Icons.ChevronRight className="w-5 h-5"/></button>
                                  </div>
                                  <div className="flex items-center gap-6">
                                      <div className="text-right">
                                          <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Balance Mensual</p>
                                          <p className={`text-4xl font-black tracking-tighter ${mBalance >= 0 ? 'text-slate-800' : 'text-rose-500'}`}>${mBalance}</p>
                                      </div>
                                  </div>
                              </div>

                              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-hidden">
                                  {/* COLUMNA INGRESOS */}
                                  <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full overflow-hidden">
                                      <div className="flex justify-between items-center mb-6">
                                          <h3 className="text-lg font-black uppercase text-emerald-600 tracking-tight flex items-center gap-2"><Icons.ArrowUpCircle className="w-6 h-6"/> {t.fin_income}</h3>
                                          <div className="px-4 py-2 bg-emerald-50 text-emerald-700 rounded-xl font-black text-xl shadow-sm">${mIncomeTotal}</div>
                                      </div>
                                      <div className="flex-1 overflow-y-auto space-y-3 mb-6 pr-2">
                                          {mClients.map(c => (
                                              <div key={c.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-xs">
                                                  <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center font-black text-slate-400">{c.name.charAt(0)}</div><span className="font-bold uppercase">{c.name}</span></div>
                                                  <span className="font-black text-emerald-600">+${c.amount}</span>
                                              </div>
                                          ))}
                                          {mExtra.map(i => (
                                              <div key={i.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-xs">
                                                  <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-amber-50 shadow-sm flex items-center justify-center font-black text-amber-500"><Icons.DollarSign className="w-4 h-4"/></div><span className="font-bold uppercase">{i.concept}</span></div>
                                                  <div className="flex items-center gap-3"><span className="font-black text-emerald-600">+${i.amount}</span><button onClick={()=>deleteItem(i.id, setExtraIncomes, 'Ingreso')} className="text-slate-300 hover:text-red-500"><Icons.X className="w-4 h-4"/></button></div>
                                              </div>
                                          ))}
                                          {mClients.length === 0 && mExtra.length === 0 && <p className="text-center py-6 text-slate-400 font-medium text-xs">Sin ingresos este mes.</p>}
                                      </div>
                                      <form onSubmit={(e)=>saveEntity(e, setExtraIncomes, 'Ingreso')} className="p-4 bg-emerald-50 rounded-3xl border border-emerald-100 shrink-0">
                                          <h4 className="text-[10px] font-black uppercase text-emerald-600 mb-3 tracking-widest">Nuevo Ingreso Extra</h4>
                                          <div className="flex gap-2">
                                              <input name="concept" placeholder={t.label_concept} required className="flex-1 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" />
                                              <input name="amount" type="number" placeholder="$" required className="w-24 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" />
                                              <button className="p-3 bg-emerald-600 text-white rounded-xl shadow-md hover:scale-105 transition-transform"><Icons.Plus className="w-4 h-4"/></button>
                                          </div>
                                      </form>
                                  </div>
                                  {/* COLUMNA GASTOS */}
                                  <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full overflow-hidden">
                                      <div className="flex justify-between items-center mb-6">
                                          <h3 className="text-lg font-black uppercase text-rose-600 tracking-tight flex items-center gap-2"><Icons.ArrowDownCircle className="w-6 h-6"/> {t.fin_expenses}</h3>
                                          <div className="px-4 py-2 bg-rose-50 text-rose-700 rounded-xl font-black text-xl shadow-sm">${mExpenseTotal}</div>
                                      </div>
                                      <div className="flex-1 overflow-y-auto space-y-3 mb-6 pr-2">
                                          {mExpenses.map(e => (
                                              <div key={e.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-xs group">
                                                  <span className="font-bold uppercase ml-2">{e.concept}</span>
                                                  <div className="flex items-center gap-3"><span className="font-black text-rose-600">-${e.amount}</span><button onClick={()=>deleteItem(e.id, setExpenses, 'Gasto')} className="text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button></div>
                                              </div>
                                          ))}
                                          {mExpenses.length === 0 && <p className="text-center py-6 text-slate-400 font-medium text-xs">Sin gastos este mes.</p>}
                                      </div>
                                      <form onSubmit={(e)=>saveEntity(e, setExpenses, 'Gasto')} className="p-4 bg-rose-50 rounded-3xl border border-rose-100 shrink-0">
                                          <h4 className="text-[10px] font-black uppercase text-rose-600 mb-3 tracking-widest">Nuevo Gasto</h4>
                                          <div className="flex gap-2">
                                              <input name="concept" placeholder={t.label_concept} required className="flex-1 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" />
                                              <input name="amount" type="number" placeholder="$" required className="w-24 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" />
                                              <button className="p-3 bg-rose-600 text-white rounded-xl shadow-md hover:scale-105 transition-transform"><Icons.Plus className="w-4 h-4"/></button>
                                          </div>
                                      </form>
                                  </div>
                              </div>
                          </div>
                      );
                  })()}

                  {/* --- CLIENTES --- */}
                  {activeTab === 'clients' && (() => {
                      const isDateInView = (dateStr, view, referenceDate) => {
                          if(!dateStr) return false;
                          const d = new Date(dateStr);
                          const ref = new Date(referenceDate);
                          if (view === 'year') return d.getFullYear() === ref.getFullYear();
                          if (view === 'month') return d.getMonth() === ref.getMonth() && d.getFullYear() === ref.getFullYear();
                          if (view === 'week') {
                              const startOfWeek = new Date(ref);
                              startOfWeek.setDate(ref.getDate() - ref.getDay() + (ref.getDay() === 0 ? -6 : 1));
                              startOfWeek.setHours(0,0,0,0);
                              const endOfWeek = new Date(startOfWeek);
                              endOfWeek.setDate(startOfWeek.getDate() + 6);
                              endOfWeek.setHours(23,59,59,999);
                              return d >= startOfWeek && d <= endOfWeek;
                          }
                          return true;
                      };

                      const filteredClients = clients.filter(c => isDateInView(c.date, salesView, viewDate));
                      const salesBalance = {
                          hecho: filteredClients.filter(c => c.status === 'Completado' || !c.status).reduce((a,b) => a + (b.amount||0), 0),
                          pendiente: filteredClients.filter(c => c.status === 'Pendiente').reduce((a,b) => a + (b.amount||0), 0),
                          no_cobrado: filteredClients.filter(c => c.status === 'No Cobrado').reduce((a,b) => a + (b.amount||0), 0),
                          cancelado: filteredClients.filter(c => c.status === 'Cancelado').reduce((a,b) => a + (b.amount||0), 0)
                      };

                      return (
                          <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                              <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                  <h3 className="text-xl font-black uppercase tracking-tighter">Directorio de Ventas</h3>
                                  <div className="flex gap-2 items-center">
                                      <div className="flex bg-slate-100 rounded-xl p-1">
                                          <button onClick={() => setSalesView('week')} className={`px-4 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${salesView === 'week' ? 'bg-white text-brand shadow-sm' : 'text-slate-400'}`}>Semana</button>
                                          <button onClick={() => setSalesView('month')} className={`px-4 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${salesView === 'month' ? 'bg-white text-brand shadow-sm' : 'text-slate-400'}`}>Mes</button>
                                          <button onClick={() => setSalesView('year')} className={`px-4 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${salesView === 'year' ? 'bg-white text-brand shadow-sm' : 'text-slate-400'}`}>Año</button>
                                      </div>
                                      <button onClick={()=>exportToCSV(clients, 'ventas_mc_pro')} className="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:scale-105 transition-transform flex gap-2"><Icons.Download className="w-4 h-4"/> CSV</button>
                                  </div>
                              </div>
                              
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                  <div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 flex flex-col justify-center">
                                      <span className="text-[9px] font-black uppercase text-emerald-600 tracking-widest mb-1">Hechos / Cobrados</span>
                                      <span className="text-2xl font-black text-emerald-700 tracking-tighter">${salesBalance.hecho}</span>
                                  </div>
                                  <div className="p-4 bg-amber-50 rounded-2xl border border-amber-100 flex flex-col justify-center">
                                      <span className="text-[9px] font-black uppercase text-amber-600 tracking-widest mb-1">Pendientes</span>
                                      <span className="text-2xl font-black text-amber-700 tracking-tighter">${salesBalance.pendiente}</span>
                                  </div>
                                  <div className="p-4 bg-orange-50 rounded-2xl border border-orange-100 flex flex-col justify-center">
                                      <span className="text-[9px] font-black uppercase text-orange-600 tracking-widest mb-1">No Cobrados</span>
                                      <span className="text-2xl font-black text-orange-700 tracking-tighter">${salesBalance.no_cobrado}</span>
                                  </div>
                                  <div className="p-4 bg-rose-50 rounded-2xl border border-rose-100 flex flex-col justify-center">
                                      <span className="text-[9px] font-black uppercase text-rose-600 tracking-widest mb-1">Cancelados</span>
                                      <span className="text-2xl font-black text-rose-700 tracking-tighter">${salesBalance.cancelado}</span>
                                  </div>
                              </div>

                              <div className="flex-1 overflow-y-auto mb-6 border border-slate-100 rounded-2xl p-2 bg-slate-50/50">
                                  <table className="w-full text-left text-xs table-fixed">
                                      <thead className="text-[10px] uppercase font-black text-slate-400 tracking-widest border-b border-slate-100">
                                          <tr>
                                              <th className="pb-3 pl-4 w-1/3 sm:w-1/4">Cliente</th>
                                              <th className="pb-3 w-1/3 sm:w-1/4">Contacto</th>
                                              <th className="pb-3 w-28 sm:w-32">Estado</th>
                                              <th className="pb-3 w-20 sm:w-24">Total</th>
                                              <th className="pb-3 w-10 sm:w-12 text-right pr-4">x</th>
                                          </tr>
                                      </thead>
                                      <tbody className="text-slate-700 font-bold">
                                          {filteredClients.map(c => (
                                              <tr key={c.id} className="border-b border-slate-50 hover:bg-white transition-colors">
                                                  <td className="py-4 pl-4 rounded-l-xl pr-2 overflow-hidden">
                                                      <div className="truncate" title={c.name}>{c.name}</div>
                                                      <div className="text-[9px] font-medium text-slate-400">{c.date}</div>
                                                  </td>
                                                  <td className="py-4 pr-2 truncate" title={c.contact || '-'}>{c.contact || '-'}</td>
                                                  <td className="py-4 pr-2">
                                                      <select 
                                                          value={c.status || 'Completado'} 
                                                          onChange={(e) => {
                                                              setClients(prev => prev.map(item => item.id === c.id ? {...item, status: e.target.value} : item));
                                                              notify("Estado actualizado");
                                                          }}
                                                          className={`p-1.5 rounded-lg text-[10px] font-black uppercase outline-none cursor-pointer border w-full text-ellipsis overflow-hidden ${c.status === 'Pendiente' ? 'bg-amber-100 text-amber-700 border-amber-200' : c.status === 'Cancelado' ? 'bg-rose-100 text-rose-700 border-rose-200' : c.status === 'No Cobrado' ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-emerald-100 text-emerald-700 border-emerald-200'}`}
                                                      >
                                                          <option value="Completado">Hecho</option>
                                                          <option value="Pendiente">Pendiente</option>
                                                          <option value="No Cobrado">No Cobrado</option>
                                                          <option value="Cancelado">Cancelado</option>
                                                      </select>
                                                  </td>
                                                  <td className={`py-4 font-black truncate pr-2 ${c.status === 'Cancelado' ? 'text-slate-400 line-through' : c.status === 'No Cobrado' ? 'text-orange-500' : 'text-emerald-600'}`}>${c.amount}</td>
                                                  <td className="py-4 text-right pr-4 rounded-r-xl"><button onClick={()=>deleteItem(c.id, setClients, 'Cliente')} className="text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button></td>
                                              </tr>
                                          ))}
                                          {filteredClients.length === 0 && <tr><td colSpan="5" className="text-center py-8 text-slate-400 font-medium">No hay ventas registradas en este período.</td></tr>}
                                      </tbody>
                                  </table>
                              </div>
                              <form onSubmit={(e)=>{
                                  e.preventDefault();
                                  const form = e.target;
                                  const contactId = form.elements['contactId'].value;
                                  const contact = contacts.find(c => c.id.toString() === contactId);
                                  
                                  if(!contact) return notify("Por favor, selecciona un contacto");

                                  const newSale = {
                                      id: Date.now(),
                                      name: contact.name,
                                      contact: contact.phone || contact.email || '',
                                      amount: Number(form.elements['amount'].value),
                                      status: form.elements['status'].value,
                                      date: new Date().toISOString().split('T')[0],
                                      completed: false
                                  };
                                  setClients(prev => [...prev, newSale]);
                                  form.reset();
                                  notify("Venta registrada");
                              }} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                  
                                  {/* MODIFICADO: Selector de Contactos para Ventas */}
                                  <div className="md:col-span-6">
                                      <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Seleccionar Contacto *</label>
                                      <select name="contactId" required className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none bg-white border border-slate-200">
                                          <option value="">-- Elige un cliente de tu agenda --</option>
                                          {contacts.map(c => <option key={c.id} value={c.id}>{c.name} {c.phone ? `(${c.phone})` : ''}</option>)}
                                      </select>
                                  </div>

                                  <div className="md:col-span-2"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Monto Total</label><input name="amount" type="number" required className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none" /></div>
                                  <div className="md:col-span-2">
                                      <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Estado Inicial</label>
                                      <select name="status" className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none bg-white">
                                          <option value="Completado">Hecho</option>
                                          <option value="Pendiente">Pendiente</option>
                                          <option value="No Cobrado">No Cobrado</option>
                                          <option value="Cancelado">Cancelado</option>
                                      </select>
                                  </div>
                                  <div className="md:col-span-2">
                                      <button className="w-full py-3 bg-brand text-white rounded-xl font-black uppercase tracking-widest shadow-lg hover:scale-105 transition-transform">Registrar</button>
                                  </div>
                              </form>
                          </div>
                      );
                  })()}

                  {/* --- INSUMOS --- */}
                  {activeTab === 'inventory' && (
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-in h-full">
                          <div className="md:col-span-2 space-y-6 flex flex-col h-full overflow-hidden">
                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col flex-1 overflow-hidden">
                                  <h3 className="text-xl font-black uppercase tracking-tighter mb-6 flex items-center gap-2"><Icons.Box className="w-6 h-6"/> Stock de Materiales</h3>
                                  <div className="flex-1 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-4 content-start pr-2">
                                      {inventory.map(i => (
                                          <div key={i.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-brand transition-all group relative">
                                              <div className="absolute top-3 right-3 flex gap-2">
                                                  <button onClick={() => registerUsage(i, 1)} className="text-slate-300 hover:text-brand bg-white rounded-lg p-1 shadow-sm"><Icons.Minus className="w-3 h-3"/></button>
                                                  <button onClick={()=>deleteItem(i.id, setInventory, 'Item')} className="text-slate-300 hover:text-red-500 bg-white rounded-lg p-1 shadow-sm"><Icons.X className="w-3 h-3"/></button>
                                              </div>
                                              <h4 className="font-black uppercase text-xs mb-1 text-slate-700 pr-12">{i.name}</h4>
                                              <div className="flex gap-3 text-[10px] font-bold uppercase text-slate-500">
                                                  <span>Stock: <span className="text-slate-800 text-sm">{i.qty}</span></span>
                                                  <span>Unit: <span className="text-slate-800 text-sm">${i.price}</span></span>
                                              </div>
                                          </div>
                                      ))}
                                      {inventory.length === 0 && <p className="col-span-full text-center text-xs text-slate-400">No hay materiales en stock.</p>}
                                  </div>
                              </div>

                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                  <div className="flex justify-between items-center mb-4">
                                      <h3 className="text-[10px] font-black uppercase tracking-widest text-slate-400">Métricas de Consumo</h3>
                                      <div className="flex bg-slate-100 rounded-xl p-1">
                                          <button onClick={() => setStatsView('month')} className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase transition-all ${statsView === 'month' ? 'bg-white text-brand shadow-sm' : 'text-slate-400'}`}>Mes</button>
                                          <button onClick={() => setStatsView('year')} className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase transition-all ${statsView === 'year' ? 'bg-white text-brand shadow-sm' : 'text-slate-400'}`}>Año</button>
                                      </div>
                                  </div>
                                  <div className="grid grid-cols-2 gap-6">
                                      <div>
                                          <h4 className="text-[9px] font-bold uppercase text-emerald-500 mb-2">Más Usados</h4>
                                          <ul className="space-y-1">
                                              {inventoryStats[statsView].most.map(([name, count], i) => (
                                                  <li key={i} className="flex justify-between text-xs font-bold text-slate-600 border-b border-slate-50 pb-1"><span>{i+1}. {name}</span><span>{count} u.</span></li>
                                              ))}
                                              {inventoryStats[statsView].most.length === 0 && <li className="text-[9px] text-slate-300">Sin datos</li>}
                                          </ul>
                                      </div>
                                      <div>
                                          <h4 className="text-[9px] font-bold uppercase text-rose-500 mb-2">Menos Usados</h4>
                                          <ul className="space-y-1">
                                              {inventoryStats[statsView].least.map(([name, count], i) => (
                                                  <li key={i} className="flex justify-between text-xs font-bold text-slate-600 border-b border-slate-50 pb-1"><span>{name}</span><span>{count} u.</span></li>
                                              ))}
                                              {inventoryStats[statsView].least.length === 0 && <li className="text-[9px] text-slate-300">Sin datos</li>}
                                          </ul>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <div className="bg-slate-900 p-6 rounded-[2.5rem] text-white shadow-xl flex flex-col justify-center h-fit sticky top-6">
                              <h3 className="text-lg font-black uppercase tracking-widest text-indigo-400 mb-6">Ingreso Inteligente</h3>
                              
                              <div className="space-y-4">
                                  <div>
                                      <label className="text-[9px] font-bold uppercase tracking-widest text-slate-500">Material</label>
                                      <input 
                                          value={invInput.name} 
                                          onChange={e => setInvInput({...invInput, name: e.target.value})} 
                                          placeholder="Ej. Resina Epóxica" 
                                          className="w-full p-3 rounded-xl bg-white/10 border border-white/10 mt-1 text-white font-bold text-xs focus:bg-white/20 transition-colors outline-none"
                                      />
                                  </div>

                                  <div className="grid grid-cols-2 gap-4">
                                      <div>
                                          <label className="text-[9px] font-bold uppercase tracking-widest text-slate-500">Costo Total ($)</label>
                                          <input 
                                              type="number" 
                                              value={invInput.totalCost} 
                                              onChange={e => setInvInput({...invInput, totalCost: parseFloat(e.target.value) || 0})} 
                                              className="w-full p-3 rounded-xl bg-white/10 border border-white/10 mt-1 text-white font-bold text-xs focus:bg-white/20 transition-colors outline-none"
                                          />
                                      </div>
                                      <div>
                                          <label className="text-[9px] font-bold uppercase tracking-widest text-slate-500">Cant. Comprada</label>
                                          <input 
                                              type="number" 
                                              value={invInput.totalQty} 
                                              onChange={e => setInvInput({...invInput, totalQty: parseFloat(e.target.value) || 1})} 
                                              className="w-full p-3 rounded-xl bg-white/10 border border-white/10 mt-1 text-white font-bold text-xs focus:bg-white/20 transition-colors outline-none"
                                          />
                                      </div>
                                  </div>

                                  <div>
                                      <label className="text-[9px] font-bold uppercase tracking-widest text-slate-500">Tamaño de Porción / Uso (Opcional)</label>
                                      <div className="flex items-center gap-2 mt-1">
                                          <input 
                                              type="number" 
                                              value={invInput.portion} 
                                              onChange={e => setInvInput({...invInput, portion: parseFloat(e.target.value) || 1})} 
                                              className="flex-1 p-3 rounded-xl bg-white/10 border border-white/10 text-white font-bold text-xs focus:bg-white/20 transition-colors outline-none"
                                          />
                                          <span className="text-[10px] uppercase font-bold text-slate-500">Unidades</span>
                                      </div>
                                      <p className="text-[9px] text-slate-400 mt-1">Ej: Si compraste 1000ml y usas de a 50ml, pon 50.</p>
                                  </div>

                                  <div className="p-4 bg-indigo-900/50 rounded-2xl border border-indigo-500/30">
                                      <div className="flex justify-between items-end mb-2">
                                          <span className="text-[9px] font-black uppercase text-indigo-300 tracking-widest">Costo x Porción</span>
                                          <span className="text-2xl font-black text-white tracking-tighter">${calculatedUnitCost}</span>
                                      </div>
                                      <div className="flex justify-between items-end">
                                          <span className="text-[9px] font-black uppercase text-indigo-300 tracking-widest">Stock Resultante</span>
                                          <span className="text-sm font-bold text-white">{calculatedStock} u.</span>
                                      </div>
                                  </div>

                                  <button 
                                      onClick={() => {
                                          if(!invInput.name) return notify("Falta nombre");
                                          const newItem = {
                                              id: Date.now(),
                                              name: invInput.name,
                                              qty: calculatedStock,
                                              price: parseFloat(calculatedUnitCost)
                                          };
                                          setInventory(prev => [...prev, newItem]);
                                          setInvInput({ name: '', totalCost: '', totalQty: '', portion: 1 });
                                          notify("Material Calculado y Guardado");
                                      }}
                                      className="w-full py-4 bg-brand text-white rounded-xl font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-lg"
                                  >
                                      Guardar en Stock
                                  </button>
                              </div>
                          </div>
                      </div>
                  )}

                  {/* --- WORKSHOP (CHECKLIST) --- */}
                  {activeTab === 'checklist' && (() => {
                      const calculateAvg = (period) => {
                          if (!tasks.length) return 0;
                          const dates = tasks.map(t => new Date(t.date).getTime());
                          const firstDate = Math.min(...dates);
                          const daysDiff = Math.max(1, (new Date().getTime() - firstDate) / (1000 * 3600 * 24));
                          let divisor = 1;
                          if (period === 'week') divisor = 7;
                          if (period === 'month') divisor = 30;
                          if (period === 'year') divisor = 365;
                          return (tasks.length / (daysDiff / divisor)).toFixed(1);
                      };

                      return (
                          <div className="flex flex-col h-full animate-in">
                              <div className="flex justify-between items-end mb-6">
                                  <div>
                                      <h3 className="text-2xl font-black uppercase tracking-tighter">Taller de Producción</h3>
                                      <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Estado de los trabajos actuales</p>
                                  </div>
                                  <form onSubmit={(e)=>saveEntity(e, setTasks, 'Tarea')} className="flex gap-2">
                                      <input name="name" placeholder="Nuevo Trabajo..." required className="p-3 rounded-xl bg-white border border-slate-200 shadow-sm text-xs font-bold w-64 outline-none"/>
                                      <button className="p-3 bg-dark text-white rounded-xl shadow-lg hover:scale-105 transition-transform"><Icons.Plus className="w-4 h-4"/></button>
                                  </form>
                              </div>

                              {/* MÉTRICAS DE PROMEDIO */}
                              <div className="grid grid-cols-3 gap-4 mb-6">
                                  <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                                      <span className="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-1">Prom. Semanal</span>
                                      <span className="text-2xl font-black text-brand tracking-tighter">{calculateAvg('week')}</span>
                                  </div>
                                  <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                                      <span className="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-1">Prom. Mensual</span>
                                      <span className="text-2xl font-black text-brand tracking-tighter">{calculateAvg('month')}</span>
                                  </div>
                                  <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                                      <span className="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-1">Prom. Anual</span>
                                      <span className="text-2xl font-black text-brand tracking-tighter">{calculateAvg('year')}</span>
                                  </div>
                              </div>

                              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-y-auto pb-6">
                                  <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                      <h4 className="text-[10px] font-black uppercase text-amber-500 tracking-[0.2em] mb-4 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-amber-500"></div> En Proceso</h4>
                                      <div className="space-y-3">
                                          {tasks.filter(t => !t.completed).map(t => (
                                              <div key={t.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex items-center justify-between group">
                                                  <span className="font-bold text-xs uppercase text-slate-700">{t.name}</span>
                                                  <div className="flex gap-2">
                                                      <button onClick={() => {setTasks(prev => prev.map(i => i.id === t.id ? { ...i, completed: true } : i)); notify("Tarea completada")}} className="p-2 bg-white text-emerald-500 rounded-lg shadow-sm hover:scale-110 transition-transform"><Icons.CheckCircle2 className="w-4 h-4"/></button>
                                                      <button onClick={() => deleteItem(t.id, setTasks, 'Tarea')} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                                  </div>
                                              </div>
                                          ))}
                                          {tasks.filter(t => !t.completed).length === 0 && <p className="text-center text-xs text-slate-400 py-10">¡Todo al día! Buen trabajo.</p>}
                                      </div>
                                  </div>
                                  <div className="bg-slate-100 p-6 rounded-[2.5rem] border border-slate-200 shadow-inner opacity-80">
                                      <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] mb-4 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-slate-400"></div> Finalizado</h4>
                                      <div className="space-y-3">
                                          {tasks.filter(t => t.completed).map(t => (
                                              <div key={t.id} className="p-4 bg-white/50 rounded-2xl border border-white flex items-center justify-between">
                                                  <span className="font-bold text-xs uppercase text-slate-400 line-through">{t.name}</span>
                                                  <button onClick={() => deleteItem(t.id, setTasks, 'Tarea')} className="p-2 text-slate-300 hover:text-slate-500"><Icons.X className="w-4 h-4"/></button>
                                              </div>
                                          ))}
                                      </div>
                                  </div>
                              </div>
                          </div>
                      );
                  })()}

                  {/* --- CALCULADORA --- */}
                  {activeTab === 'calculator' && (
                      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in pb-10">
                          <div className="lg:col-span-2 space-y-6">
                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                  <h3 className="text-lg font-black uppercase mb-6 flex items-center gap-2"><Icons.Settings className="w-5 h-5"/> Configuración Base</h3>
                                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                      {['hourlyRate:Valor Hora','opExpenses:Gastos Fijos','profitMargin:% Ganancia','wastePercent:% Desperdicio','taxesPercent:% Impuestos','inkPercent:% Tinta'].map(f => {
                                          const [k, l] = f.split(':');
                                          return (
                                              <div key={k}><label className="text-[9px] font-bold uppercase text-slate-400 ml-1">{l}</label><input type="number" value={calc[k]} onChange={e => setCalc({...calc, [k]: parseFloat(e.target.value)||0})} className="w-full p-3 rounded-xl bg-slate-50 text-xs font-black text-slate-700 outline-none focus:ring-2 ring-brand/20 transition-all"/></div>
                                          )
                                      })}
                                  </div>
                              </div>
                              
                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                  <h3 className="text-lg font-black uppercase mb-6 flex items-center gap-2"><Icons.Package className="w-5 h-5"/> Materiales del Proyecto</h3>
                                  <div className="flex gap-4 mb-6 items-end">
                                      <div className="flex-1">
                                          <label className="text-[9px] font-bold uppercase text-slate-400 ml-1">Seleccionar Material</label>
                                          <select value={calc.selectedMaterialId} onChange={e => setCalc({...calc, selectedMaterialId: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 text-xs font-bold outline-none">
                                              <option value="">-- Elegir --</option>
                                              {materialDb.map(m => <option key={m.id} value={m.id}>{m.name} (${m.price})</option>)}
                                          </select>
                                      </div>
                                      <div className="w-24">
                                          <label className="text-[9px] font-bold uppercase text-slate-400 ml-1">Cant.</label>
                                          <input type="number" value={calc.materialQty} onChange={e => setCalc({...calc, materialQty: parseFloat(e.target.value)||1})} className="w-full p-3 rounded-xl bg-slate-50 text-xs font-black outline-none" />
                                      </div>
                                  </div>
                                  <form onSubmit={addMaterialToDb} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex gap-2 items-center">
                                      <input name="name" placeholder="Nuevo Material (ej. Papel Fotográfico)" className="flex-1 p-2 bg-white rounded-lg text-xs font-bold outline-none" />
                                      <input name="price" type="number" placeholder="$ Precio" className="w-20 p-2 bg-white rounded-lg text-xs font-bold outline-none" />
                                      <button className="p-2 bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-widest hover:bg-brand transition-colors">Guardar DB</button>
                                  </form>
                              </div>

                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                  <h3 className="text-lg font-black uppercase mb-6 flex items-center gap-2"><Icons.Zap className="w-5 h-5"/> Tiempo & Extras</h3>
                                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                      {['designHours:Hs Diseño','cuttingHours:Hs Corte','assemblyHours:Hs Armado','assemblyCost:$ Insumos Armado'].map(f => {
                                          const [k, l] = f.split(':');
                                          return (
                                              <div key={k}><label className="text-[9px] font-bold uppercase text-slate-400 ml-1">{l}</label><input type="number" value={calc[k]} onChange={e => setCalc({...calc, [k]: parseFloat(e.target.value)||0})} className="w-full p-3 rounded-xl bg-slate-50 text-xs font-black text-slate-700 outline-none focus:ring-2 ring-brand/20 transition-all"/></div>
                                          )
                                      })}
                                  </div>
                              </div>
                          </div>

                          <div className="bg-dark p-8 rounded-[3rem] text-white shadow-2xl relative overflow-hidden flex flex-col justify-center text-center h-fit sticky top-6">
                              <div className="absolute top-0 right-0 p-10 opacity-5"><Icons.DollarSign className="w-64 h-64" /></div>
                              <h2 className="text-xs font-black uppercase tracking-[0.4em] text-indigo-400 mb-2 relative z-10">Costo Estimado</h2>
                              <p className="text-3xl font-bold text-slate-400 mb-8 relative z-10">${proCalcResult.cost.toFixed(2)}</p>
                              
                              <div className="w-full h-px bg-white/10 mb-8 relative z-10"></div>
                              
                              <h2 className="text-sm font-black uppercase tracking-[0.4em] text-brand mb-4 relative z-10">Precio Sugerido</h2>
                              <p className="text-6xl font-black tracking-tighter mb-2 relative z-10">${proCalcResult.final.toFixed(2)}</p>
                              <p className="text-[10px] font-bold uppercase tracking-widest opacity-50 relative z-10">Incluye {calc.profitMargin}% ganancia</p>
                          </div>
                      </div>
                  )}
                  
                  {/* --- TIENDA DIGITAL --- */}
                  {activeTab === 'store' && (
                      <div className="space-y-6 animate-in pb-10">
                          <div className="flex justify-between items-center mb-6">
                              <div>
                                  <h3 className="text-2xl font-black uppercase tracking-tighter">Tienda Digital</h3>
                                  <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Recursos y plantillas premium</p>
                              </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                              {digitalProducts.map(p => (
                                  <div key={p.id} className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col justify-between relative group">
                                      {isAdmin && (
                                          <button onClick={() => {
                                              setDigitalProducts(digitalProducts.filter(i => i.id !== p.id));
                                              notify("Producto eliminado");
                                          }} className="absolute top-4 right-4 p-2 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-100 opacity-0 group-hover:opacity-100 transition-opacity z-10"><Icons.Trash2 className="w-4 h-4"/></button>
                                      )}
                                      <div>
                                          {p.imageUrl ? (
                                              <img src={p.imageUrl} alt={p.title} className="w-full h-40 object-cover rounded-2xl mb-4 border border-slate-100 shadow-sm" onError={(e) => { e.target.style.display='none'; }} />
                                          ) : (
                                              <div className="w-16 h-16 bg-brand/10 text-brand rounded-2xl flex items-center justify-center mb-4">
                                                  <Icons.ShoppingBag className="w-8 h-8"/>
                                              </div>
                                          )}
                                          <h4 className="font-black text-lg text-slate-800 leading-tight mb-2">{p.title}</h4>
                                          <p className="text-xs text-slate-500 mb-4">{p.desc}</p>
                                      </div>
                                      <div className="flex flex-col gap-2 mt-4 pt-4 border-t border-slate-50">
                                          <div className="flex justify-between items-center mb-1">
                                               <span className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Valor</span>
                                               <span className="font-black text-xl text-emerald-600">${p.price}</span>
                                          </div>
                                          <div className="grid grid-cols-2 gap-2">
                                               <a href={p.link} target="_blank" className="flex items-center justify-center py-2 bg-slate-900 text-white text-[9px] font-black uppercase tracking-widest rounded-xl hover:scale-105 transition-transform">1. Pagar</a>
                                               <a href={`https://wa.me/59892617525?text=Hola!%20Acabo%20de%20pagar%20el%20producto%20%2A${encodeURIComponent(p.title)}%2A.%20Te%20adjunto%20el%20comprobante%20para%20recibir%20el%20archivo:`} target="_blank" className="flex items-center justify-center gap-1 py-2 bg-[#25D366] text-white text-[9px] font-black uppercase tracking-widest rounded-xl hover:scale-105 transition-transform"><Icons.MessageCircle className="w-3 h-3"/> 2. Archivo</a>
                                          </div>
                                      </div>
                                  </div>
                              ))}
                              {digitalProducts.length === 0 && <p className="col-span-full text-center py-10 text-slate-400 font-medium">No hay productos disponibles por el momento.</p>}
                          </div>

                          {isAdmin && (
                              <div className="bg-slate-50 p-6 rounded-[2.5rem] border border-slate-100 shadow-inner mt-8">
                                  <h4 className="text-xs font-black uppercase text-slate-400 tracking-widest mb-4"><Icons.PlusCircle className="w-4 h-4 inline-block mr-1"/> Agregar Nuevo Producto</h4>
                                  <form onSubmit={(e) => {
                                      e.preventDefault();
                                      const formData = new FormData(e.target);
                                      const newProduct = {
                                          id: Date.now(),
                                          title: formData.get('title'),
                                          desc: formData.get('desc'),
                                          price: Number(formData.get('price')),
                                          link: formData.get('link'),
                                          imageUrl: formData.get('imageUrl')
                                      };
                                      setDigitalProducts([...digitalProducts, newProduct]);
                                      e.target.reset();
                                      notify("Producto publicado");
                                  }} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <input name="title" required placeholder="Título del producto..." className="p-3 rounded-xl shadow-sm text-xs font-bold outline-none" />
                                      <input name="price" type="number" required placeholder="Precio ($)" className="p-3 rounded-xl shadow-sm text-xs font-bold outline-none" />
                                      <input name="desc" required placeholder="Descripción breve..." className="p-3 rounded-xl shadow-sm text-xs font-bold outline-none" />
                                      <input name="link" required placeholder="URL de compra o descarga (Link de pago)..." className="p-3 rounded-xl shadow-sm text-xs font-bold outline-none" />
                                      <input name="imageUrl" placeholder="URL de la imagen (Opcional, ej: https://tuweb.com/foto.jpg)" className="p-3 rounded-xl shadow-sm text-xs font-bold outline-none md:col-span-2" />
                                      <div className="md:col-span-2 flex justify-end">
                                          <button className="px-8 py-3 bg-brand text-white rounded-xl font-black uppercase tracking-widest shadow-lg hover:scale-105 transition-transform">Publicar Archivo</button>
                                      </div>
                                  </form>
                              </div>
                          )}
                      </div>
                  )}

                  {/* --- FACTURACIÓN Y PRESUPUESTOS --- */}
                  {(activeTab === 'presupuestos' || activeTab === 'facturas') && (
                      <div className="h-full flex flex-col animate-in">
                          {/* HEADER DE CONTROL */}
                          <div className="flex justify-between items-center mb-6 no-print">
                              <h3 className="text-2xl font-black uppercase tracking-tighter">
                                  {activeTab === 'presupuestos' ? 'Gestor de Presupuestos' : 'Facturación'}
                              </h3>
                              <div className="flex gap-2">
                                  <button onClick={() => { activeTab === 'presupuestos' ? setIsCreatingBudget(false) : setIsCreatingInvoice(false) }} className="px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold uppercase hover:bg-slate-50">Historial</button>
                                  <button onClick={() => { activeTab === 'presupuestos' ? setIsCreatingBudget(true) : setIsCreatingInvoice(true) }} className="px-4 py-2 bg-brand text-white rounded-xl text-xs font-bold uppercase shadow-lg hover:scale-105 transition-transform flex gap-2 items-center"><Icons.Plus className="w-4 h-4"/> Nuevo</button>
                              </div>
                          </div>

                          {/* MODO CREACIÓN / EDICIÓN */}
                          {((activeTab === 'presupuestos' && isCreatingBudget) || (activeTab === 'facturas' && isCreatingInvoice)) ? (
                              <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 max-w-4xl mx-auto w-full relative">
                                  <div className="absolute top-6 right-6 no-print">
                                      <button onClick={() => window.print()} className="p-3 bg-slate-900 text-white rounded-xl hover:scale-110 transition-transform shadow-lg"><Icons.Printer className="w-5 h-5"/></button>
                                  </div>

                                  {/* CABECERA DOCUMENTO */}
                                  <div className="flex justify-between items-start mb-10 pb-10 border-b-2 border-slate-100">
                                      <div className="flex items-center gap-4 flex-1">
                                          <div className="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center overflow-hidden border border-slate-200 relative group shrink-0">
                                              {userProfile.logo ? 
                                                  <img src={userProfile.logo} className="w-full h-full object-cover" /> : 
                                                  <span className="text-[9px] uppercase font-bold text-slate-400 text-center p-2">Subir Logo</span>
                                              }
                                              <input type="file" onChange={(e) => {
                                                  const file = e.target.files[0];
                                                  if (file) {
                                                      const reader = new FileReader();
                                                      reader.onloadend = () => setUserProfile(p => ({...p, logo: reader.result}));
                                                      reader.readAsDataURL(file);
                                                  }
                                              }} className="absolute inset-0 opacity-0 cursor-pointer no-print" title="Subir Logo" />
                                          </div>
                                          <div className="flex-1 pr-4">
                                              {userEmail === ADMIN_EMAIL ? (
                                                  <>
                                                      <h1 className="text-3xl font-black uppercase tracking-tighter text-slate-900">MC PRO</h1>
                                                      <p className="text-xs font-bold uppercase tracking-widest text-slate-400">Modo Creativo Design</p>
                                                  </>
                                              ) : (
                                                  <div className="flex flex-col">
                                                      <input 
                                                          value={userProfile.brand || ''} 
                                                          onChange={(e) => setUserProfile({...userProfile, brand: e.target.value})} 
                                                          placeholder="NOMBRE DE TU MARCA" 
                                                          className="text-3xl font-black uppercase tracking-tighter text-slate-900 outline-none bg-transparent placeholder:text-slate-300 w-full"
                                                      />
                                                      <input 
                                                          value={userProfile.owner || ''} 
                                                          onChange={(e) => setUserProfile({...userProfile, owner: e.target.value})} 
                                                          placeholder="Tu Nombre o Eslogan" 
                                                          className="text-xs font-bold uppercase tracking-widest text-slate-400 outline-none bg-transparent placeholder:text-slate-300 w-full"
                                                      />
                                                  </div>
                                              )}
                                          </div>
                                      </div>
                                      <div className="text-right">
                                          <h2 className="text-4xl font-black text-slate-200 uppercase tracking-tighter mb-2">{activeTab === 'presupuestos' ? 'PRESUPUESTO' : 'FACTURA'}</h2>
                                          <div className="flex flex-col items-end gap-1">
                                              <input value={activeTab==='presupuestos' ? currentBudget.number : currentInvoice.number} onChange={(e) => activeTab==='presupuestos' ? handleBudgetChange('number', e.target.value) : handleInvoiceChange('number', e.target.value)} placeholder="N° 001" className="text-right font-black text-xl uppercase outline-none w-32 bg-transparent" />
                                              <input type="date" value={activeTab==='presupuestos' ? currentBudget.date : currentInvoice.date} onChange={(e) => activeTab==='presupuestos' ? handleBudgetChange('date', e.target.value) : handleInvoiceChange('date', e.target.value)} className="text-right text-xs font-bold text-slate-500 outline-none bg-transparent" />
                                          </div>
                                      </div>
                                  </div>

                                  {/* DATOS CLIENTE */}
                                  <div className="mb-8 p-6 bg-slate-50 rounded-2xl border border-slate-100 flex flex-col gap-3">
                                      <div className="flex justify-between items-center">
                                          <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest block">Cliente</label>
                                          <select onChange={(e) => {
                                              const contact = contacts.find(c => c.id.toString() === e.target.value);
                                              if(contact) {
                                                  activeTab === 'presupuestos' ? handleBudgetChange('client', contact.name) : handleInvoiceChange('client', contact.name);
                                              }
                                              e.target.value = "";
                                          }} className="text-[9px] font-bold text-brand uppercase outline-none bg-transparent cursor-pointer hover:underline text-right no-print">
                                              <option value="">+ Cargar desde Contactos</option>
                                              {contacts.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                          </select>
                                      </div>
                                      <input value={activeTab==='presupuestos' ? currentBudget.client : currentInvoice.client} onChange={(e) => activeTab==='presupuestos' ? handleBudgetChange('client', e.target.value) : handleInvoiceChange('client', e.target.value)} placeholder="Nombre del Cliente..." className="w-full bg-transparent text-xl font-bold text-slate-800 outline-none placeholder:text-slate-300" />
                                  </div>

                                  {/* ITEMS */}
                                  <div className="mb-8">
                                      <div className="grid grid-cols-12 gap-4 pb-2 border-b border-slate-200 text-[10px] font-black uppercase text-slate-400 tracking-widest pl-2">
                                          <div className="col-span-6">Descripción</div>
                                          <div className="col-span-2 text-center">Cant.</div>
                                          <div className="col-span-2 text-right">Precio U.</div>
                                          <div className="col-span-2 text-right">Total</div>
                                      </div>
                                      <div className="space-y-2 mt-2">
                                          {(activeTab==='presupuestos' ? currentBudget.items : currentInvoice.items).map((item, index) => (
                                              <div key={item.id} className="grid grid-cols-12 gap-4 items-center group">
                                                  <div className="col-span-6">
                                                      <input value={item.desc} onChange={(e) => activeTab==='presupuestos' ? updateBudgetItem(item.id, 'desc', e.target.value) : updateInvItem(item.id, 'desc', e.target.value)} placeholder="Item..." className="w-full p-2 rounded-lg hover:bg-slate-50 font-bold text-sm outline-none" />
                                                  </div>
                                                  <div className="col-span-2">
                                                      <input type="number" value={item.qty} onChange={(e) => activeTab==='presupuestos' ? updateBudgetItem(item.id, 'qty', parseInt(e.target.value)||0) : updateInvItem(item.id, 'qty', parseInt(e.target.value)||0)} className="w-full p-2 text-center rounded-lg hover:bg-slate-50 font-bold text-sm outline-none" />
                                                  </div>
                                                  <div className="col-span-2 text-right">
                                                      <input type="number" value={item.price} onChange={(e) => activeTab==='presupuestos' ? updateBudgetItem(item.id, 'price', parseFloat(e.target.value)||0) : updateInvItem(item.id, 'price', parseFloat(e.target.value)||0)} className="w-full p-2 text-right rounded-lg hover:bg-slate-50 font-bold text-sm outline-none" />
                                                  </div>
                                                  <div className="col-span-2 text-right font-black text-slate-800 pr-2">
                                                      ${(item.qty * item.price).toFixed(2)}
                                                  </div>
                                              </div>
                                          ))}
                                      </div>
                                      <div className="mt-4 flex gap-2 items-center no-print">
                                          <button onClick={activeTab==='presupuestos' ? addBudgetItem : addInvItem} className="px-4 py-2 bg-slate-100 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-200">Agregar Ítem Manual</button>
                                          <select onChange={(e) => {
                                              const invItem = inventory.find(i => i.id.toString() === e.target.value);
                                              if(invItem) {
                                                  const newItem = { id: Date.now(), desc: invItem.name, qty: 1, price: invItem.price };
                                                  if (activeTab === 'presupuestos') setCurrentBudget(prev => ({ ...prev, items: [...prev.items, newItem] }));
                                                  else setCurrentInvoice(prev => ({ ...prev, items: [...prev.items, newItem] }));
                                              }
                                              e.target.value = "";
                                          }} className="px-4 py-2 bg-rose-50 text-brand rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-rose-100 outline-none cursor-pointer">
                                              <option value="">+ Cargar desde Insumos</option>
                                              {inventory.map(i => <option key={i.id} value={i.id}>{i.name} (${i.price})</option>)}
                                          </select>
                                      </div>
                                  </div>

                                  {/* TOTALES */}
                                  <div className="flex justify-end pt-6 border-t-2 border-slate-100">
                                      <div className="w-64">
                                          <div className="flex justify-between items-end">
                                              <span className="text-xs font-black uppercase text-slate-400 tracking-widest">Total Final</span>
                                              <span className="text-4xl font-black text-slate-900 tracking-tighter">
                                                  ${(activeTab==='presupuestos' ? currentBudget.items : currentInvoice.items).reduce((a, b) => a + (b.qty * b.price), 0).toFixed(2)}
                                              </span>
                                          </div>
                                      </div>
                                  </div>
                                  <div className="mt-12 text-center text-[10px] uppercase font-bold text-slate-300 tracking-[0.3em]">Gracias por su confianza</div>
                              </div>
                          ) : (
                              <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex-1 flex flex-col justify-center items-center text-slate-300">
                                  <Icons.FileText className="w-16 h-16 mb-4 opacity-50"/>
                                  <p className="font-bold uppercase tracking-widest text-xs">Selecciona "Nuevo" para comenzar</p>
                              </div>
                          )}
                      </div>
                  )}

                  {/* --- ENVÍOS --- */}
                  {activeTab === 'shipping' && (
                      <div className="h-full flex flex-col animate-in relative">
                          <div className={`bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full no-print`}>
                              <div className="flex justify-between items-center mb-6">
                                  <h3 className="text-xl font-black uppercase tracking-tighter flex items-center gap-2"><Icons.Truck className="w-6 h-6"/> Control de Envíos</h3>
                              </div>
                              <div className="flex-1 overflow-y-auto space-y-3 mb-6 pr-2">
                                  {shipping.map(s => {
                                      const isExpanded = selectedLabel && selectedLabel.id === s.id;
                                      return (
                                      <div key={s.id} onClick={() => setSelectedLabel(isExpanded ? null : s)} className={`p-4 bg-slate-50 rounded-2xl border transition-all cursor-pointer hover:border-brand/50 ${isExpanded ? 'border-brand shadow-md' : 'border-slate-100'}`}>
                                          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                              <div>
                                                  <h4 className="font-black uppercase text-sm text-slate-800">{s.name}</h4>
                                                  <div className="flex flex-wrap gap-2 mt-1 text-[10px] font-bold text-slate-500 uppercase">
                                                      <span className="bg-white px-2 py-1 rounded shadow-sm border border-slate-100">📞 {s.phone || 'S/D'}</span>
                                                      <span className="bg-white px-2 py-1 rounded shadow-sm border border-slate-100">📍 {s.address || 'S/D'}, {s.department || 'S/D'}</span>
                                                  </div>
                                                  <div className="flex gap-4 mt-2 text-xs">
                                                      <p className="font-bold text-slate-500 uppercase tracking-wide">{s.agency || 'Agencia S/D'}</p>
                                                      <p className="font-bold text-slate-500 uppercase">Tracking: <span className="font-mono bg-white px-2 py-0.5 rounded border border-slate-200 select-all">{s.track}</span></p>
                                                  </div>
                                              </div>
                                              <div className="flex items-center gap-3">
                                                  <button onClick={(e) => { e.stopPropagation(); setSelectedLabel(isExpanded ? null : s); }} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-transform shadow-sm flex items-center gap-2 ${isExpanded ? 'bg-slate-900 text-white' : 'bg-brand text-white hover:scale-105'}`}>
                                                      <Icons.Printer className="w-3 h-3"/> {isExpanded ? 'Ocultar' : 'Etiqueta'}
                                                  </button>
                                                  <a href={`https://www.google.com/search?q=${s.track}`} target="_blank" onClick={(e) => e.stopPropagation()} className="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-900 hover:text-white transition-colors">Rastrear</a>
                                                  <button onClick={(e)=>{ e.stopPropagation(); deleteItem(s.id, setShipping, 'Envío'); }} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                              </div>
                                          </div>
                                          
                                          {/* Despliegue de Etiqueta (Preview) */}
                                          {isExpanded && (
                                              <div className="mt-6 pt-6 border-t border-slate-200 animate-in slide-in-from-top-2" onClick={(e) => e.stopPropagation()}>
                                                  <div className="bg-white border-[4px] border-slate-900 rounded-3xl p-6 shadow-sm max-w-md mx-auto">
                                                      <div className="flex justify-between items-center border-b-[4px] border-slate-900 pb-4 mb-4">
                                                          <div>
                                                              <h1 className="text-2xl font-black uppercase tracking-tighter leading-none">{userProfile.brand || 'MC PRO'}</h1>
                                                              <p className="text-[9px] font-black uppercase tracking-widest text-slate-500 mt-1">Etiqueta de Envío</p>
                                                          </div>
                                                          {userProfile.logo ? <img src={userProfile.logo} className="w-12 h-12 object-cover rounded-lg border-2 border-slate-200 grayscale" /> : <Icons.Package className="w-10 h-10 text-slate-400" />}
                                                      </div>
                                                      <div className="space-y-4">
                                                          <div>
                                                              <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Destinatario</p>
                                                              <p className="text-2xl font-black uppercase leading-none text-slate-900">{s.name}</p>
                                                          </div>
                                                          <div className="grid grid-cols-2 gap-4">
                                                              <div>
                                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Teléfono</p>
                                                                  <p className="text-base font-bold leading-none text-slate-900">{s.phone}</p>
                                                              </div>
                                                              <div>
                                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Departamento</p>
                                                                  <p className="text-base font-bold uppercase leading-none text-slate-900">{s.department}</p>
                                                              </div>
                                                          </div>
                                                          <div>
                                                              <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Dirección</p>
                                                              <p className="text-base font-bold leading-tight text-slate-900">{s.address}</p>
                                                          </div>
                                                          <div className="border-t-[4px] border-slate-900 pt-4 grid grid-cols-2 gap-4">
                                                              <div>
                                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Agencia / Courier</p>
                                                                  <p className="text-xl font-black uppercase leading-none text-slate-900">{s.agency}</p>
                                                              </div>
                                                              <div>
                                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Tracking N°</p>
                                                                  <p className="text-xl font-black uppercase leading-none text-slate-900">{s.track}</p>
                                                              </div>
                                                          </div>
                                                      </div>
                                                  </div>
                                                  <div className="mt-6 flex justify-center">
                                                      <button onClick={() => window.print()} className="px-8 py-4 bg-brand text-white rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-105 transition-transform flex items-center gap-3"><Icons.Printer className="w-5 h-5"/> Imprimir Esta Etiqueta</button>
                                                  </div>
                                              </div>
                                          )}
                                      </div>
                                  )})}
                                  {shipping.length === 0 && <p className="text-center py-10 text-slate-400 font-medium">No hay envíos pendientes.</p>}
                              </div>
                              <form onSubmit={(e)=>saveEntity(e, setShipping, 'Envío')} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex flex-col gap-4">
                                  
                                  {/* MODIFICADO: AUTOCOMPLETE DESDE CONTACTOS */}
                                  <div className="bg-white p-3 rounded-xl border border-brand/20 shadow-sm flex items-center gap-3">
                                      <Icons.User className="w-4 h-4 text-brand shrink-0" />
                                      <div className="flex-1">
                                          <label className="text-[9px] font-black uppercase text-brand tracking-widest block mb-1">Cargar datos desde Contactos</label>
                                          <select onChange={(e) => {
                                              const contact = contacts.find(c => c.id.toString() === e.target.value);
                                              if(contact) {
                                                  const form = e.target.closest('form');
                                                  if(form.elements['name']) form.elements['name'].value = contact.name || '';
                                                  if(form.elements['phone']) form.elements['phone'].value = contact.phone || '';
                                                  if(form.elements['address']) form.elements['address'].value = contact.address || '';
                                                  if(form.elements['department']) form.elements['department'].value = contact.department || '';
                                              }
                                              e.target.value = ""; 
                                          }} className="w-full text-xs font-bold text-slate-700 outline-none bg-transparent cursor-pointer">
                                              <option value="">-- Seleccionar un contacto registrado --</option>
                                              {contacts.map(c => <option key={c.id} value={c.id}>{c.name} {c.phone ? `(${c.phone})` : ''}</option>)}
                                          </select>
                                      </div>
                                  </div>

                                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                      <div>
                                          <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Destinatario</label>
                                          <input name="name" required placeholder="Nombre..." className="w-full p-3 rounded-xl shadow-sm text-xs font-bold outline-none mt-1"/>
                                      </div>
                                      <div>
                                          <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Teléfono</label>
                                          <input name="phone" required placeholder="Celular..." className="w-full p-3 rounded-xl shadow-sm text-xs font-bold outline-none mt-1"/>
                                      </div>
                                      <div>
                                          <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Dirección</label>
                                          <input name="address" required placeholder="Calle y N°..." className="w-full p-3 rounded-xl shadow-sm text-xs font-bold outline-none mt-1"/>
                                      </div>
                                      <div>
                                          <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Departamento</label>
                                          <input name="department" required placeholder="Ej: Montevideo..." className="w-full p-3 rounded-xl shadow-sm text-xs font-bold outline-none mt-1"/>
                                      </div>
                                  </div>
                                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                      <div>
                                          <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Agencia / Courier</label>
                                          <select name="agency" required className="w-full p-3 rounded-xl shadow-sm text-xs font-bold outline-none mt-1 bg-white">
                                              <option value="">Seleccionar...</option>
                                              {COURIERS.map(c => <option key={c} value={c}>{c}</option>)}
                                          </select>
                                      </div>
                                      <div>
                                          <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Tracking</label>
                                          <input name="track" required placeholder="N°..." className="w-full p-3 rounded-xl shadow-sm text-xs font-bold outline-none mt-1"/>
                                      </div>
                                      <button className="w-full p-3 bg-slate-900 text-white rounded-xl font-black uppercase tracking-widest shadow-lg hover:scale-105 transition-transform">Despachado</button>
                                  </div>
                              </form>
                          </div>

                          {/* ZONA DE IMPRESIÓN (ETIQUETA) */}
                          {selectedLabel && (
                              <div className="hidden print:flex print-area absolute inset-0 bg-white items-center justify-center p-0 m-0 z-[9999]">
                                  <div className="w-[10cm] border-[4px] border-slate-900 rounded-3xl p-6 text-slate-900 bg-white inline-block">
                                      <div className="flex justify-between items-center border-b-[4px] border-slate-900 pb-4 mb-4">
                                          <div>
                                              <h1 className="text-2xl font-black uppercase tracking-tighter leading-none">{userProfile.brand || 'MC PRO'}</h1>
                                              <p className="text-[9px] font-black uppercase tracking-widest text-slate-500 mt-1">Etiqueta de Envío</p>
                                          </div>
                                          {userProfile.logo ? <img src={userProfile.logo} className="w-12 h-12 object-cover rounded-lg border-2 border-slate-200 grayscale" /> : <Icons.Package className="w-10 h-10 text-slate-400" />}
                                      </div>
                                      
                                      <div className="space-y-4">
                                          <div>
                                              <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Destinatario</p>
                                              <p className="text-2xl font-black uppercase leading-none">{selectedLabel.name}</p>
                                          </div>
                                          <div className="grid grid-cols-2 gap-4">
                                              <div>
                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Teléfono</p>
                                                  <p className="text-base font-bold leading-none">{selectedLabel.phone}</p>
                                              </div>
                                              <div>
                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Departamento</p>
                                                  <p className="text-base font-bold uppercase leading-none">{selectedLabel.department}</p>
                                              </div>
                                          </div>
                                          <div>
                                              <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Dirección</p>
                                              <p className="text-base font-bold leading-tight">{selectedLabel.address}</p>
                                          </div>
                                          <div className="border-t-[4px] border-slate-900 pt-4 grid grid-cols-2 gap-4">
                                              <div>
                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Agencia / Courier</p>
                                                  <p className="text-xl font-black uppercase leading-none">{selectedLabel.agency}</p>
                                              </div>
                                              <div>
                                                  <p className="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-1">Tracking N°</p>
                                                  <p className="text-xl font-black uppercase leading-none">{selectedLabel.track}</p>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          )}
                      </div>
                  )}

                  {/* --- USUARIOS --- */}
                  {activeTab === 'access_control' && (
                      <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl max-w-2xl mx-auto animate-in">
                          <div className="flex items-center gap-4 mb-8">
                              <div className="p-4 bg-brand text-white rounded-2xl shadow-lg"><Icons.ShieldCheck className="w-8 h-8"/></div>
                              <div>
                                  <h3 className="text-2xl font-black uppercase tracking-tighter">Control de Acceso</h3>
                                  <p className="text-xs font-bold uppercase tracking-widest text-slate-400">Usuarios autorizados en el sistema</p>
                              </div>
                          </div>
                          <div className="space-y-2 mb-8">
                              {adminList.map(email => (
                                  <div key={email} className="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                      <span className="font-bold text-sm text-slate-700">{email}</span>
                                      {email !== ADMIN_EMAIL && (
                                          <button onClick={() => { const newList = adminList.filter(e => e !== email); setAdminList(newList); notify("Usuario eliminado"); }} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                      )}
                                      {email === ADMIN_EMAIL && <span className="text-[9px] font-black uppercase bg-brand text-white px-2 py-1 rounded-md">Admin</span>}
                                  </div>
                              ))}
                          </div>
                          <form onSubmit={(e) => { e.preventDefault(); const email = e.target.email.value.trim(); if(email && !adminList.includes(email)) { setAdminList([...adminList, email]); e.target.reset(); notify("Usuario autorizado"); } }} className="flex gap-2">
                              <input name="email" type="email" placeholder="usuario@gmail.com" required className="flex-1 p-3 rounded-xl bg-slate-100 text-xs font-bold outline-none" />
                              <button className="px-6 py-3 bg-slate-900 text-white rounded-xl font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform">Autorizar</button>
                          </form>
                      </div>
                  )}

                  {/* --- PERFIL DE USUARIO --- */}
                  {activeTab === 'profile' && (
                      <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl max-w-2xl mx-auto animate-in">
                          <div className="flex items-center gap-4 mb-8">
                              <div className="p-4 bg-brand text-white rounded-2xl shadow-lg"><Icons.User className="w-8 h-8"/></div>
                              <div>
                                  <h3 className="text-2xl font-black uppercase tracking-tighter">Mis Datos</h3>
                                  <p className="text-xs font-bold uppercase tracking-widest text-slate-400">Información de tu marca</p>
                              </div>
                          </div>
                          <div className="space-y-4">
                              <div>
                                  <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Email (Cuenta vinculada)</label>
                                  <div className="p-3 bg-slate-100 rounded-xl text-xs font-bold text-slate-500 border border-slate-200 mt-1">{userEmail}</div>
                              </div>
                              <div>
                                  <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Nombre de Marca / Emprendimiento</label>
                                  <input value={userProfile.brand} onChange={(e) => setUserProfile({...userProfile, brand: e.target.value})} placeholder="Tu Marca" className="w-full p-3 rounded-xl bg-slate-50 text-xs font-bold mt-1 outline-none focus:ring-2 ring-brand/20 transition-all border border-slate-100" />
                              </div>
                              <div>
                                  <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Nombre Responsable</label>
                                  <input value={userProfile.owner} onChange={(e) => setUserProfile({...userProfile, owner: e.target.value})} placeholder="Tu Nombre" className="w-full p-3 rounded-xl bg-slate-50 text-xs font-bold mt-1 outline-none focus:ring-2 ring-brand/20 transition-all border border-slate-100" />
                              </div>
                              <div className="grid grid-cols-2 gap-4">
                                  <div>
                                      <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Teléfono</label>
                                      <input value={userProfile.phone} onChange={(e) => setUserProfile({...userProfile, phone: e.target.value})} placeholder="+598..." className="w-full p-3 rounded-xl bg-slate-50 text-xs font-bold mt-1 outline-none focus:ring-2 ring-brand/20 transition-all border border-slate-100" />
                                  </div>
                                  <div>
                                      <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Dirección / Ubicación</label>
                                      <input value={userProfile.address} onChange={(e) => setUserProfile({...userProfile, address: e.target.value})} placeholder="Montevideo..." className="w-full p-3 rounded-xl bg-slate-50 text-xs font-bold mt-1 outline-none focus:ring-2 ring-brand/20 transition-all border border-slate-100" />
                                  </div>
                              </div>
                              <div className="pt-4">
                                  <button onClick={() => notify("Datos guardados automáticamente")} className="w-full py-3 bg-brand text-white rounded-xl font-black uppercase text-xs tracking-widest shadow-lg hover:scale-[1.02] transition-transform">Guardar Cambios</button>
                              </div>
                          </div>
                      </div>
                  )}

                </main>

                {/* MODAL RECORDATORIOS DIARIOS */}
                {showReminder && (
                    <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[300] flex items-center justify-center p-6 animate-in zoom-in duration-300 text-slate-800 text-center no-print">
                        <div className="bg-white max-w-sm w-full rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-amber-400"></div>
                            <div className="w-20 h-20 bg-amber-50 text-amber-500 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-inner">
                                <Icons.Bell className="w-10 h-10 animate-bounce" />
                            </div>
                            <h3 className="text-2xl font-black uppercase mb-2 tracking-tighter leading-tight">Avisos de Hoy</h3>
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">{new Date().toLocaleDateString('es-UY', { day: 'numeric', month: 'long' })}</p>
                            
                            <div className="space-y-3 mb-8 text-left max-h-[40vh] overflow-y-auto pr-2">
                                {FULL_EVENTS.filter(e => e.d === new Date().getDate() && e.m === new Date().getMonth()).map((ev, i) => (
                                    <div key={`s-${i}`} className="p-3 bg-rose-50 rounded-xl border border-rose-100 flex items-center gap-3">
                                        <div className="w-2 h-2 rounded-full bg-brand shrink-0"></div>
                                        <span className="font-bold text-xs text-rose-800 uppercase">{ev.t}</span>
                                    </div>
                                ))}
                                {(personalEvents[`${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`] || []).map((note, i) => (
                                    <div key={`p-${i}`} className="p-3 bg-blue-50 rounded-xl border border-blue-100 flex items-center gap-3">
                                        <div className="w-2 h-2 rounded-full bg-blue-500 shrink-0"></div>
                                        <span className="font-bold text-xs text-blue-900">{note}</span>
                                    </div>
                                ))}
                            </div>

                            <button onClick={() => setShowReminder(false)} className="w-full py-4 bg-slate-900 text-white rounded-3xl font-black uppercase text-[10px] tracking-widest shadow-xl hover:scale-105 transition-transform">
                                ¡Entendido!
                            </button>
                        </div>
                    </div>
                )}

                {/* MODAL SOPORTE */}
                {showContactModal && (
                  <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[200] flex items-center justify-center p-6 animate-in zoom-in duration-300 text-slate-800 text-center no-print">
                     <div className="bg-white max-w-sm w-full rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-brand"></div>
                        <div className="w-20 h-20 bg-rose-50 text-brand rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-inner"><Icons.UserCheck className="w-10 h-10" /></div>
                        <h3 className="text-2xl font-black uppercase tracking-tighter leading-tight mb-4">Soporte MC Pro</h3>
                        <div className="space-y-3">
                          <a href="https://wa.me/59892617525" target="_blank" className="flex items-center justify-center gap-3 w-full py-4 bg-[#25D366] text-white rounded-3xl font-black uppercase text-[10px] tracking-widest shadow-xl transition-all hover:scale-105"><Icons.MessageCircle className="w-4 h-4" /> WhatsApp</a>
                          <button onClick={() => setShowContactModal(false)} className="block w-full py-3 text-slate-300 font-bold uppercase text-[9px] tracking-widest hover:text-brand transition-colors leading-none">Cerrar</button>
                        </div>
                     </div>
                  </div>
                )}
              </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [authLoaded, setAuthLoaded] = useState(false);
            
            // Estados para el Formulario de Login/Registro
            const [isRegisterMode, setIsRegisterMode] = useState(false);
            const [emailInput, setEmailInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [notification, setNotification] = useState(null);
            const [showContactModal, setShowContactModal] = useState(false);
            
            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 2500); };

            useEffect(() => {
                if (window.firebaseModules) {
                    const unsubscribe = window.firebaseModules.onAuthStateChanged(window.firebaseModules.auth, (u) => {
                        setUser(u);
                        setAuthLoaded(true);
                    });
                    return () => unsubscribe();
                } else {
                    setAuthLoaded(true); // Entorno sin Firebase (modo local)
                }
            }, []);

            // El usuario está "Autenticado" si hay un usuario logueado en Firebase y NO es anónimo
            // (La cuenta anónima se usa temporalmente antes del login)
            const isOffline = !window.firebaseModules;
            const isRealUser = user && !user.isAnonymous;
            const isAuthenticated = isOffline || isRealUser;

            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    if (isRegisterMode) {
                        await window.firebaseModules.createUserWithEmailAndPassword(window.firebaseModules.auth, emailInput, passwordInput);
                        notify("Cuenta creada y sesión iniciada.");
                    } else {
                        await window.firebaseModules.signInWithEmailAndPassword(window.firebaseModules.auth, emailInput, passwordInput);
                        notify("Sesión iniciada.");
                    }
                } catch (err) {
                    let msg = err.message;
                    if(err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found') msg = "Usuario o contraseña incorrectos.";
                    if(err.code === 'auth/email-already-in-use') msg = "Este correo ya está registrado.";
                    if(err.code === 'auth/weak-password') msg = "La contraseña debe tener al menos 6 caracteres.";
                    setAuthError(msg);
                }
            };

            const handleLogout = () => {
                if (window.firebaseModules) {
                    window.firebaseModules.signOut(window.firebaseModules.auth)
                        .then(() => {
                            // Al salir de la cuenta real, volvemos a entrar anónimamente para que la UI funcione
                            window.firebaseModules.signInAnonymously(window.firebaseModules.auth);
                            notify("Sesión cerrada");
                        })
                        .catch(e => console.error(e));
                }
            };

            if (!authLoaded) return <div className="h-screen flex items-center justify-center dots-bg font-black uppercase tracking-widest text-slate-300">Cargando Sistema...</div>;

            if (!isAuthenticated) return (
                <div className="flex h-screen items-center justify-center dots-bg p-6">
                    <div className="w-full max-w-sm text-center animate-in bg-white p-8 rounded-3xl shadow-2xl border border-slate-100 relative">
                        <div className="inline-block p-4 rounded-3xl bg-brand text-white shadow-xl mb-6 rotate-3"><Icons.Star className="w-8 h-8 fill-current" /></div>
                        <h1 className="text-3xl font-black text-slate-800 uppercase tracking-tighter mb-2 leading-none text-center">MC Pro</h1>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-[0.3em] mb-10 leading-none text-center">{isRegisterMode ? 'Crear Cuenta Nueva' : 'Acceso a Miembros'}</p>
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded-2xl flex items-center border border-slate-100 relative">
                                <Icons.Mail className="w-5 h-5 text-slate-400 absolute left-4" />
                                <input type="email" required placeholder="Tu correo electrónico" className="bg-transparent outline-none w-full font-bold text-slate-700 text-center px-10" value={emailInput} onChange={e => setEmailInput(e.target.value)} />
                            </div>
                            <div className="bg-slate-50 p-3 rounded-2xl flex items-center border border-slate-100 relative">
                                <Icons.Key className="w-5 h-5 text-slate-400 absolute left-4" />
                                <input type="password" required placeholder="Tu contraseña" minLength="6" className="bg-transparent outline-none w-full font-bold text-slate-700 text-center px-10" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} />
                            </div>
                            
                            {authError && <p className="text-xs font-bold text-red-500 leading-tight bg-red-50 p-2 rounded-lg text-center">{authError}</p>}
                            
                            <button className="w-full py-4 bg-dark text-white rounded-2xl font-black uppercase tracking-widest hover:scale-[1.02] transition-all shadow-lg flex justify-center items-center text-center">
                                {isRegisterMode ? 'Registrarme' : 'Ingresar al Sistema'}
                            </button>

                            <div className="text-center pt-4 border-t border-slate-100 mt-4">
                                <button type="button" onClick={() => setShowContactModal(true)} className="text-[10px] font-bold uppercase tracking-widest text-slate-400 hover:text-brand transition-colors text-center w-full">
                                    ¿Problemas para ingresar? Contacta a soporte
                                </button>
                            </div>
                        </form>
                    </div>

                    {showContactModal && (
                      <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[200] flex items-center justify-center p-6 animate-in zoom-in duration-300 text-slate-800 text-center no-print">
                         <div className="bg-white max-w-sm w-full rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-brand"></div>
                            <div className="w-20 h-20 bg-rose-50 text-brand rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-inner"><Icons.UserCheck className="w-10 h-10" /></div>
                            <h3 className="text-2xl font-black uppercase tracking-tighter leading-tight mb-4">Soporte MC Pro</h3>
                            <div className="space-y-3">
                              <a href="https://wa.me/59892617525" target="_blank" className="flex items-center justify-center gap-3 w-full py-4 bg-[#25D366] text-white rounded-3xl font-black uppercase text-[10px] tracking-widest shadow-xl transition-all hover:scale-105"><Icons.MessageCircle className="w-4 h-4" /> WhatsApp</a>
                              <button onClick={() => setShowContactModal(false)} className="block w-full py-3 text-slate-300 font-bold uppercase text-[9px] tracking-widest hover:text-brand transition-colors leading-none">Cerrar</button>
                            </div>
                         </div>
                      </div>
                    )}

                    {notification && <div className="fixed top-6 right-6 bg-dark text-white px-6 py-3 rounded-xl font-bold text-xs uppercase shadow-2xl z-[100] animate-in">{notification}</div>}
                </div>
            );

            // Se pasa el usuario al Dashboard. La propiedad 'key' fuerza a React a destruir y crear 
            // todo el dashboard desde cero cuando cambia el usuario, garantizando limpieza de estados locales.
            return (
                <Dashboard 
                    key={user ? user.uid : 'offline'} 
                    user={user} 
                    onLogout={handleLogout} 
                />
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>