<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MC Pro Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Nunito', 'sans-serif'], title: ['Fredoka', 'sans-serif'] }, colors: { brand: '#E11D48', dark: '#0f172a' } } } }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOfi3HEwSPODDvqj1lWwfwXJWzwvHIB3s",
            authDomain: "mc-pro-sistema-v2-f97d3.firebaseapp.com",
            projectId: "mc-pro-sistema-v2-f97d3",
            storageBucket: "mc-pro-sistema-v2-f97d3.firebasestorage.app",
            messagingSenderId: "239267591180",
            appId: "1:239267591180:web:30a803f61c957aced12a29"
        };

        const appId = 'mc-pro-app';

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.firebaseModules = { auth, db, appId, doc, setDoc, onSnapshot, collection, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut };
        } catch (e) { console.error("Error inicializando Firebase:", e); }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:ital,wght@0,400;0,600;0,700;0,800;0,900;1,400;1,700;1,900&display=swap');
        body { font-family: 'Nunito', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; font-size: 14px; color: #334155; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Fredoka', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dots-bg { background-color: #ffffff; background-image: radial-gradient(#E11D48 1.5px, transparent 1.5px); background-size: 25px 25px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-area { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 20px; z-index: 9999; background: white; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- ICONOS ---
        function Icon({ path, className }) {
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html: path}} />
            );
        }

        const Icons = {
            Star: (p) => <Icon {...p} path='<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor" />' />,
            Mail: (p) => <Icon {...p} path='<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>' />,
            Lock: (p) => <Icon {...p} path='<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>' />,
            Key: (p) => <Icon {...p} path='<circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/>' />,
            Menu: (p) => <Icon {...p} path='<line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>' />,
            Layout: (p) => <Icon {...p} path='<rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>' />,
            Lightbulb: (p) => <Icon {...p} path='<path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/>' />,
            Wallet: (p) => <Icon {...p} path='<path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>' />,
            DollarSign: (p) => <Icon {...p} path='<line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>' />,
            FileText: (p) => <Icon {...p} path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/>' />,
            Truck: (p) => <Icon {...p} path='<path d="M10 17h4V5H2v12h3"/><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5"/><path d="M14 17h1"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/>' />,
            Calendar: (p) => <Icon {...p} path='<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>' />,
            Package: (p) => <Icon {...p} path='<path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>' />,
            ClipboardList: (p) => <Icon {...p} path='<rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/>' />,
            Calculator: (p) => <Icon {...p} path='<rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/>' />,
            ShieldCheck: (p) => <Icon {...p} path='<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/>' />,
            MessageCircle: (p) => <Icon {...p} path='<path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/>' />,
            LogOut: (p) => <Icon {...p} path='<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>' />,
            Settings: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>' />,
            Image: (p) => <Icon {...p} path='<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>' />,
            CreditCard: (p) => <Icon {...p} path='<rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/>' />,
            Trash2: (p) => <Icon {...p} path='<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>' />,
            Edit2: (p) => <Icon {...p} path='<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>' />,
            ChevronLeft: (p) => <Icon {...p} path='<path d="m15 18-6-6 6-6"/>' />,
            ChevronRight: (p) => <Icon {...p} path='<path d="m9 18 6-6-6-6"/>' />,
            Save: (p) => <Icon {...p} path='<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>' />,
            Download: (p) => <Icon {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>' />,
            X: (p) => <Icon {...p} path='<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>' />,
            CheckCircle2: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>' />,
            Globe: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>' />,
            Sun: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>' />,
            CloudSun: (p) => <Icon {...p} path='<path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/>' />,
            Palette: (p) => <Icon {...p} path='<circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>' />,
            PlusCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/>' />,
            Plus: (p) => <Icon {...p} path='<path d="M5 12h14"/><path d="M12 5v14"/>' />,
            Instagram: (p) => <Icon {...p} path='<rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/>' />,
            Zap: (p) => <Icon {...p} path='<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>' />,
            BarChart3: (p) => <Icon {...p} path='<path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>' />,
            ArrowUpCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/>' />,
            ArrowDownCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="m16 12-4 4-4-4"/><path d="M12 8v8"/>' />,
            Box: (p) => <Icon {...p} path='<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/>' />,
            UserCheck: (p) => <Icon {...p} path='<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/>' />,
            Languages: (p) => <Icon {...p} path='<path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/>' />,
            Pinterest: (p) => <Icon {...p} path='<path d="M8 22c.164-1.21.31-3.045.064-4.358-.222-1.182-1.442-5.932-1.442-5.932s-.368-.737-.368-1.826c0-1.712.993-2.99 2.228-2.99 1.05 0 1.557.788 1.557 1.733 0 1.057-.674 2.637-1.021 4.102-.29 1.226.614 2.226 1.82 2.226 2.185 0 3.865-2.304 3.865-5.63 0-2.943-2.115-4.996-5.13-4.996-3.493 0-5.544 2.62-5.544 5.328 0 1.054.405 2.185.912 2.798.1.122.114.228.084.351-.092.383-.3.1.413.38-.413.033-.131.066-.312.066s-.321-.082-.416-.289c-.1-.219-.4-.73-.55-.992-.482-.843-.728-1.637-.728-3.089 0-4.475 3.245-8.583 9.375-8.583 4.922 0 8.746 3.508 8.746 8.201 0 4.889-3.083 8.825-7.362 8.825-1.438 0-2.789-.747-3.252-1.632l-.884 3.364c-.32 1.22-1.185 2.748-1.765 3.687a10 10 0 1 0 11.162-4.981" fill="currentColor"/>' />,
            Newspaper: (p) => <Icon {...p} path='<path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8z"/>' />,
            Printer: (p) => <Icon {...p} path='<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect width="12" height="8" x="6" y="14"></rect>' />,
            User: (p) => <Icon {...p} path='<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>' />,
            Minus: (p) => <Icon {...p} path='<line x1="5" y1="12" x2="19" y2="12"/>' />,
            Megaphone: (p) => <Icon {...p} path='<path d="m3 11 18-5v12L3 14v-3z"></path><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path>' />,
            PlayCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/>' />,
            ShoppingBag: (p) => <Icon {...p} path='<path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/>' />,
            Bell: (p) => <Icon {...p} path='<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>' />,
            Monitor: (p) => <Icon {...p} path='<rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/>' />,
            Clock: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>' />,
            BookOpen: (p) => <Icon {...p} path='<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>' />
        };

        const t = {
            days: ['L','M','M','J','V','S','D'],
            fin_income: "Ingresos",
            fin_expenses: "Gastos",
            label_concept: "Concepto"
        };

        // --- CONSTANTES ---
        const FULL_EVENTS = [
            {d:1,m:0,t:'Año Nuevo'},{d:6,m:0,t:'Reyes'},{d:14,m:1,t:'San Valentín'},
            {d:8,m:2,t:'Día de la Mujer'},{d:1,m:4,t:'Día de los Trabajadores'},
            {d:18,m:6,t:'Jura Constitución UY'},{d:25,m:7,t:'Independencia UY'},
            {d:24,m:7,t:'Noche de la Nostalgia UY'},{d:31,m:9,t:'Halloween'},
            {d:2,m:10,t:'Día de los Difuntos'},{d:25,m:11,t:'Navidad'}
        ];

        const creativeStrategies = [
            { m: 0, title: 'Planificación & Vuelta a Clases', campaignPalette: ['#EF4444', '#3B82F6', '#FBBF24'], productIdeas: ['Kits escolares'], contentIdeas: ['Reel: "Empaca conmigo"'], promoIdeas: ['Preventa 15% OFF'], trend: 'Colores primarios fuertes.', managerTip: 'La anticipación es clave en Enero.', keywords: "#VueltaAlCole", platforms: ['Instagram'] },
            { m: 1, title: 'Amor, Amistad & Carnaval', campaignPalette: ['#E11D48', '#FDA4AF', '#FCD34D'], productIdeas: ['Cajas sorpresa'], contentIdeas: ['Reel: Storytime'], promoIdeas: ['Promo 2x1'], trend: 'Rojos intensos.', managerTip: 'Amor propio también vende.', keywords: "#SanValentin", platforms: ['TikTok'] },
            { m: 2, title: 'Poder Femenino & Otoño', campaignPalette: ['#9333EA', '#D8B4FE', '#FBBF24'], productIdeas: ['Agendas'], contentIdeas: ['Carrusel IG'], promoIdeas: ['Sorteo 8M'], trend: 'Acuarelas lila.', managerTip: 'Ofrece regalos corporativos.', keywords: "#8M", platforms: ['Instagram'] },
            { m: 3, title: 'Magia de Pascuas', campaignPalette: ['#6EE7B7', '#93C5FD', '#FDE047'], productIdeas: ['Cajas con visor'], contentIdeas: ['TikTok ideas'], promoIdeas: ['Descuento a pasteleros'], trend: 'Tonos pastel.', managerTip: 'Enfoca en B2B.', keywords: "#Pascua", platforms: ['Pinterest'] },
            { m: 4, title: 'Día de la Madre', campaignPalette: ['#BE185D', '#F9A8D4', '#FCD34D'], productIdeas: ['Álbumes'], contentIdeas: ['Reel emotivo'], promoIdeas: ['Envío gratis'], trend: 'Estampados florales.', managerTip: 'Haz guías de regalos.', keywords: "#DiaDeLaMadre", platforms: ['Instagram'] },
            { m: 5, title: 'Día del Padre', campaignPalette: ['#1E3A8A', '#3B82F6', '#94A3B8'], productIdeas: ['Cajas vinos'], contentIdeas: ['Carrusel'], promoIdeas: ['Promo Padre e Hijo'], trend: 'Madera y cuero.', managerTip: 'Kits listos para entregar.', keywords: "#DiaDelPadre", platforms: ['Facebook'] },
            { m: 6, title: 'Vacaciones de Invierno', campaignPalette: ['#06B6D4', '#A855F7', '#F43F5E'], productIdeas: ['Libros colorear'], contentIdeas: ['TikTok DIY'], promoIdeas: ['Descuento infantil'], trend: 'Neón y doodle.', managerTip: 'Ofrece imprimibles gratis.', keywords: "#Invierno", platforms: ['Instagram'] },
            { m: 7, title: 'Día del Niño', campaignPalette: ['#F59E0B', '#10B981', '#EC4899'], productIdeas: ['Party Box'], contentIdeas: ['Reel Unboxing'], promoIdeas: ['Combo hermanos'], trend: 'Súper héroes.', managerTip: 'Aprovecha la nostalgia.', keywords: "#DiaDelNiño", platforms: ['Instagram'] },
            { m: 8, title: 'Primavera', campaignPalette: ['#10B981', '#F472B6', '#FDE047'], productIdeas: ['Banderines'], contentIdeas: ['TikTok Flores'], promoIdeas: ['Early Bird'], trend: 'Boho-chic.', managerTip: 'Temporada de eventos al aire libre.', keywords: "#Primavera", platforms: ['TikTok'] },
            { m: 9, title: 'Halloween & Bodas', campaignPalette: ['#EA580C', '#7E22CE', '#111827'], productIdeas: ['Cajas ataúd'], contentIdeas: ['ASMR Halloween'], promoIdeas: ['Flash Sale'], trend: 'Spooky-cute.', managerTip: 'No descuides la elegancia de las bodas.', keywords: "#Halloween", platforms: ['Instagram'] },
            { m: 10, title: 'Black Friday', campaignPalette: ['#000000', '#F59E0B', '#475569'], productIdeas: ['Agendas nuevo año'], contentIdeas: ['Alerta Ofertas'], promoIdeas: ['Descuentos escalonados'], trend: 'Metalizados.', managerTip: 'Compite por valor, no por precio.', keywords: "#BlackFriday", platforms: ['LinkedIn'] },
            { m: 11, title: 'Navidad Creativa', campaignPalette: ['#15803D', '#DC2626', '#FEF08A'], productIdeas: ['Esferas árbol'], contentIdeas: ['Reel agradecimiento'], promoIdeas: ['Combos listos'], trend: 'Verde pino y glitter.', managerTip: 'Limita personalizados en Diciembre.', keywords: "#Navidad", platforms: ['Instagram'] }
        ];

        const stationeryNews = [
            { title: "Tendencia Foil", desc: "Acabados metálicos.", link: "#" },
            { title: "Papel Sustentable", desc: "Texturas orgánicas.", link: "#" },
            { title: "Plotters de Corte", desc: "Actualizaciones.", link: "#" }
        ];

        const marketMachines = [
            { id: 1, name: 'Silhouette Cameo 5', type: 'Plotter', desc: 'Rápida y precisa.', price: '~$330', features: ['Bluetooth'], supplier: 'Oficial', link: '#' },
            { id: 2, name: 'Cricut Maker 3', type: 'Plotter', desc: 'Corta 300+ materiales.', price: '~$400', features: ['Rápido'], supplier: 'Oficial', link: '#' }
        ];

        // --- HOOKS ---
        function usePersistedState(key, defaultValue, uid) {
            const localKey = `${uid}_${key}`;
            const [state, setState] = useState(() => {
                try { const s = localStorage.getItem(localKey); return s ? JSON.parse(s) : defaultValue; } 
                catch (e) { return defaultValue; }
            });
            const [loaded, setLoaded] = useState(false);

            useEffect(() => {
                if(!uid) return;
                try { const s = localStorage.getItem(localKey); if(s) setState(JSON.parse(s)); else setState(defaultValue); } 
                catch { setState(defaultValue); }
            }, [uid, localKey]);

            useEffect(() => {
                if (!window.firebaseModules || !uid || uid === 'offline') { setLoaded(true); return; }
                const { db, appId, onSnapshot, doc } = window.firebaseModules;
                
                const ref = doc(db, 'artifacts', appId, 'users', uid, 'app_storage', key);
                const unsub = onSnapshot(ref, (s) => { 
                    if(s.exists() && s.data().content !== undefined) { 
                        setState(s.data().content); 
                        localStorage.setItem(localKey, JSON.stringify(s.data().content)); 
                    } 
                    setLoaded(true); 
                }, (err) => console.log('Err snap'));
                
                return () => unsub();
            }, [uid, key, localKey]);

            useEffect(() => {
                if(!loaded || !uid) return;
                localStorage.setItem(localKey, JSON.stringify(state));
                if(!window.firebaseModules || uid === 'offline') return;
                const { db, appId, doc, setDoc } = window.firebaseModules;
                
                const t = setTimeout(() => {
                    setDoc(doc(db, 'artifacts', appId, 'users', uid, 'app_storage', key), { content: state }, { merge: true }).catch(e => console.log('Err save'));
                }, 1500);
                return () => clearTimeout(t);
            }, [state, loaded, uid, localKey, key]);

            return [state, setState];
        }

        function usePublicSharedState(key, defaultValue) {
            const [state, setState] = useState(defaultValue);
            useEffect(() => {
                if(!window.firebaseModules) return;
                const { auth, db, appId, onSnapshot, doc } = window.firebaseModules;
                let unsub = null;
                const unsubAuth = auth.onAuthStateChanged((user) => {
                    if(unsub) { unsub(); unsub=null; }
                    if(user) {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'global', key);
                        unsub = onSnapshot(ref, (s) => { if(s.exists() && s.data().content !== undefined) setState(s.data().content); }, (err) => console.log('Permisos'));
                    }
                });
                return () => { unsubAuth(); if(unsub) unsub(); };
            }, [key]);
            
            const update = (val) => {
                setState(val);
                if(!window.firebaseModules) return;
                const { auth, db, appId, doc, setDoc } = window.firebaseModules;
                if(auth.currentUser) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global', key), { content: val }, { merge: true }).catch(e=>console.log('Err pub'));
            };
            return [state, update];
        }

        function NavItemComp({ id, label, icon: IconComponent, activeTab, setActiveTab, setIsSidebarOpen }) {
            return (
                <button onClick={() => { setActiveTab(id); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-2xl transition-all font-bold text-xs uppercase tracking-tight ${activeTab === id ? 'bg-brand text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}`}>
                    {IconComponent && <IconComponent className="w-4 h-4" />} {label}
                </button>
            );
        }

        // --- DASHBOARD COMPONENT ---
        function Dashboard({ user, onLogout }) {
            const uid = user ? user.uid : 'offline';
            const userEmail = user && user.email ? user.email : 'Usuario Local';
            const ADMIN_EMAIL = 'modocreativo2026@gmail.com';
            const isAdmin = userEmail === ADMIN_EMAIL;

            const [contacts, setContacts] = usePersistedState(`mc_contacts_list`, [], uid);
            const [inventory, setInventory] = usePersistedState(`mc_inventory`, [], uid);
            const [tasks, setTasks] = usePersistedState(`mc_tasks`, [], uid);
            const [clients, setClients] = usePersistedState(`mc_clients`, [], uid); 
            const [shipping, setShipping] = usePersistedState(`mc_shipping`, [], uid);
            const [expenses, setExpenses] = usePersistedState(`mc_expenses`, [], uid); 
            const [extraIncomes, setExtraIncomes] = usePersistedState(`mc_extra_incomes`, [], uid); 
            const [personalEvents, setPersonalEvents] = usePersistedState(`mc_personal_events`, {}, uid);
            const [presupuestos, setPresupuestos] = usePersistedState(`mc_presupuestos`, [], uid);
            const [facturas, setFacturas] = usePersistedState(`mc_facturas`, [], uid);
            const [materialDb, setMaterialDb] = usePersistedState(`mc_material_db`, [], uid);
            const [userProfile, setUserProfile] = usePersistedState(`mc_user_profile`, { brand: '', phone: '', address: '', owner: '', logo: '', email: '', hours: '' }, uid);
            const [usageLog, setUsageLog] = usePersistedState(`mc_material_usage_log`, [], uid);
            const [calc, setCalc] = usePersistedState(`mc_calc_pro`, { selectedMaterialId: '', materialQty: 1, inkPercent: 10, assemblyCost: 0, packagingCost: 0, designHours: 0, cuttingHours: 0, assemblyHours: 0, finishingCost: 0, hourlyRate: 0, opExpenses: 0, maintenanceFund: 0, subscriptions: 0, wastePercent: 10, profitMargin: 50, taxesPercent: 0 }, uid);

            const [digitalProducts, setDigitalProducts] = usePublicSharedState('mc_digital_products', []);

            const [activeTab, setActiveTab] = useState('dashboard');
            const [showContactModal, setShowContactModal] = useState(false);
            const [showReminder, setShowReminder] = useState(false);
            const [notification, setNotification] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [userCountry, setUserCountry] = usePersistedState(`mc_country`, 'UY', uid);
            const [invInput, setInvInput] = useState({ name: '', totalCost: '', totalQty: '', portion: 1 });
            const [statsView, setStatsView] = useState('month');
            const [salesView, setSalesView] = useState('month');
            const [viewDate, setViewDate] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(new Date().getDate());
            const [strategyMonth, setStrategyMonth] = useState(new Date().getMonth());
            const [tourStep, setTourStep] = useState(0); 

            const [allUsers, setAllUsers] = useState([]);
            const [userStatus, setUserStatus] = useState('Activo');
            const [currentUserData, setCurrentUserData] = useState(null);
            
            useEffect(() => {
                if (!user || user.isAnonymous || !window.firebaseModules) return;
                const { db, appId, doc, setDoc, onSnapshot } = window.firebaseModules;
                
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'mc_users', user.uid);
                
                try {
                    const unsub = onSnapshot(userRef, (snap) => {
                        if (!snap.exists()) {
                            const initialData = { uid: user.uid, email: user.email, firstLogin: new Date().toISOString(), subscriptionType: 'Mensual', status: 'Activo', monto: 0 };
                            setDoc(userRef, initialData).catch(err => console.error("Error setting user doc", err));
                            setCurrentUserData(initialData);
                            setUserStatus('Activo');
                        } else {
                            setCurrentUserData(snap.data());
                            setUserStatus(snap.data().status || 'Activo');
                        }
                    });
                    return () => unsub();
                } catch (error) { console.error("Error setting up user snapshot", error); }
            }, [user]);

            useEffect(() => {
                if (!isAdmin || !window.firebaseModules || !user) return;
                const { db, appId, collection, onSnapshot } = window.firebaseModules;
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'mc_users');
                    const unsub = onSnapshot(usersRef, (snap) => {
                        const arr = []; snap.forEach(d => arr.push(d.data())); setAllUsers(arr);
                    });
                    return () => unsub();
                } catch (error) { console.error("Error fetching users:", error); }
            }, [isAdmin, user]);

            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 2500); };
            const deleteItem = (id, setter, name) => { setter(p => p.filter(i => i.id !== id)); notify(`${name} eliminado`); };
            
            const saveEntity = (e, setter, name) => {
              e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries());
              if(d.amount) d.amount = Number(d.amount); if(d.qty) d.qty = Number(d.qty); if(d.price) d.price = Number(d.price);
              const item = { id: Date.now(), ...d, date: new Date().toISOString().split('T')[0], completed: false };
              setter(p => [...p, item]); e.target.reset(); notify(`${name} guardado`);
            };

            const getDayKey = (d) => `${viewDate.getFullYear()}-${String(viewDate.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const totalIncomes = (clients?.filter(c => c.status === 'Completado' || !c.status).reduce((a,c) => a+(c.amount||0),0) || 0) + (extraIncomes?.reduce((a,i) => a+(i.amount||0),0) || 0);
            const totalExpenses = expenses?.reduce((a,e) => a+(e.amount||0),0) || 0;
            const netBalance = totalIncomes - totalExpenses;

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timer);
            }, []);

            const todayEvents = FULL_EVENTS.filter(e => e.d === currentTime.getDate() && e.m === currentTime.getMonth());

            useEffect(() => {
                const checkReminders = () => {
                    if (!uid || uid === 'offline') return;
                    const todayK = `${currentTime.getFullYear()}-${String(currentTime.getMonth() + 1).padStart(2, '0')}-${String(currentTime.getDate()).padStart(2, '0')}`;
                    const todayPersonal = personalEvents[todayK] || [];
                    if (todayEvents.length > 0 || todayPersonal.length > 0) {
                        const shownKey = `reminder_shown_${todayK}_${uid}`;
                        if (!sessionStorage.getItem(shownKey)) {
                            const t = setTimeout(() => { setShowReminder(true); sessionStorage.setItem(shownKey, 'true'); }, 1500);
                            return () => clearTimeout(t);
                        }
                    }
                };
                if (Object.keys(personalEvents).length >= 0) checkReminders();
            }, [personalEvents, uid, currentTime, todayEvents]);

            const updateAccess = (targetUid, updates, targetEmail) => {
                if (targetEmail === ADMIN_EMAIL && updates.status === 'Bloqueado') return notify("❌ Intocable: No puedes bloquear a la cuenta Administradora");
                if (!window.firebaseModules) return;
                const { db, appId, doc, setDoc } = window.firebaseModules;
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mc_users', targetUid), updates, { merge: true }).then(() => notify("Suscripción actualizada"));
            };

            const calculateNextPayment = (dateString, type) => {
                if (!dateString) return '-';
                let nextD = new Date(dateString); const today = new Date(); today.setHours(0,0,0,0); nextD.setHours(0,0,0,0);
                while (nextD <= today) { if (type === 'Anual') nextD.setFullYear(nextD.getFullYear() + 1); else nextD.setMonth(nextD.getMonth() + 1); }
                return nextD.toLocaleDateString('es-UY');
            };

            const exportToCSV = (data, filename) => {
               if(!data || !data.length) return notify("Sin datos");
               const h = Object.keys(data[0]).join(",");
               const r = data.map(o => Object.values(o).map(v => typeof v === 'string' ? `"${v.replace(/"/g, '""')}"` : v).join(","));
               const b = new Blob(["\uFEFF" + [h, ...r].join("\n")], {type: 'text/csv;charset=utf-8;'});
               const u = URL.createObjectURL(b); const l = document.createElement("a"); l.href = u; l.download = `${filename}.csv`; document.body.appendChild(l); l.click(); document.body.removeChild(l);
            };

            // Calculations
            const themeData = useMemo(() => {
                const m = strategyMonth; const seasons = { Verano: [11,0,1], Otoño: [2,3,4], Invierno: [5,6,7], Primavera: [8,9,10] };
                const season = Object.keys(seasons).find(k => seasons[k].includes(m)) || 'Verano';
                const colors = { Verano: ['#F59E0B','#EF4444', '#06B6D4'], Otoño: ['#D97706','#92400E', '#EAB308'], Invierno: ['#3B82F6','#93C5FD', '#1E3A8A'], Primavera: ['#10B981','#F472B6', '#FCD34D'] };
                const strat = creativeStrategies.find(st => st.m === m) || creativeStrategies[0];
                return { seasonName: season, seasonalPalette: colors[season], campaignName: strat.title, strategies: strat };
            }, [strategyMonth]);

            const selectedStrategy = useMemo(() => creativeStrategies.find(s => s.m === strategyMonth), [strategyMonth]);

            const proCalcResult = useMemo(() => {
              const material = materialDb.find(m => m.id === Number(calc.selectedMaterialId));
              const baseMaterialCost = material ? material.price * (calc.materialQty || 1) : 0;
              const directCosts = baseMaterialCost + (baseMaterialCost * ((calc.inkPercent || 0)/100)) + (calc.assemblyCost || 0) + (calc.packagingCost || 0);
              const waste = directCosts * ((calc.wastePercent || 0)/100);
              const labor = ((calc.designHours || 0) + (calc.cuttingHours || 0) + (calc.assemblyHours || 0)) * (calc.hourlyRate || 0);
              const productionTotal = directCosts + waste + labor + (calc.finishingCost || 0);
              const operatingTotal = (calc.opExpenses || 0) + (calc.maintenanceFund || 0) + (calc.subscriptions || 0);
              const subTotal = productionTotal + operatingTotal;
              const withProfit = subTotal * (1 + (calc.profitMargin || 0)/100);
              return { cost: subTotal, final: withProfit * (1 + (calc.taxesPercent || 0)/100) };
            }, [calc, materialDb]);

            const calculatedUnitCost = useMemo(() => {
                  const cost = parseFloat(invInput.totalCost) || 0; const qty = parseFloat(invInput.totalQty) || 1; const portion = parseFloat(invInput.portion) || 1;
                  return ((cost / qty) * portion).toFixed(2);
            }, [invInput]);

            const calculatedStock = useMemo(() => {
                  const qty = parseFloat(invInput.totalQty) || 0; const portion = parseFloat(invInput.portion) || 1;
                  if(portion === 0) return 0; return Math.floor(qty / portion); 
            }, [invInput]);

            const inventoryStats = useMemo(() => {
              const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
              const getStats = (logs) => {
                  const counts = {}; logs.forEach(l => { counts[l.name] = (counts[l.name] || 0) + l.qty; });
                  const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                  return { most: sorted.slice(0, 5), least: sorted.slice(-5).reverse() };
              };
              const monthLogs = usageLog.filter(l => { const d = new Date(l.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; });
              const yearLogs = usageLog.filter(l => { const d = new Date(l.date); return d.getFullYear() === currentYear; });
              return { month: getStats(monthLogs), year: getStats(yearLogs) };
            }, [usageLog]);

            const registerUsage = (item, qty) => {
              if(item.qty < qty) return notify("Stock insuficiente");
              setInventory(prev => prev.map(i => i.id === item.id ? { ...i, qty: i.qty - qty } : i));
              setUsageLog(prev => [...prev, { id: Date.now(), materialId: item.id, name: item.name, qty: qty, date: new Date().toISOString() }]);
              notify(`Uso registrado: ${qty} ${item.name}`);
            };

            const calendarDays = useMemo(() => {
              const y = viewDate.getFullYear(), m = viewDate.getMonth(); const dInM = new Date(y, m + 1, 0).getDate();
              const firstDay = new Date(y, m, 1).getDay(); const offset = firstDay === 0 ? 6 : firstDay - 1;
              const days = []; for (let i = 0; i < offset; i++) days.push(null); for (let i = 1; i <= dInM; i++) days.push(i); return days;
            }, [viewDate]);

            // Tour Data Array
            const tourData = [
                { id: 'intro', tab: 'dashboard', icon: Icons.Star, title: 'Bienvenida a MC Pro', q1: 'Tu Nuevo Asistente Virtual', a1: 'MC Pro no es solo una agenda digital; es el cerebro de tu emprendimiento.', q2: 'El Objetivo', a2: 'Eliminar bloqueos creativos y automatizar finanzas.', q3: '¿Cómo funciona?', a3: 'Usa las flechas para navegar.' },
                { id: 'dashboard', tab: 'dashboard', icon: Icons.Layout, title: '1. Escritorio', q1: '¿Qué es?', a1: 'Tu Centro de Comando.', q2: '¿Qué contiene?', a2: 'Botones rápidos y balance general.', q3: '¿Para qué sirve?', a3: 'Ahorrar tiempo.' }
            ];

            if (userStatus === 'Bloqueado') {
                return (
                    <div className="flex h-screen items-center justify-center bg-slate-900 text-white p-6 relative">
                        <div className="max-w-md text-center relative z-10 animate-in">
                            <h1 className="text-3xl font-black uppercase mb-4 text-white">Acceso Suspendido</h1>
                            <p className="text-slate-400 mb-8 font-bold text-sm bg-slate-800 p-6 rounded-3xl">Tu cuenta ha sido bloqueada. Regulariza tu situación.</p>
                            <button onClick={onLogout} className="block w-full py-4 text-xs text-slate-500 hover:text-white uppercase font-bold transition-colors rounded-2xl hover:bg-slate-800">Cerrar Sesión</button>
                        </div>
                    </div>
                );
            }

            return (
              <div className="flex h-screen overflow-hidden bg-[#fcfcfc] text-slate-800 font-sans">
                <aside className={`fixed lg:static inset-y-0 left-0 w-64 bg-white border-r border-slate-100 flex flex-col shrink-0 shadow-2xl z-50 transition-transform duration-300 no-print ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                  <div className="p-6 text-center flex flex-col items-center">
                    <div className="p-3 rounded-2xl text-white shadow-xl rotate-3 mb-3 inline-block bg-brand"><Icons.Star className="w-6 h-6 fill-current" /></div>
                    <h1 className="font-black text-xl uppercase text-slate-800 tracking-tighter leading-none">MC Pro</h1>
                  </div>
                  <div className="px-4 py-2 mb-2">
                      <div className={`p-3 rounded-xl border text-center shadow-inner relative overflow-hidden ${isAdmin ? 'bg-indigo-50 border-indigo-100' : 'bg-slate-50 border-slate-100'}`}>
                          <p className={`text-[9px] font-black uppercase tracking-widest mb-1 flex items-center justify-center gap-1 ${isAdmin ? 'text-indigo-600' : 'text-slate-400'}`}>
                              {isAdmin ? <><Icons.ShieldCheck className="w-3 h-3 text-indigo-500"/> Super Admin</> : <><Icons.ShieldCheck className="w-3 h-3 text-emerald-500"/> Cliente Activo</>}
                          </p>
                          <p className="text-xs font-bold text-slate-700 truncate">{userEmail}</p>
                      </div>
                  </div>
                  <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                    <NavItemComp id="dashboard" label="Escritorio" icon={Icons.Layout} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="strategies" label="Estrategias" icon={Icons.Lightbulb} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="finances" label="Finanzas" icon={Icons.Wallet} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="contacts" label="Contactos" icon={Icons.UserCheck} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="clients" label="Ventas" icon={Icons.DollarSign} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="presupuestos" label="Presupuestos" icon={Icons.FileText} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="facturas" label="Facturación" icon={Icons.CreditCard} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="shipping" label="Envíos" icon={Icons.Truck} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="planner" label="Calendario" icon={Icons.Calendar} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="inventory" label="Insumos" icon={Icons.Package} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="machines" label="Equipos" icon={Icons.Monitor} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="checklist" label="Taller" icon={Icons.ClipboardList} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="calculator" label="Cotizador" icon={Icons.Calculator} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="store" label="Tienda Digital" icon={Icons.ShoppingBag} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <div className="pt-2 mt-2 border-t border-slate-100">
                        <NavItemComp id="tutorial" label="Guía de Uso" icon={Icons.BookOpen} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    </div>
                    {isAdmin && <NavItemComp id="access_control" label="Clientes Acceso" icon={Icons.ShieldCheck} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />}
                    <NavItemComp id="subscription" label="Mi Suscripción" icon={Icons.Star} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                    <NavItemComp id="profile" label="Mis Datos" icon={Icons.User} activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                  </nav>
                  <div className="p-4 border-t border-slate-50 space-y-2">
                    <button onClick={() => setShowContactModal(true)} className="w-full py-3 bg-dark text-white rounded-xl font-bold text-xs uppercase tracking-widest flex justify-center shadow-sm">Soporte</button>
                    <button onClick={onLogout} className="w-full py-3 text-slate-400 hover:text-brand rounded-xl font-bold text-xs uppercase flex justify-center transition-all">Salir</button>
                  </div>
                </aside>

                <main className="flex-1 overflow-y-auto p-4 md:p-6 relative text-slate-800 print-area">
                  {notification && <div className="fixed top-6 right-6 bg-dark text-white px-6 py-3 rounded-xl font-bold text-xs uppercase shadow-2xl z-[100] animate-in no-print">{notification}</div>}
                  <header className="flex justify-between items-center mb-6 no-print">
                    <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden p-2 bg-white shadow-sm border border-slate-100 rounded-xl text-brand"><Icons.Menu className="w-6 h-6" /></button>
                    <h2 className="text-2xl md:text-3xl font-black tracking-tighter uppercase text-slate-800 leading-none">
                      {activeTab === 'dashboard' ? 'Escritorio' : activeTab === 'strategies' ? 'Estrategias' : activeTab === 'finances' ? 'Finanzas' : activeTab === 'contacts' ? 'Contactos' : activeTab === 'clients' ? 'Ventas' : activeTab === 'presupuestos' ? 'Presupuestos' : activeTab === 'facturas' ? 'Facturación' : activeTab === 'shipping' ? 'Envíos' : activeTab === 'planner' ? 'Calendario' : activeTab === 'inventory' ? 'Insumos' : activeTab === 'machines' ? 'Equipos' : activeTab === 'checklist' ? 'Taller' : activeTab === 'calculator' ? 'Cotizador' : activeTab === 'store' ? 'Tienda Digital' : activeTab === 'tutorial' ? 'Guía' : activeTab === 'access_control' ? 'Control de Accesos' : activeTab === 'subscription' ? 'Mi Suscripción' : 'Mis Datos'}
                    </h2>
                    <div className="hidden md:flex items-center gap-3 bg-white p-2 pr-4 rounded-xl border border-slate-100 shadow-sm font-bold">
                      <p className="text-xs">{currentTime.toLocaleTimeString('es-UY', {hour:'2-digit',minute:'2-digit'})}</p>
                    </div>
                  </header>

                  {/* VISTAS */}
                  {activeTab === 'tutorial' && (
                      <div className="flex flex-col items-center justify-center min-h-[80vh] animate-in pb-10">
                          <div className="w-full max-w-4xl bg-white p-8 md:p-12 rounded-[3rem] shadow-2xl border border-slate-100 relative">
                              <h2 className="text-3xl font-black uppercase tracking-tighter text-slate-800 mb-6">{tourData[tourStep].title}</h2>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                                  <div className="space-y-6">
                                      <div><h4 className="text-[11px] font-black uppercase tracking-widest text-slate-400 mb-2">{tourData[tourStep].q1}</h4><p className="text-sm font-bold text-slate-700 bg-slate-50 p-4 rounded-2xl">{tourData[tourStep].a1}</p></div>
                                      <div><h4 className="text-[11px] font-black uppercase tracking-widest text-slate-400 mb-2">{tourData[tourStep].q2}</h4><p className="text-sm font-bold text-slate-700 bg-slate-50 p-4 rounded-2xl">{tourData[tourStep].a2}</p></div>
                                  </div>
                              </div>
                              <div className="flex justify-between">
                                  <div className="flex gap-2">
                                      <button onClick={() => setTourStep(prev => Math.max(0, prev - 1))} disabled={tourStep === 0} className="px-6 py-3 bg-slate-100 rounded-xl font-black uppercase text-xs">Anterior</button>
                                      <button onClick={() => setTourStep(prev => Math.min(tourData.length - 1, prev + 1))} disabled={tourStep === tourData.length - 1} className="px-6 py-3 bg-slate-900 text-white rounded-xl font-black uppercase text-xs">Siguiente</button>
                                  </div>
                                  <button onClick={() => setActiveTab(tourData[tourStep].tab)} className="px-8 py-3 bg-brand text-white rounded-xl font-black uppercase text-xs shadow-lg">Probar Módulo</button>
                              </div>
                          </div>
                      </div>
                  )}

                  {activeTab === 'dashboard' && (
                    <div className="space-y-6 animate-in flex flex-col h-full">
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onClick={() => setActiveTab('planner')} className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 hover:border-brand transition-all group">
                          <div className="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><Icons.Calendar className="w-5 h-5"/></div>
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase text-slate-400">Mi</p><p className="font-black text-xs uppercase mt-1">Planner</p></div>
                        </button>
                        <button onClick={() => setActiveTab('checklist')} className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 hover:border-brand transition-all group">
                          <div className="p-2 bg-rose-50 text-brand rounded-xl"><Icons.ClipboardList className="w-5 h-5"/></div>
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase text-slate-400">Ir al</p><p className="font-black text-xs uppercase mt-1">Taller</p></div>
                        </button>
                        <button onClick={() => setActiveTab('calculator')} className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 hover:border-brand transition-all group">
                          <div className="p-2 bg-amber-50 text-amber-600 rounded-xl"><Icons.Calculator className="w-5 h-5"/></div>
                          <div className="text-left leading-none"><p className="text-[9px] font-black uppercase text-slate-400">Ir al</p><p className="font-black text-xs uppercase mt-1">Cotizador</p></div>
                        </button>
                        <div className="bg-slate-900 p-4 rounded-3xl text-white shadow-lg flex items-center gap-3 relative overflow-hidden">
                          <div className="text-left z-10 leading-none">
                              <p className="text-[9px] font-black uppercase text-indigo-400">Hoy:</p>
                              <p className="font-black text-[11px] uppercase truncate w-24 mt-1">{todayEvents.length > 0 ? todayEvents[0].t : 'Sin eventos'}</p>
                          </div>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 min-h-[150px]">
                        <div className="bg-dark p-6 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden flex flex-col justify-center">
                          <h3 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2 leading-none">Balance</h3>
                          <p className="text-4xl font-black tracking-tighter leading-none">${netBalance}</p>
                        </div>
                        <div className="bg-emerald-50 p-6 rounded-[2.5rem] border border-emerald-100 flex flex-col justify-center text-slate-800 leading-none"><h3 className="text-[10px] font-black text-emerald-600 uppercase tracking-widest mb-2 leading-none">Ingresos</h3><p className="text-4xl font-black tracking-tighter leading-none">${totalIncomes}</p></div>
                        <div className="bg-rose-50 p-6 rounded-[2.5rem] border border-rose-100 flex flex-col justify-center text-slate-800 leading-none"><h3 className="text-[10px] font-black text-rose-600 uppercase tracking-widest mb-2 leading-none">Gastos</h3><p className="text-4xl font-black tracking-tighter leading-none">${totalExpenses}</p></div>
                      </div>
                    </div>
                  )}

                  {activeTab === 'contacts' && (
                      <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                          <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black uppercase tracking-tighter flex items-center gap-2">Directorio de Contactos</h3></div>
                          <div className="flex-1 overflow-y-auto mb-6 pr-2 space-y-3">
                              {contacts.map(c => (
                                  <div key={c.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex justify-between items-center">
                                      <div><h4 className="font-black text-sm text-slate-800 uppercase">{c.name}</h4><div className="text-[10px] font-bold text-slate-500 mt-1 flex flex-wrap gap-4"><span>📞 {c.phone || '-'}</span><span>✉️ {c.email || '-'}</span></div></div>
                                      <button onClick={() => deleteItem(c.id, setContacts, 'Contacto')} className="p-2 text-slate-300 hover:text-red-500 bg-white rounded-xl shadow-sm"><Icons.Trash2 className="w-4 h-4"/></button>
                                  </div>
                              ))}
                          </div>
                          <form onSubmit={(e) => saveEntity(e, setContacts, 'Contacto')} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                              <div className="lg:col-span-1"><input name="name" required placeholder="Nombre..." className="w-full p-3 rounded-xl text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-1"><input name="phone" placeholder="Celular..." className="w-full p-3 rounded-xl text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-1"><input name="email" type="email" placeholder="Correo..." className="w-full p-3 rounded-xl text-xs font-bold shadow-sm outline-none" /></div>
                              <div className="lg:col-span-5 flex justify-end"><button className="px-8 py-3 bg-slate-900 text-white rounded-xl font-black uppercase tracking-widest shadow-lg">Guardar</button></div>
                          </form>
                      </div>
                  )}

                  {activeTab === 'presupuestos' && (
                      <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                          <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black uppercase tracking-tighter">Presupuestos</h3></div>
                          <div className="flex-1 overflow-y-auto mb-6 pr-2 space-y-3">
                              {presupuestos.map(p => (
                                  <div key={p.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex justify-between items-center">
                                      <div><h4 className="font-black text-sm text-slate-800 uppercase">{p.clientName}</h4><p className="text-[10px] font-bold text-slate-500 mt-1">Monto: ${p.amount} | Fecha: {p.date}</p></div>
                                      <button onClick={() => deleteItem(p.id, setPresupuestos, 'Presupuesto')} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                  </div>
                              ))}
                          </div>
                          <form onSubmit={(e) => saveEntity(e, setPresupuestos, 'Presupuesto')} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex gap-4">
                              <input name="clientName" required placeholder="Nombre..." className="flex-1 p-3 rounded-xl text-xs font-bold shadow-sm outline-none" />
                              <input name="amount" type="number" required placeholder="$" className="w-32 p-3 rounded-xl text-xs font-bold shadow-sm outline-none" />
                              <button className="px-6 bg-brand text-white rounded-xl font-black uppercase text-xs shadow-lg">Generar</button>
                          </form>
                      </div>
                  )}

                  {activeTab === 'facturas' && (
                      <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                          <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black uppercase tracking-tighter">Facturación</h3></div>
                          <div className="flex-1 overflow-y-auto mb-6 pr-2 space-y-3">
                              {facturas.map(f => (
                                  <div key={f.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex justify-between items-center">
                                      <div><h4 className="font-black text-sm text-slate-800 uppercase">{f.clientName}</h4><p className="text-[10px] font-bold text-slate-500 mt-1">Monto: ${f.amount} | Fecha: {f.date}</p></div>
                                      <button onClick={() => deleteItem(f.id, setFacturas, 'Factura')} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                  </div>
                              ))}
                          </div>
                          <form onSubmit={(e) => saveEntity(e, setFacturas, 'Factura')} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex gap-4">
                              <input name="clientName" required placeholder="Nombre..." className="flex-1 p-3 rounded-xl text-xs font-bold shadow-sm outline-none" />
                              <input name="amount" type="number" required placeholder="$" className="w-32 p-3 rounded-xl text-xs font-bold shadow-sm outline-none" />
                              <button className="px-6 bg-brand text-white rounded-xl font-black uppercase text-xs shadow-lg">Facturar</button>
                          </form>
                      </div>
                  )}

                  {activeTab === 'shipping' && (
                      <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                          <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black uppercase tracking-tighter">Envíos</h3></div>
                          <div className="flex-1 overflow-y-auto mb-6 pr-2 space-y-3">
                              {shipping.map(s => (
                                  <div key={s.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex justify-between items-center">
                                      <div><h4 className="font-black text-sm text-slate-800 uppercase">{s.clientName}</h4><p className="text-[10px] font-bold text-slate-500 mt-1">{s.address}</p></div>
                                      <button onClick={() => deleteItem(s.id, setShipping, 'Envío')} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                  </div>
                              ))}
                          </div>
                          <form onSubmit={(e) => { e.preventDefault(); const f = new FormData(e.target); setShipping([...shipping, { id: Date.now(), clientName: f.get('clientName'), address: f.get('address'), date: new Date().toISOString() }]); e.target.reset(); notify("Envío guardado"); }} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex gap-4">
                              <input name="clientName" required placeholder="Destinatario..." className="w-1/3 p-3 rounded-xl text-xs font-bold shadow-sm outline-none" />
                              <input name="address" required placeholder="Destino..." className="flex-1 p-3 rounded-xl text-xs font-bold shadow-sm outline-none" />
                              <button className="px-6 bg-slate-900 text-white rounded-xl font-black uppercase text-xs shadow-lg">Despachar</button>
                          </form>
                      </div>
                  )}

                  {activeTab === 'strategies' && (
                    <div className="space-y-6 animate-in pb-10">
                        <div className="flex gap-2 overflow-x-auto pb-2 scroll-smooth no-scrollbar">
                          {['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'].map((month, i) => (
                             <button key={i} onClick={() => setStrategyMonth(i)} className={`px-6 py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest transition-all shrink-0 border ${strategyMonth === i ? 'bg-brand text-white shadow-lg border-brand scale-105' : 'bg-white text-slate-400 border-slate-100 hover:bg-slate-50'}`}>{month}</button>
                          ))}
                        </div>
                        <div className="relative overflow-hidden rounded-[2.5rem] p-8 md:p-10 text-white shadow-2xl transition-all duration-500" style={{background: `linear-gradient(135deg, ${themeData.seasonalPalette[0]} 0%, ${themeData.seasonalPalette[1]} 100%)`}}>
                          <h2 className="text-4xl md:text-6xl font-black tracking-tighter uppercase leading-none mb-4">{selectedStrategy.title}</h2>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col justify-center text-center">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Tendencia</h3>
                            <div className="flex h-12 rounded-2xl overflow-hidden border shadow-inner">
                                {themeData.seasonalPalette.map((c,i)=>(<div key={i} className="flex-1" style={{backgroundColor:c}}></div>))}
                            </div>
                          </div>
                        </div>
                    </div>
                  )}

                  {activeTab === 'planner' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in text-slate-800">
                          <div className={`lg:col-span-2 bg-slate-50 p-4 sm:p-6 rounded-[2.5rem] shadow-2xl border border-slate-200`}>
                             <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 sm:gap-0">
                                <h3 className={`text-xl sm:text-2xl font-black uppercase tracking-tighter leading-none`}>{viewDate.toLocaleDateString('es-UY', { month: 'long', year: 'numeric' })}</h3>
                                <div className="flex gap-2">
                                    <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1))} className={`p-2 bg-white rounded-xl shadow-sm hover:scale-105 transition-transform`}><Icons.ChevronLeft className="w-4 h-4"/></button>
                                    <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1))} className={`p-2 bg-white rounded-xl shadow-sm hover:scale-105 transition-transform`}><Icons.ChevronRight className="w-4 h-4"/></button>
                                </div>
                             </div>
                             <div className="grid grid-cols-7 gap-1 sm:gap-1.5">
                               {t.days.map(d=><div key={d} className={`text-center font-black pb-2 text-[8px] sm:text-[10px] uppercase leading-none opacity-70`}>{d}</div>)}
                               {calendarDays.map((d,i)=>{
                                 const hasEvents = FULL_EVENTS.some(e => e.d === d && e.m === viewDate.getMonth());
                                 const dayKey = d ? getDayKey(d) : null;
                                 const hasPersonal = dayKey && personalEvents[dayKey] && personalEvents[dayKey].length > 0;
                                 const isToday = d === new Date().getDate() && viewDate.getMonth() === new Date().getMonth() && viewDate.getFullYear() === new Date().getFullYear();
                                 return (
                                   <div key={i} onClick={()=>d && setSelectedDay(d)} className={`h-12 sm:h-16 p-1 sm:p-2 rounded-xl border transition-all cursor-pointer flex flex-col justify-between ${selectedDay===d?'bg-brand text-white shadow-xl scale-105 z-10 border-transparent':(hasEvents || hasPersonal)?'bg-white border-slate-200':'bg-white border-white hover:border-slate-200 shadow-sm'}`}>
                                     {d && <div className="flex justify-between items-start leading-none"><span className="text-xs sm:text-sm font-bold leading-none">{d}</span><div className="flex gap-0.5 sm:gap-1 leading-none">{hasEvents && <div className={`w-1 h-1 sm:w-1.5 sm:h-1.5 rounded-full bg-brand shadow-sm animate-pulse`}></div>}{hasPersonal && <div className="w-1 h-1 sm:w-1.5 sm:h-1.5 rounded-full bg-blue-500 shadow-sm"></div>}</div></div>}
                                     {isToday && <div className={`text-[6px] sm:text-[8px] font-black uppercase ${selectedDay === d ? 'text-white/80' : 'text-slate-400'} leading-none`}>Hoy</div>}
                                   </div>
                                 );
                               })}
                             </div>
                          </div>
                          
                          <div className={`bg-white p-4 sm:p-6 rounded-[2.5rem] shadow-xl border border-slate-100 h-fit`}>
                             <h4 className={`text-xl sm:text-2xl font-black uppercase mb-4 leading-none text-center sm:text-left`}>{selectedDay} {viewDate.toLocaleDateString('es-UY', { month: 'short' })}</h4>
                             <div className="space-y-4 max-h-[300px] sm:max-h-[400px] overflow-y-auto pr-1">
                                {FULL_EVENTS.filter(e => e.d === selectedDay && e.m === viewDate.getMonth()).map((ev, i) => (<div key={i} className={`p-3 sm:p-4 bg-slate-50 rounded-2xl border border-slate-100 shadow-sm animate-in`}><p className={`font-black uppercase text-xs leading-tight`}>{ev.t}</p></div>))}
                                
                                <div className={`pt-4 border-t border-slate-100 text-slate-800`}>
                                   <h5 className={`text-[10px] font-black uppercase opacity-80 mb-3 tracking-widest leading-none`}>Cita Personal</h5>
                                   <form onSubmit={(e) => { e.preventDefault(); const n = e.target.note.value.trim(); if(n){ const dk = getDayKey(selectedDay); const cur = personalEvents[dk] || []; setPersonalEvents({...personalEvents, [dk]: [...cur, n]}); e.target.reset(); notify("Cita guardada"); } }} className="flex gap-2 mb-4 leading-none">
                                      <input name="note" required placeholder="Escribir..." className={`flex-1 p-3 bg-slate-50 rounded-xl outline-none text-xs shadow-inner leading-none border border-transparent focus:border-brand`} />
                                      <button className={`p-3 bg-brand text-white rounded-xl hover:scale-105 transition-transform shadow-md leading-none`}><Icons.Plus className="w-4 h-4"/></button>
                                   </form>
                                   <div className="space-y-2">
                                      {(personalEvents[getDayKey(selectedDay)] || []).map((note, idx) => (
                                         <div key={idx} className="group flex justify-between items-center p-3 bg-blue-50 rounded-2xl border border-blue-100 text-blue-900 text-xs font-bold shadow-sm animate-in">
                                            <span className="truncate mr-2">{note}</span>
                                            <button onClick={() => { const dk = getDayKey(selectedDay); setPersonalEvents({...personalEvents, [dk]: personalEvents[dk].filter((_, ni) => ni !== idx)}); notify("Eliminada"); }}><Icons.Trash2 className="w-3 h-3 text-blue-300 hover:text-red-50 flex-shrink-0"/></button>
                                         </div>
                                      ))}
                                   </div>
                                </div>
                             </div>
                          </div>
                        </div>
                  )}

                  {activeTab === 'finances' && (
                          <div className="flex flex-col h-full space-y-6 animate-in">
                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
                                  <div className="flex items-center gap-4">
                                      <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1))} className="p-2 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors"><Icons.ChevronLeft className="w-5 h-5"/></button>
                                      <h3 className="text-2xl font-black uppercase tracking-tighter text-slate-800">{viewDate.toLocaleDateString('es-UY', { month: 'long', year: 'numeric' })}</h3>
                                      <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1))} className="p-2 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors"><Icons.ChevronRight className="w-5 h-5"/></button>
                                  </div>
                                  <div className="flex items-center gap-6">
                                      <div className="text-right">
                                          <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Balance Mensual</p>
                                          <p className={`text-4xl font-black tracking-tighter ${netBalance >= 0 ? 'text-slate-800' : 'text-rose-500'}`}>${netBalance}</p>
                                      </div>
                                  </div>
                              </div>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-hidden">
                                  <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full overflow-hidden">
                                      <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-black uppercase text-emerald-600 tracking-tight flex items-center gap-2"><Icons.ArrowUpCircle className="w-6 h-6"/> {t.fin_income}</h3><div className="px-4 py-2 bg-emerald-50 text-emerald-700 rounded-xl font-black text-xl shadow-sm">${totalIncomes}</div></div>
                                      <div className="flex-1 overflow-y-auto space-y-3 mb-6 pr-2">
                                          {extraIncomes.map(i => (<div key={i.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-xs"><div className="flex items-center gap-3"><span className="font-bold uppercase">{i.concept}</span></div><div className="flex items-center gap-3"><span className="font-black text-emerald-600">+${i.amount}</span><button onClick={()=>deleteItem(i.id, setExtraIncomes, 'Ingreso')} className="text-slate-300 hover:text-red-500"><Icons.X className="w-4 h-4"/></button></div></div>))}
                                      </div>
                                      <form onSubmit={(e)=>saveEntity(e, setExtraIncomes, 'Ingreso')} className="p-4 bg-emerald-50 rounded-3xl border border-emerald-100 shrink-0"><h4 className="text-[10px] font-black uppercase text-emerald-600 mb-3 tracking-widest">Nuevo Ingreso Extra</h4><div className="flex gap-2"><input name="concept" required className="flex-1 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" /><input name="amount" type="number" required className="w-24 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" /><button className="p-3 bg-emerald-600 text-white rounded-xl shadow-md hover:scale-105 transition-transform"><Icons.Plus className="w-4 h-4"/></button></div></form>
                                  </div>
                                  <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-full overflow-hidden">
                                      <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-black uppercase text-rose-600 tracking-tight flex items-center gap-2"><Icons.ArrowDownCircle className="w-6 h-6"/> {t.fin_expenses}</h3><div className="px-4 py-2 bg-rose-50 text-rose-700 rounded-xl font-black text-xl shadow-sm">${totalExpenses}</div></div>
                                      <div className="flex-1 overflow-y-auto space-y-3 mb-6 pr-2">
                                          {expenses.map(e => (<div key={e.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-xs group"><span className="font-bold uppercase ml-2">{e.concept}</span><div className="flex items-center gap-3"><span className="font-black text-rose-600">-${e.amount}</span><button onClick={()=>deleteItem(e.id, setExpenses, 'Gasto')} className="text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button></div></div>))}
                                      </div>
                                      <form onSubmit={(e)=>saveEntity(e, setExpenses, 'Gasto')} className="p-4 bg-rose-50 rounded-3xl border border-rose-100 shrink-0"><h4 className="text-[10px] font-black uppercase text-rose-600 mb-3 tracking-widest">Nuevo Gasto</h4><div className="flex gap-2"><input name="concept" required className="flex-1 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" /><input name="amount" type="number" required className="w-24 p-3 rounded-xl text-xs font-bold outline-none shadow-sm" /><button className="p-3 bg-rose-600 text-white rounded-xl shadow-md hover:scale-105 transition-transform"><Icons.Plus className="w-4 h-4"/></button></div></form>
                                  </div>
                              </div>
                          </div>
                  )}

                  {activeTab === 'clients' && (
                          <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                              <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                  <h3 className="text-xl font-black uppercase tracking-tighter">Directorio de Ventas</h3>
                                  <button onClick={()=>exportToCSV(clients, 'ventas')} className="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest flex gap-2"><Icons.Download className="w-4 h-4"/> CSV</button>
                              </div>
                              <div className="flex-1 overflow-y-auto mb-6 border border-slate-100 rounded-2xl p-2 bg-slate-50/50">
                                  <table className="w-full text-left text-xs table-fixed">
                                      <thead className="text-[10px] uppercase font-black text-slate-400 tracking-widest border-b border-slate-100"><tr><th className="pb-3 pl-4">Cliente</th><th className="pb-3">Estado</th><th className="pb-3">Total</th><th className="pb-3 text-right pr-4">x</th></tr></thead>
                                      <tbody className="text-slate-700 font-bold">
                                          {clients.map(c => (
                                              <tr key={c.id} className="border-b border-slate-50">
                                                  <td className="py-4 pl-4 truncate">{c.name}</td>
                                                  <td className="py-4"><select value={c.status || 'Completado'} onChange={(e) => setClients(prev => prev.map(item => item.id === c.id ? {...item, status: e.target.value} : item))} className="p-1.5 rounded-lg text-[10px] font-black uppercase outline-none border"><option value="Completado">Hecho</option><option value="Pendiente">Pendiente</option><option value="No Cobrado">No Cobrado</option><option value="Cancelado">Cancelado</option></select></td>
                                                  <td className="py-4">${c.amount}</td>
                                                  <td className="py-4 text-right pr-4"><button onClick={()=>deleteItem(c.id, setClients, 'Cliente')} className="text-slate-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button></td>
                                              </tr>
                                          ))}
                                      </tbody>
                                  </table>
                              </div>
                              <form onSubmit={(e)=>{ e.preventDefault(); const form = e.target; const contact = contacts.find(c => c.id.toString() === form.elements['contactId'].value); if(!contact) return; setClients(prev => [...prev, { id: Date.now(), name: contact.name, amount: Number(form.elements['amount'].value), status: form.elements['status'].value, date: new Date().toISOString().split('T')[0] }]); form.reset(); notify("Venta registrada"); }} className="bg-slate-50 p-6 rounded-3xl border border-slate-100 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                  <div className="md:col-span-6"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Seleccionar Contacto *</label><select name="contactId" required className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none bg-white border border-slate-200"><option value="">-- Elige un cliente --</option>{contacts.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                                  <div className="md:col-span-2"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Monto Total</label><input name="amount" type="number" required className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none" /></div>
                                  <div className="md:col-span-2"><label className="text-[9px] font-black uppercase text-slate-400 ml-2">Estado</label><select name="status" className="w-full p-3 rounded-xl mt-1 text-xs font-bold shadow-sm outline-none bg-white"><option value="Completado">Hecho</option><option value="Pendiente">Pendiente</option></select></div>
                                  <div className="md:col-span-2"><button className="w-full py-3 bg-brand text-white rounded-xl font-black uppercase tracking-widest shadow-lg hover:scale-105 transition-transform">Registrar</button></div>
                              </form>
                          </div>
                  )}

                  {activeTab === 'inventory' && (
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-in h-full">
                          <div className="md:col-span-2 space-y-6 flex flex-col h-full overflow-hidden">
                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col flex-1 overflow-hidden">
                                  <h3 className="text-xl font-black uppercase tracking-tighter mb-6 flex items-center gap-2"><Icons.Box className="w-6 h-6"/> Stock de Materiales</h3>
                                  <div className="flex-1 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-4 content-start pr-2">
                                      {inventory.map(i => (
                                          <div key={i.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-brand transition-all group relative">
                                              <div className="absolute top-3 right-3 flex gap-2"><button onClick={() => registerUsage(i, 1)} className="text-slate-300 hover:text-brand bg-white rounded-lg p-1 shadow-sm"><Icons.Minus className="w-3 h-3"/></button><button onClick={()=>deleteItem(i.id, setInventory, 'Item')} className="text-slate-300 hover:text-red-500 bg-white rounded-lg p-1 shadow-sm"><Icons.X className="w-3 h-3"/></button></div>
                                              <h4 className="font-black uppercase text-xs mb-1 text-slate-700 pr-12">{i.name}</h4>
                                              <div className="flex gap-3 text-[10px] font-bold uppercase text-slate-500"><span>Stock: {i.qty}</span><span>Unit: ${i.price}</span></div>
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          </div>
                          <div className="flex flex-col gap-6 h-fit sticky top-6">
                              <div className="bg-slate-900 p-6 rounded-[2.5rem] text-white shadow-xl flex flex-col justify-center">
                                  <h3 className="text-lg font-black uppercase tracking-widest text-indigo-400 mb-6">Ingreso Inteligente</h3>
                                  <div className="space-y-4">
                                      <div><input value={invInput.name} onChange={e => setInvInput({...invInput, name: e.target.value})} placeholder="Material..." className="w-full p-3 rounded-xl bg-white/10 border border-white/10 text-white font-bold text-xs outline-none"/></div>
                                      <div className="grid grid-cols-2 gap-4">
                                          <input type="number" value={invInput.totalCost} onChange={e => setInvInput({...invInput, totalCost: parseFloat(e.target.value) || 0})} placeholder="Costo" className="w-full p-3 rounded-xl bg-white/10 border border-white/10 text-white font-bold text-xs outline-none"/>
                                          <input type="number" value={invInput.totalQty} onChange={e => setInvInput({...invInput, totalQty: parseFloat(e.target.value) || 1})} placeholder="Cant" className="w-full p-3 rounded-xl bg-white/10 border border-white/10 text-white font-bold text-xs outline-none"/>
                                      </div>
                                      <button onClick={() => { if(!invInput.name) return; setInventory(prev => [...prev, { id: Date.now(), name: invInput.name, qty: calculatedStock, price: parseFloat(calculatedUnitCost) }]); setInvInput({ name: '', totalCost: '', totalQty: '', portion: 1 }); notify("Guardado"); }} className="w-full py-4 bg-brand text-white rounded-xl font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-lg">Guardar Stock</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  )}

                  {activeTab === 'machines' && (
                      <div className="space-y-6 animate-in pb-10">
                          <h3 className="text-2xl font-black uppercase tracking-tighter">Equipos del Mercado</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                              {marketMachines.map(m => (
                                  <a key={m.id} href={m.link} target="_blank" className="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col p-6 hover:shadow-2xl transition-all block">
                                      <h4 className="font-black text-xl text-slate-800 mb-2">{m.name}</h4><p className="text-xs text-slate-500 mb-4">{m.desc}</p><span className="font-black text-lg">{m.price}</span>
                                  </a>
                              ))}
                          </div>
                      </div>
                  )}

                  {activeTab === 'checklist' && (() => {
                      return (
                          <div className="flex flex-col h-full animate-in">
                              <form onSubmit={(e)=>saveEntity(e, setTasks, 'Tarea')} className="flex gap-2 mb-6"><input name="name" placeholder="Nuevo Trabajo..." required className="p-3 rounded-xl bg-white border border-slate-200 shadow-sm text-xs font-bold w-64 outline-none"/><button className="p-3 bg-dark text-white rounded-xl shadow-lg"><Icons.Plus className="w-4 h-4"/></button></form>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-y-auto">
                                  <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                      <h4 className="text-[10px] font-black uppercase text-amber-500 tracking-[0.2em] mb-4">En Proceso</h4>
                                      <div className="space-y-3">{tasks.filter(t => !t.completed).map(t => (<div key={t.id} className="p-4 bg-slate-50 rounded-2xl border flex items-center justify-between"><span className="font-bold text-xs uppercase">{t.name}</span><button onClick={() => setTasks(prev => prev.map(i => i.id === t.id ? { ...i, completed: true } : i))}><Icons.CheckCircle2 className="w-4 h-4 text-emerald-500"/></button></div>))}</div>
                                  </div>
                                  <div className="bg-slate-100 p-6 rounded-[2.5rem] border shadow-inner opacity-80">
                                      <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] mb-4">Finalizado</h4>
                                      <div className="space-y-3">{tasks.filter(t => t.completed).map(t => (<div key={t.id} className="p-4 bg-white/50 rounded-2xl border flex items-center justify-between"><span className="font-bold text-xs uppercase line-through text-slate-400">{t.name}</span><button onClick={() => deleteItem(t.id, setTasks, 'Tarea')}><Icons.Trash2 className="w-4 h-4 text-slate-400"/></button></div>))}</div>
                                  </div>
                              </div>
                          </div>
                      );
                  })()}

                  {activeTab === 'calculator' && (
                      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in pb-10">
                          <div className="lg:col-span-2 space-y-6">
                              <div className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                  <h3 className="text-lg font-black uppercase mb-6 flex items-center gap-2"><Icons.Settings className="w-5 h-5"/> Configuración Base</h3>
                                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                      {['hourlyRate:Valor Hora','opExpenses:Gastos Fijos','profitMargin:% Ganancia','wastePercent:% Desperdicio'].map(f => {
                                          const [k, l] = f.split(':');
                                          return <div key={k}><label className="text-[9px] font-bold uppercase text-slate-400 ml-1">{l}</label><input type="number" value={calc[k]} onChange={e => setCalc({...calc, [k]: parseFloat(e.target.value)||0})} className="w-full p-3 rounded-xl bg-slate-50 text-xs font-black text-slate-700 outline-none"/></div>
                                      })}
                                  </div>
                              </div>
                          </div>
                          <div className="bg-dark p-8 rounded-[3rem] text-white shadow-2xl relative overflow-hidden flex flex-col justify-center text-center h-fit sticky top-6">
                              <h2 className="text-sm font-black uppercase tracking-[0.4em] text-brand mb-4 relative z-10">Precio Sugerido</h2>
                              <p className="text-6xl font-black tracking-tighter mb-2 relative z-10">${proCalcResult.final.toFixed(2)}</p>
                          </div>
                      </div>
                  )}
                  
                  {activeTab === 'store' && (
                      <div className="space-y-6 animate-in pb-10">
                          <h3 className="text-2xl font-black uppercase tracking-tighter">Tienda Digital</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                              {digitalProducts.map(p => (
                                  <div key={p.id} className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col justify-between">
                                      <h4 className="font-black text-lg text-slate-800 leading-tight mb-2">{p.title}</h4>
                                      <span className="font-black text-xl text-emerald-600">${p.price}</span>
                                  </div>
                              ))}
                          </div>
                      </div>
                  )}

                  {activeTab === 'access_control' && isAdmin && (
                      <div className="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in h-full flex flex-col">
                          <h3 className="text-2xl font-black uppercase tracking-tighter mb-6">Clientes con Acceso</h3>
                          <div className="flex-1 overflow-y-auto border border-slate-100 rounded-3xl p-2 bg-slate-50/50">
                              <table className="w-full text-left text-xs table-fixed min-w-[700px]">
                                  <thead className="text-[10px] uppercase font-black text-slate-400 tracking-widest border-b border-slate-100">
                                      <tr><th className="pb-4 pl-4 w-[25%]">Usuario / Email</th><th className="pb-4 w-[15%]">Fecha Inicio</th><th className="pb-4 w-[15%]">Tipo de Plan</th><th className="pb-4 w-[15%]">Monto a Cobrar</th><th className="pb-4 w-[15%] text-center">Próximo Pago</th><th className="pb-4 w-[15%] pr-4 text-right">Estado</th></tr>
                                  </thead>
                                  <tbody className="text-slate-700 font-bold">
                                      {allUsers.map(u => {
                                          const nextPay = calculateNextPayment(u.firstLogin, u.subscriptionType);
                                          return (
                                              <tr key={u.uid} className="border-b border-slate-50 hover:bg-white transition-colors group">
                                                  <td className="py-4 pl-4 truncate">{u.email}</td>
                                                  <td className="py-4 text-slate-500">{new Date(u.firstLogin).toLocaleDateString('es-UY')}</td>
                                                  <td className="py-4">
                                                      {u.email === ADMIN_EMAIL ? <span className="text-xs font-black text-slate-400">Vitalicio</span> : <select value={u.subscriptionType || 'Mensual'} onChange={(e) => updateAccess(u.uid, { subscriptionType: e.target.value }, u.email)} className="p-2 rounded-xl bg-slate-100 border border-slate-200 outline-none w-[90%] text-xs font-black uppercase"><option value="Mensual">Mensual</option><option value="Anual">Anual</option></select>}
                                                  </td>
                                                  <td className="py-4">
                                                      {u.email === ADMIN_EMAIL ? <span className="text-xs font-black text-slate-400">-</span> : <div className="flex items-center gap-1 bg-slate-100 px-3 py-2 rounded-xl border border-slate-200 w-[90%]"><span className="text-slate-400 text-xs font-black">$</span><input type="number" defaultValue={u.monto || ''} onBlur={(e) => updateAccess(u.uid, { monto: Number(e.target.value) }, u.email)} className="bg-transparent outline-none w-full text-xs font-black" placeholder="0" /></div>}
                                                  </td>
                                                  <td className="py-4 text-center"><span className="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-100 shadow-sm">{u.email === ADMIN_EMAIL ? '∞' : nextPay}</span></td>
                                                  <td className="py-4 pr-4 text-right">
                                                      {u.email === ADMIN_EMAIL ? <span className="text-[10px] font-black uppercase text-indigo-500 bg-indigo-50 px-3 py-2 rounded-xl inline-block">👑 Admin</span> : <select value={u.status || 'Activo'} onChange={(e) => updateAccess(u.uid, { status: e.target.value }, u.email)} className={`p-2 rounded-xl outline-none w-[90%] text-xs font-black uppercase border ${u.status === 'Bloqueado' ? 'bg-rose-50 text-rose-600' : 'bg-emerald-50 text-emerald-600'}`}><option value="Activo">Activo</option><option value="Bloqueado">Bloqueado</option></select>}
                                                  </td>
                                              </tr>
                                          );
                                      })}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  )}

                  {activeTab === 'subscription' && currentUserData && (() => {
                      const nextPay = currentUserData.email === ADMIN_EMAIL ? 'Membresía Vitalicia' : calculateNextPayment(currentUserData.firstLogin, currentUserData.subscriptionType);
                      const monto = currentUserData.email === ADMIN_EMAIL ? '0' : (currentUserData.monto || 'Pendiente');
                      const plan = currentUserData.email === ADMIN_EMAIL ? 'Admin / Vitalicio' : (currentUserData.subscriptionType || 'Mensual');

                      return (
                          <div className="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm animate-in max-w-3xl mx-auto mt-4 md:mt-10">
                              <div className="flex flex-col items-center text-center mb-8">
                                  <div className="w-20 h-20 bg-brand text-white rounded-3xl flex items-center justify-center shadow-xl rotate-3 mb-6"><Icons.Star className="w-10 h-10 fill-current" /></div>
                                  <h2 className="text-3xl font-black uppercase tracking-tighter text-slate-800">Mi Suscripción</h2>
                              </div>
                              <div className="bg-slate-900 rounded-[2rem] p-8 text-white shadow-2xl relative overflow-hidden mb-8">
                                  <div className="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-8">
                                      <div><p className="text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400 mb-1">Plan Actual</p><p className="text-2xl font-black uppercase">{plan}</p></div>
                                      <div><p className="text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400 mb-1">Estado</p><p className="text-2xl font-black uppercase text-emerald-400">{currentUserData.status || 'Activo'}</p></div>
                                      <div><p className="text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400 mb-1">Próximo Vencimiento</p><p className="text-lg font-bold text-amber-400">{nextPay}</p></div>
                                  </div>
                                  <div className="mt-8 pt-8 border-t border-white/10 relative z-10 flex flex-col md:flex-row items-center justify-between gap-6 mb-6">
                                      <div><p className="text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400 mb-1">Monto a Pagar</p><p className="text-4xl font-black">${monto}</p></div>
                                  </div>
                                  {currentUserData.email !== ADMIN_EMAIL && (
                                      <div className="relative z-10 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                          <a href={`https://wa.me/59892617525?text=${encodeURIComponent('Hola! Quiero renovar la suscripción mensual. Mi correo es: ' + currentUserData.email)}`} target="_blank" className="p-4 bg-[#25D366] hover:bg-[#20bd5a] text-white rounded-xl font-black uppercase text-[10px] tracking-widest text-center shadow-md">Renovar Mensual</a>
                                          <a href={`https://wa.me/59892617525?text=${encodeURIComponent('Hola! Quiero renovar la suscripción anual. Mi correo es: ' + currentUserData.email)}`} target="_blank" className="p-4 bg-[#25D366] hover:bg-[#20bd5a] text-white rounded-xl font-black uppercase text-[10px] tracking-widest text-center shadow-md">Renovar Anual</a>
                                          <a href={`https://wa.me/59892617525?text=${encodeURIComponent('Hola! Quiero darle de baja a la suscripción mensual. Mi correo es: ' + currentUserData.email)}`} target="_blank" className="p-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl border border-slate-700 font-black uppercase text-[10px] tracking-widest text-center">Baja Mensual</a>
                                          <a href={`https://wa.me/59892617525?text=${encodeURIComponent('Hola! Quiero dar de baja a la suscripción anual. Mi correo es: ' + currentUserData.email)}`} target="_blank" className="p-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl border border-slate-700 font-black uppercase text-[10px] tracking-widest text-center">Baja Anual</a>
                                      </div>
                                  )}
                              </div>
                          </div>
                      );
                  })()}

                  {activeTab === 'profile' && (
                      <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl max-w-2xl mx-auto animate-in">
                          <h3 className="text-2xl font-black uppercase tracking-tighter mb-8">Mis Datos</h3>
                          <div className="space-y-4">
                              <div><label className="text-[10px] font-black uppercase text-slate-400 ml-1">Email (Cuenta vinculada)</label><div className="p-3 bg-slate-100 rounded-xl text-xs font-bold text-slate-500 border mt-1">{userEmail}</div></div>
                              <div><label className="text-[10px] font-black uppercase text-slate-400 ml-1">Nombre de Marca</label><input value={userProfile.brand} onChange={(e) => setUserProfile({...userProfile, brand: e.target.value})} placeholder="Tu Marca" className="w-full p-3 rounded-xl bg-slate-50 text-xs font-bold mt-1 outline-none border" /></div>
                              <button onClick={() => notify("Datos guardados")} className="w-full py-3 bg-brand text-white rounded-xl font-black uppercase text-xs tracking-widest shadow-lg mt-4">Guardar Cambios</button>
                          </div>
                      </div>
                  )}

                </main>

                {showReminder && (
                    <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[300] flex items-center justify-center p-6 animate-in zoom-in duration-300 text-slate-800 text-center no-print">
                        <div className="bg-white max-w-sm w-full rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
                            <h3 className="text-2xl font-black uppercase mb-6 tracking-tighter leading-tight">Avisos de Hoy</h3>
                            <button onClick={() => setShowReminder(false)} className="w-full py-4 bg-slate-900 text-white rounded-3xl font-black uppercase text-[10px] tracking-widest shadow-xl hover:scale-105 transition-transform">¡Entendido!</button>
                        </div>
                    </div>
                )}

                {showContactModal && (
                  <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[200] flex items-center justify-center p-6 animate-in zoom-in duration-300 text-slate-800 text-center no-print">
                     <div className="bg-white max-w-sm w-full rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
                        <h3 className="text-2xl font-black uppercase tracking-tighter leading-tight mb-4">Soporte MC Pro</h3>
                        <div className="space-y-3">
                          <a href="https://wa.me/59892617525" target="_blank" className="flex items-center justify-center gap-3 w-full py-4 bg-[#25D366] text-white rounded-3xl font-black uppercase text-[10px] tracking-widest shadow-xl"><Icons.MessageCircle className="w-4 h-4" /> WhatsApp</a>
                          <button onClick={() => setShowContactModal(false)} className="block w-full py-3 text-slate-300 font-bold uppercase text-[9px] tracking-widest hover:text-brand">Cerrar</button>
                        </div>
                     </div>
                  </div>
                )}
              </div>
            );
        }

        // --- APP ENTRY POINT ---
        function App() {
            const [user, setUser] = useState(null);
            const [authLoaded, setAuthLoaded] = useState(false);
            const [emailInput, setEmailInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [notification, setNotification] = useState(null);
            const [showContactModal, setShowContactModal] = useState(false);
            
            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 2500); };

            useEffect(() => {
                if (window.firebaseModules) {
                    const unsubscribe = window.firebaseModules.onAuthStateChanged(window.firebaseModules.auth, (u) => {
                        setUser(u);
                        setAuthLoaded(true);
                    });
                    return () => unsubscribe();
                } else {
                    setAuthLoaded(true);
                }
            }, []);

            const isRealUser = user && !user.isAnonymous;

            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    await window.firebaseModules.signInWithEmailAndPassword(window.firebaseModules.auth, emailInput, passwordInput);
                    notify("Sesión iniciada.");
                } catch (err) {
                    let msg = err.message;
                    if(err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found') msg = "Usuario o contraseña incorrectos.";
                    if(err.code === 'auth/email-already-in-use') msg = "Este correo ya está registrado.";
                    if(err.code === 'auth/weak-password') msg = "La contraseña debe tener al menos 6 caracteres.";
                    setAuthError(msg);
                }
            };

            const handleLogout = () => {
                if (window.firebaseModules) {
                    window.firebaseModules.signOut(window.firebaseModules.auth)
                        .then(() => notify("Sesión cerrada"))
                        .catch(e => console.error(e));
                }
            };

            if (!authLoaded) return <div className="h-screen flex items-center justify-center dots-bg font-black uppercase tracking-widest text-slate-300">Cargando Sistema...</div>;

            if (!isRealUser) return (
                <div className="flex h-screen items-center justify-center dots-bg p-6">
                    <div className="w-full max-w-sm text-center animate-in bg-white p-8 rounded-3xl shadow-2xl border border-slate-100 relative">
                        <div className="inline-block p-4 rounded-3xl bg-brand text-white shadow-xl mb-6 rotate-3"><Icons.Star className="w-8 h-8 fill-current" /></div>
                        <h1 className="text-3xl font-black text-slate-800 uppercase tracking-tighter mb-2 leading-none text-center">MC Pro</h1>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-[0.3em] mb-10 leading-none text-center">Acceso a Miembros</p>
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded-2xl flex items-center border border-slate-100 relative">
                                <Icons.Mail className="w-5 h-5 text-slate-400 absolute left-4" />
                                <input type="email" required placeholder="Tu correo electrónico" className="bg-transparent outline-none w-full font-bold text-slate-700 text-center px-10" value={emailInput} onChange={e => setEmailInput(e.target.value)} />
                            </div>
                            <div className="bg-slate-50 p-3 rounded-2xl flex items-center border border-slate-100 relative">
                                <Icons.Key className="w-5 h-5 text-slate-400 absolute left-4" />
                                <input type="password" required placeholder="Tu contraseña" minLength="6" className="bg-transparent outline-none w-full font-bold text-slate-700 text-center px-10" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} />
                            </div>
                            
                            {authError && <p className="text-xs font-bold text-red-500 leading-tight bg-red-50 p-2 rounded-lg text-center">{authError}</p>}
                            
                            <button className="w-full py-4 bg-dark text-white rounded-2xl font-black uppercase tracking-widest hover:scale-[1.02] transition-all shadow-lg flex justify-center items-center text-center">
                                Ingresar al Sistema
                            </button>

                            <div className="text-center pt-4 mt-2">
                                <button type="button" onClick={() => setShowContactModal(true)} className="text-[11px] font-bold uppercase tracking-widest text-brand hover:text-rose-600 transition-colors text-center w-full">Solicitar mi acceso</button>
                            </div>
                        </form>
                    </div>

                    {showContactModal && (
                      <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[200] flex items-center justify-center p-6 animate-in zoom-in duration-300 text-slate-800 text-center no-print">
                         <div className="bg-white max-w-sm w-full rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-brand"></div>
                            <div className="w-20 h-20 bg-rose-50 text-brand rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-inner"><Icons.UserCheck className="w-10 h-10" /></div>
                            <h3 className="text-2xl font-black uppercase tracking-tighter leading-tight mb-4">Soporte MC Pro</h3>
                            <div className="space-y-3">
                              <a href="https://wa.me/59892617525" target="_blank" className="flex items-center justify-center gap-3 w-full py-4 bg-[#25D366] text-white rounded-3xl font-black uppercase text-[10px] tracking-widest shadow-xl"><Icons.MessageCircle className="w-4 h-4" /> WhatsApp</a>
                              <button onClick={() => setShowContactModal(false)} className="block w-full py-3 text-slate-300 font-bold uppercase text-[9px] tracking-widest hover:text-brand">Cerrar</button>
                            </div>
                         </div>
                      </div>
                    )}

                    {notification && <div className="fixed top-6 right-6 bg-dark text-white px-6 py-3 rounded-xl font-bold text-xs uppercase shadow-2xl z-[100] animate-in">{notification}</div>}
                </div>
            );

            return <Dashboard key={user.uid} user={user} onLogout={handleLogout} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>